<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>古代上位模拟器</title>
  <!-- Tailwind CSS v3 -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#a9b688', // 淡绿色主题
            secondary: '#9ED2BE', // 马卡龙绿
            tertiary: '#9EC3FF', // 马卡龙蓝
            quaternary: '#FFD591', // 马卡龙黄
            background: '#FFF5F7', // 浅粉色背景
            text: '#5A4B60', // 深紫色文字
          },
          fontFamily: {
            sans: ['Arial', 'sans-serif'],
          },
          animation: {
            'bounce-slow': 'bounce 3s infinite',
            'float': 'float 6s ease-in-out infinite',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            }
          }
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .text-shadow {
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
      }
      .card-shadow {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }
      .btn-shadow {
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .thin-scrollbar::-webkit-scrollbar {
        width: 4px;
      }
      .thin-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 2px;
      }
      .thin-scrollbar::-webkit-scrollbar-thumb {
        background: #ddd;
        border-radius: 2px;
      }
    }
    
    /* 自定义样式 */
    body {
      background-color: theme('colors.background');
      color: theme('colors.text');
      font-family: theme('fontFamily.sans');
      overflow-x: hidden;
    }
    
    .app-container {
      max-width: 420px;
      margin: 0 auto;
      min-height: 100vh;
      position: relative;
      background-color: #fff;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
    }
    
    .nav-item {
      transition: all 0.3s ease;
    }
    
    .nav-item.active {
      color: theme('colors.primary');
      border-top: 3px solid theme('colors.primary');
    }
    
    .btn {
      transition: all 0.3s ease;
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .card {
      transition: all 0.3s ease;
    }
    
    .stat-bar {
      height: 8px;
      border-radius: 4px;
      background-color: #f0f0f0;
      overflow: hidden;
    }
    
    .stat-value {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    .event-item {
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.5s forwards;
    }
    
    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .event-item:nth-child(1) { animation-delay: 0.1s; }
    .event-item:nth-child(2) { animation-delay: 0.2s; }
    .event-item:nth-child(3) { animation-delay: 0.3s; }
    .event-item:nth-child(4) { animation-delay: 0.4s; }
    .event-item:nth-child(5) { animation-delay: 0.5s; }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background-color: white;
      border-radius: 16px;
      width: 90%;
      max-width: 380px;
      max-height: 85vh;
      overflow-y: auto;
      animation: modalFadeIn 0.3s ease;
    }
    
    .modal-content::-webkit-scrollbar {
      display: none;
    }
    
    .modal-content {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    
    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .avatar-option {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 3px solid transparent;
    }
    
    .avatar-option.selected {
      border-color: theme('colors.primary');
      transform: scale(1.1);
    }
    
    .slider-container {
      position: relative;
      width: 100%;
      padding: 10px 0;
    }
    
    .slider {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #f0f0f0;
      outline: none;
    }
    
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: theme('colors.primary');
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: theme('colors.primary');
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      border: none;
    }
    
    .month-indicator {
      position: relative;
      display: inline-block;
      padding: 5px 15px;
      background-color: theme('colors.primary');
      color: white;
      border-radius: 50px;
      font-weight: bold;
      box-shadow: 0 3px 10px rgba(169, 182, 136, 0.3);
    }
    
    .page-content {
      display: block;
      opacity: 1;
      transition: opacity 0.2s ease;
    }
    
    .page-content.hidden {
      display: none;
      opacity: 0;
    }
    
    /* 页面切换动画 */
    .page-content.active {
      display: block;
      opacity: 1;
      transition: opacity 0.2s ease;
    }
    
    /* 导航项激活状态样式 */
    .nav-item.active {
      color: theme('colors.primary');
      position: relative;
    }
    
    .nav-item.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: calc(50% - 10px);
      width: 20px;
      height: 2px;
      background-color: theme('colors.primary');
      border-radius: 1px;
    }
    
    /* 页面容器样式优化 */
    .page-container {
      min-height: calc(100vh - 120px);
      padding: 16px;
    }
    
    /* 卡片网格布局优化 */
    .ladies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 16px;
    }
    
    /* 设置页面表单样式优化 */
    .settings-form {
      max-width: 500px;
      margin: 0 auto;
    }
    
    /* 关于页面样式优化 */
    .about-content {
      max-width: 600px;
      margin: 0 auto;
      text-align: center;
    }
    
    /* 下拉菜单样式 */
    .dropdown-menu {
      position: absolute;
      right: 0;
      top: 100%;
      margin-top: 0.5rem;
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      z-index: 50;
      min-width: 10rem;
      overflow: hidden;
      transform-origin: top right;
      transition: all 0.2s ease;
    }
    
    .dropdown-menu.hidden {
      opacity: 0;
      transform: scale(0.95) translateY(-10px);
      pointer-events: none;
    }
    
    .dropdown-menu.show {
      opacity: 1;
      transform: scale(1) translateY(0);
      pointer-events: auto;
    }
    
    .dropdown-item {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      color: #374151;
      transition: background-color 0.2s ease;
    }
    
    .dropdown-item:hover {
      background-color: #f3f4f6;
    }
    
    .dropdown-item svg {
      margin-right: 0.5rem;
    }
    
    /* 头像框样式 */
    .avatar-container {
      position: relative;
      display: inline-block;
    }
    
    .avatar-frame {
      position: absolute;
      top: -8%;
      left: -5%;
      width: 110%;
      height: 110%;
      background-image: url('https://z.wiki/u/Vtza0W');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }
    
    .avatar-frame.hidden {
      display: none;
    }
  /* 弹幕动画 */
        @keyframes danmu-move {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(-100%);
            }
        }
        
        /* 弹幕项样式 */
        .danmu-item {
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.8);
            z-index: 10;
        }
    </style>
</head>
<body>
  <div class="app-container">
    <!-- 顶部栏 -->
    <header class="bg-white p-4 shadow-sm sticky top-0 z-10">
      <div class="flex justify-between items-center">
        <h1 class="text-xl font-bold text-primary">古代上位模拟器</h1>
        <div class="flex items-center">
          <span id="current-month" class="text-sm bg-tertiary text-white px-3 py-1 rounded-full mr-2">
            元年 正月
          </span>
          <button id="next-month-btn" class="bg-primary text-white px-4 py-1 rounded-full text-sm font-medium btn-shadow">
            下一个月
          </button>
        </div>
      </div>
    </header>
    
    <!-- 主内容区 -->
    <main class="pb-20">
      <!-- 主页内容 -->
      <div id="home-content" class="page-content page-container">
        <!-- 记事栏 -->
        <section class="mb-6">
          <div class="flex justify-between items-center mb-3">
            <h2 class="text-lg font-semibold">宫廷记事</h2>
            <div class="flex items-center space-x-2">
              <button id="danmu-btn" class="w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center text-sm font-medium btn-shadow" title="生成弹幕">
                弹
              </button>
            </div>
          </div>
          
          <div id="events-container" class="bg-white rounded-xl p-4 card-shadow" style="background-image: url('https://img.heliar.top/file/1761888998651_3e4a108c2d7d042394810ea03bad0bfe.png'); background-size: cover; background-position: center; background-repeat: no-repeat;">
            <div class="text-center text-gray-400 py-8" id="no-events-message" style="background-color: rgba(255, 255, 255, 0.8); border-radius: 12px; margin: 8px;">
              <svg class="w-8 h-8 mb-2 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"></path>
              </svg>
              <p>暂无记事，点击"下一个月"开始剧情</p>
            </div>
            <!-- 记事将通过JS动态添加 -->
          </div>
        </section>
      </div>
      
      <!-- 人物页面内容 -->
      <div id="characters-content" class="page-content page-container hidden">
        <!-- 固定顶部栏 -->
        <div class="fixed top-0 left-0 right-0 bg-white z-20 shadow-sm" style="max-width: 420px; margin: 0 auto;">
          <div class="p-4">
            <div class="flex justify-between items-center">
              <h2 class="text-lg font-semibold">人物列表</h2>
              <div class="flex items-center space-x-2">
                <button id="toggle-avatar-frame-btn" class="bg-gray-500 text-white px-3 py-1 rounded-full text-sm font-medium btn-shadow flex items-center" title="隐藏/显示头像框">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
                  </svg>
                </button>
                <div class="relative">
                  <button id="add-dropdown-btn" class="bg-secondary text-white px-3 py-1 rounded-full text-sm font-medium btn-shadow flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                    </svg>
                    添加
                    <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                  </button>
                  <div id="add-dropdown-menu" class="dropdown-menu hidden">
                    <button id="add-lady-dropdown" class="dropdown-item">
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                      </svg>
                      添加人物
                    </button>
                    <button id="generate-mood-dropdown" class="dropdown-item">
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" clip-rule="evenodd"></path>
                      </svg>
                      生成心境
                    </button>
                    <button id="toggle-mood-display-dropdown" class="dropdown-item">
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                      </svg>
                      展示心境
                    </button>
                    <button id="ai-script-dropdown" class="dropdown-item">
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                        <path d="M9 12a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                      生成剧本
                    </button>
                    <button id="view-script-dropdown" class="dropdown-item">
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"></path>
                      </svg>
                      查看剧本
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 人物列表内容区域，添加顶部边距以避免被固定栏遮挡 -->
        <div class="pt-20">
          <div id="ladies-container-page" class="ladies-grid">
            <!-- 人物卡片将通过JS动态添加 -->
          </div>
          
          <div id="no-ladies-message-page" class="text-center text-gray-400 py-8">
            <svg class="w-8 h-8 mb-2 mx-auto" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
            </svg>
            <p>暂无人物，请添加人物开始游戏</p>
          </div>
        </div>
      </div>
      
      <!-- 设置页面内容 -->
      <div id="settings-content" class="page-content page-container hidden">
        <div class="settings-list">
          <div class="mb-4">
            <h2 class="text-lg font-semibold mb-4">设置</h2>
            
            <!-- API设置项 -->
            <div class="bg-white rounded-lg p-4 mb-3 border border-gray-200 hover:border-primary transition-colors cursor-pointer" id="api-settings-item">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <svg class="w-6 h-6 text-primary mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                  </svg>
                  <div>
                    <h3 class="font-medium">API设置</h3>
                    <p class="text-sm text-gray-500">配置API密钥和模型</p>
                  </div>
                </div>
                <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                </svg>
              </div>
            </div>
            
            <!-- 生成设置项 -->
            <div class="bg-white rounded-lg p-4 mb-3 border border-gray-200 hover:border-primary transition-colors cursor-pointer" id="generation-settings-item">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <svg class="w-6 h-6 text-primary mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path>
                  </svg>
                  <div>
                    <h3 class="font-medium">生成设置</h3>
                    <p class="text-sm text-gray-500">设置事件生成参数</p>
                  </div>
                </div>
                <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                </svg>
              </div>
            </div>
            
            <!-- 更新日志项 -->
            <div class="bg-white rounded-lg p-4 mb-3 border border-gray-200 hover:border-primary transition-colors cursor-pointer" id="changelog-item">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <svg class="w-6 h-6 text-primary mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                    <path d="M8 12a1 1 0 100-2 1 1 0 000 2z"></path>
                    <path d="M8 8a1 1 0 100-2 1 1 0 000 2z"></path>
                    <path d="M12 12a1 1 0 100-2 1 1 0 000 2z"></path>
                    <path d="M12 8a1 1 0 100-2 1 1 0 000 2z"></path>
                  </svg>
                  <div>
                    <h3 class="font-medium">更新日志</h3>
                    <p class="text-sm text-gray-500">查看游戏更新记录</p>
                  </div>
                </div>
                <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                </svg>
              </div>
            </div>
            
            <!-- 游戏管理 -->
            <div class="bg-white rounded-lg p-4 border border-gray-200">
              <div class="flex items-center">
                <svg class="w-6 h-6 text-red-500 mr-3" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                <div class="flex-1">
                  <h3 class="font-medium text-red-500">游戏管理</h3>
                  <p class="text-sm text-gray-500">重新开始游戏</p>
                </div>
                <button id="restart-game-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg font-medium">
                  重新开始
                </button>
              </div>
              <p class="text-xs text-gray-400 mt-2">此操作将删除所有游戏数据，不可恢复</p>
            </div>
            
            <!-- 数据管理 -->
            <div class="bg-white rounded-lg p-4 border-2 border-primary mt-3 card-shadow">
              <div class="flex items-center mb-3">
                <div class="w-10 h-10 bg-primary bg-opacity-20 rounded-full flex items-center justify-center mr-3">
                  <svg class="w-6 h-6 text-primary" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"></path>
                  </svg>
                </div>
                <div class="flex-1">
                  <h3 class="font-medium text-primary">数据管理</h3>
                  <p class="text-sm text-gray-500">导出/导入游戏数据</p>
                </div>
              </div>
              <div class="flex space-x-2">
                <button id="export-data-btn" class="flex-1 bg-primary text-white px-3 py-2 rounded-lg font-medium text-sm btn-shadow hover:bg-opacity-90 transition-all">
                  导出数据
                </button>
                <button id="import-data-btn" class="flex-1 bg-secondary text-white px-3 py-2 rounded-lg font-medium text-sm btn-shadow hover:bg-opacity-90 transition-all">
                  导入数据
                </button>
              </div>
              <input type="file" id="import-data-file" accept=".json" class="hidden">
              <p class="text-xs text-gray-400 mt-2">导出数据可备份游戏进度，导入数据可恢复游戏进度</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- API设置页面内容 -->
      <div id="api-settings-content" class="page-content page-container hidden">
        <div class="settings-form">
          <div class="flex items-center mb-4">
            <button id="back-to-settings" class="mr-3 text-gray-600">
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
            <h2 class="text-lg font-semibold">API设置</h2>
          </div>
          
          <form id="api-settings-form-page">
            <div class="mb-4">
              <label for="api-baseurl-page" class="block text-sm font-medium mb-1">Base URL</label>
              <input type="text" id="api-baseurl-page" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="请输入API Base URL" value="">
            </div>
            
            <div class="mb-4">
              <label for="api-key-page" class="block text-sm font-medium mb-1">API Key</label>
              <div class="relative">
                <input type="password" id="api-key-page" class="w-full px-3 py-2 pr-10 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="sk-...">
                <button type="button" id="clear-api-key-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                  </svg>
                </button>
              </div>
            </div>
            
            <div class="mb-4">
              <div class="flex justify-between">
                <label for="api-model-page" class="block text-sm font-medium mb-1">Model Name</label>
                <button type="button" id="fetch-models-btn-page" class="text-xs bg-tertiary text-white px-2 py-1 rounded-full">
                  拉取模型
                </button>
              </div>
              <select id="api-model-page" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
            <option value="">请选择模型</option>
          </select>
            </div>
            
            <div class="mt-6">
              <button type="submit" class="w-full bg-secondary text-white py-2 rounded-lg font-medium btn-shadow">
                保存设置
              </button>
            </div>
          </form>
          
          <div id="model-fetch-status-page" class="mt-3 text-xs text-center hidden"></div>
        </div>
      </div>
      
      <!-- 生成设置页面内容 -->
      <div id="generation-settings-content" class="page-content page-container hidden">
        <div class="settings-form">
          <div class="flex items-center mb-4">
            <button id="back-to-settings-from-gen" class="mr-3 text-gray-600">
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
            <h2 class="text-lg font-semibold">生成设置</h2>
          </div>
          
          <!-- 生成设置类型标题 -->
          <div class="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex justify-between items-center">
              <h3 class="text-base font-medium text-primary">记事生成设置</h3>
              <p class="text-xs text-gray-400">事件过多会导致生成缓慢</p>
            </div>
          </div>
          
          <div class="mb-4 flex space-x-3">
            <div class="flex-1">
              <label for="generation-min-events-per-lady" class="block text-sm font-medium mb-1">每人至少条数</label>
              <input type="number" id="generation-min-events-per-lady" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" min="1" max="10" value="1">
            </div>
            
            <div class="flex-1">
              <label class="block text-sm font-medium mb-1">总共条数范围</label>
              <div class="flex items-center space-x-2">
                <input type="number" id="generation-min-total-events" class="w-1/2 px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" min="1" max="20" value="3">
                <span class="text-gray-500">到</span>
                <input type="number" id="generation-max-total-events" class="w-1/2 px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" min="1" max="20" value="5">
              </div>
            </div>
          </div>
          
          <div class="mb-4">
            <div class="flex justify-between items-center mb-1">
              <label for="generation-prompt" class="block text-sm font-medium">提示词更改</label>
              <button id="restore-default-prompt-btn" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded transition-colors">
                恢复默认
              </button>
            </div>
            <textarea id="generation-prompt" rows="6" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="输入自定义生成记事的提示词..."></textarea>
            <p class="text-xs text-gray-400 mt-1 text-right">代码部分不要修改</p>
          </div>
          
          <!-- 更多生成设置 -->
          <div class="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex justify-between items-center">
              <h3 class="text-base font-medium text-primary">更多生成设置</h3>
              <p class="text-xs text-gray-400">自定义游戏背景</p>
            </div>
          </div>
          
          <div class="mb-4">
            <div class="flex justify-between items-center mb-1">
              <label for="mood-generation-prompt" class="block text-sm font-medium">心境提示词更改</label>
              <button id="restore-default-mood-prompt-btn" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded transition-colors">
                恢复默认
              </button>
            </div>
            <textarea id="mood-generation-prompt" rows="6" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="输入自定义生成心境的提示词..."></textarea>
            <p class="text-xs text-gray-400 mt-1 text-right">代码部分不要修改</p>
          </div>
          
          <div class="mb-4">
            <div class="flex justify-between items-center mb-1">
              <label for="product-generation-prompt" class="block text-sm font-medium">商品提示词更改</label>
              <button id="restore-default-product-prompt-btn" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded transition-colors">
                恢复默认
              </button>
            </div>
            <textarea id="product-generation-prompt" rows="6" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="输入自定义生成商品的提示词..."></textarea>
            <p class="text-xs text-gray-400 mt-1 text-right">代码部分不要修改</p>
          </div>
          
          <div class="mb-4">
            <div class="flex justify-between items-center mb-1">
              <label for="wishlist-generation-prompt" class="block text-sm font-medium">心愿单提示词更改</label>
              <button id="restore-default-wishlist-prompt-btn" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded transition-colors">
                恢复默认
              </button>
            </div>
            <textarea id="wishlist-generation-prompt" rows="6" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="输入自定义生成心愿单的提示词..."></textarea>
            <p class="text-xs text-gray-400 mt-1 text-right">代码部分不要修改</p>
          </div>
          
          <div class="mt-6">
            <button type="button" id="save-generation-settings-btn" class="w-full bg-secondary text-white py-2 rounded-lg font-medium btn-shadow">
              保存生成设置
            </button>
          </div>
        </div>
      </div>
      
      <!-- 更新日志页面内容 -->
      <div id="changelog-content" class="page-content page-container hidden">
        <div class="flex items-center mb-6">
          <button class="mr-3 p-2 rounded-full hover:bg-gray-100" id="back-to-settings-from-changelog">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
            </svg>
          </button>
          <h2 class="text-2xl font-bold">更新日志</h2>
        </div>
        
        <div class="space-y-4">
          <!-- 版本 1.3 -->
          <div class="border-2 border-primary rounded-xl p-4 shadow-sm">
            <div class="flex items-center mb-2">
              <span class="text-sm font-semibold text-primary bg-primary bg-opacity-10 px-3 py-1 rounded-full">v1.3</span>
              <span class="text-sm text-gray-500 ml-2">2025-11-3</span>
            </div>
            <ul class="text-sm text-gray-600 space-y-2 list-disc list-inside">
              <li>更新书信系统，人物多时每次勾选1-2个人物生成最好。每个月书信生成完毕后点击清除避免占用过多内存。</li>
              <li>更新流言系统，生成流言及人物反应</li>
              <li>更新剧本生成，根据你提供的类型与人数生成剧本。生成的每个人物都有完整的信息，可以一键添加到人物列表中。</li>
              <li>新增删除记事</li>
              <li>优化生成记事的记忆条数</li>
            </ul>
          </div>
          
          <!-- 版本 1.2 -->
          <div class="border-2 border-primary rounded-xl p-4 shadow-sm">
            <div class="flex items-center mb-2">
              <span class="text-sm font-semibold text-primary bg-primary bg-opacity-10 px-3 py-1 rounded-full">v1.2</span>
              <span class="text-sm text-gray-500 ml-2">2025-11-2</span>
            </div>
            <ul class="text-sm text-gray-600 space-y-2 list-disc list-inside">
              <li>更新弹幕系统！可根据人物属性与过往记事等生成当月记事的弹幕内容</li>
              <li>人物心愿单新增获取按钮，点击后会自动生成人物获取该物品的记事，影响后续发展</li>
              <li>游戏更名为《古代上位模拟器》系统提示词更改为纯古代背景，适用宫斗、宅斗等</li>
              <li>人物购买增加属性的物品后属性会真实增加了</li>
              <li>增加更新日志</li>
              <li>增加自定义事件，可以主导角色后续发展</li>
              <li>增加人物头像框，可以点击关闭</li>
            </ul>
          </div>
        </div>
      </div>
      
      <!-- 探索页面内容 -->
      <div id="about-content" class="page-content page-container hidden">
        <div class="settings-list">
          <div class="mb-4">
            <h2 class="text-lg font-semibold mb-4">探索</h2>
            
            <!-- 宫市选项 -->
            <div class="bg-white rounded-lg p-4 mb-3 border border-gray-200 hover:border-primary transition-colors cursor-pointer" id="palace-market-item">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <svg class="w-6 h-6 text-primary mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd"></path>
                  </svg>
                  <div>
                    <h3 class="font-medium">宫市</h3>
                    <p class="text-sm text-gray-500">浏览和购买宫中商品</p>
                  </div>
                </div>
                <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                </svg>
              </div>
            </div>
            
            <!-- 流言选项 -->
            <div class="bg-white rounded-lg p-4 mb-3 border border-gray-200 hover:border-primary transition-colors cursor-pointer" id="rumors-item">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <svg class="w-6 h-6 text-primary mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>
                  </svg>
                  <div>
                    <h3 class="font-medium">秘闻</h3>
                    <p class="text-sm text-gray-500">听取秘闻轶事</p>
                  </div>
                </div>
                <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 宫市商品页面内容 -->
      <div id="palace-market-content" class="page-content page-container hidden">
        <!-- 固定标题 -->
        <div class="sticky top-0 bg-white z-10 border-b border-gray-200 p-4">
          <div class="flex justify-between items-center">
            <div class="flex items-center">
              <button id="back-to-explore" class="mr-3 text-gray-600">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                </svg>
              </button>
              <h2 class="text-lg font-semibold">宫市商品</h2>
            </div>
            <div class="flex space-x-2">
              <button id="view-bills-btn" class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-medium btn-shadow flex items-center">
                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                </svg>
                账单
              </button>
              <button id="edit-products-btn" class="bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-medium btn-shadow flex items-center">
                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                </svg>
                编辑
              </button>
              <div class="relative">
                <button id="generate-dropdown-btn" class="bg-secondary text-white px-3 py-1 rounded-full text-sm font-medium btn-shadow flex items-center">
                  <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                  </svg>
                  生成
                  <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                  </svg>
                </button>
                <div id="generate-dropdown-menu" class="dropdown-menu hidden">
                  <div id="generate-products-dropdown" class="dropdown-item flex items-center px-4 py-2 hover:bg-gray-100 cursor-pointer">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                    </svg>
                    生成商品
                  </div>
                  <div id="generate-wishlist-dropdown" class="dropdown-item flex items-center px-4 py-2 hover:bg-gray-100 cursor-pointer">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path>
                    </svg>
                    生成心愿单
                  </div>
                  <div id="view-wishlist-dropdown" class="dropdown-item flex items-center px-4 py-2 hover:bg-gray-100 cursor-pointer">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                      <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
                    </svg>
                    查看心愿单
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 可滚动内容区域 -->
        <div class="p-4 pt-0">
          <!-- 商品列表 -->
          <div class="space-y-3" id="products-container">
            <!-- 商品将通过JavaScript动态生成 -->
          </div>
        </div>
      </div>
      
      <!-- 流言页面内容 -->
      <div id="rumors-content" class="page-content page-container hidden">
        <!-- 固定标题 -->
        <div class="sticky top-0 bg-white z-10 border-b border-gray-200 p-4">
          <div class="flex justify-between items-center">
            <div class="flex items-center">
              <button id="back-to-explore-from-rumors" class="mr-3 text-gray-600">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                </svg>
              </button>
              <h2 class="text-lg font-semibold">秘闻</h2>
            </div>
            <div class="flex space-x-2">
              <button id="clear-letters-btn" class="bg-red-500 text-white px-3 py-1 rounded-full text-sm font-medium btn-shadow flex items-center">
                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                清除
              </button>
              <div class="relative">
                <button id="view-rumor-dropdown-btn" class="bg-tertiary text-white px-3 py-1 rounded-full text-sm font-medium btn-shadow flex items-center">
                  <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                  </svg>
                  查看
                  <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                  </svg>
                </button>
                <div id="view-rumor-dropdown-menu" class="dropdown-menu hidden">
                  <button id="view-rumors-dropdown" class="dropdown-item">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                      <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                    </svg>
                    查看流言
                  </button>
                  <button id="view-letters-dropdown" class="dropdown-item">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                      <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
                    </svg>
                    查看书信
                  </button>
                </div>
              </div>
              <div class="relative">
                <button id="generate-rumor-dropdown-btn" class="bg-secondary text-white px-3 py-1 rounded-full text-sm font-medium btn-shadow flex items-center">
                  <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                  </svg>
                  生成
                  <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                  </svg>
                </button>
                <div id="generate-rumor-dropdown-menu" class="dropdown-menu hidden">
                  <button id="generate-rumor-dropdown" class="dropdown-item">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                    </svg>
                    生成流言
                  </button>
                  <button id="generate-letter-dropdown" class="dropdown-item">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                      <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
                    </svg>
                    生成书信
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 可滚动内容区域 -->
        <div class="p-4 pt-0">
          <!-- 流言列表 -->
          <div id="rumors-container" class="text-center py-8">
            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>
            </svg>
            <p class="text-gray-500">暂无秘闻</p>
          </div>
        </div>
      </div>
      
      <!-- 账单页面内容 -->
      <div id="bills-content" class="page-content page-container hidden">
        <!-- 固定标题 -->
        <div class="sticky top-0 bg-white z-10 border-b border-gray-200 p-4">
          <div class="flex justify-between items-center">
            <h2 class="text-lg font-semibold mr-8">账单</h2>
            <div class="flex space-x-2">
              <button id="generate-bill-btn" class="bg-secondary text-white px-3 py-1 rounded-full text-sm font-medium btn-shadow flex items-center">
                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0h8v12H6V4zm2 2h4v2H8V6zm0 3h4v2H8V9zm0 3h4v2H8v-2z" clip-rule="evenodd"></path>
                </svg>
                生成账单
              </button>
              <button id="back-to-products-btn" class="bg-gray-500 text-white px-3 py-1 rounded-full text-sm font-medium btn-shadow flex items-center">
                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                </svg>
                返回
              </button>
            </div>
          </div>
        </div>
        
        <!-- 可滚动内容区域 -->
        <div class="p-4 pt-0">
          <!-- 账单列表 -->
          <div id="bills-container" class="text-center py-8">
            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
            </svg>
            <p class="text-gray-500">暂无账单</p>
          </div>
        </div>
      </div>
    </main>
    
    <!-- 底部导航栏 -->
    <nav class="fixed bottom-0 left-0 right-0 mx-auto bg-white border-t border-gray-100 z-10" style="max-width: 420px;">
      <div class="flex justify-around">
        <button class="nav-item active flex flex-col items-center py-3 px-4 w-1/4" data-target="home">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"></path>
          </svg>
          <span class="text-xs mt-1">记事</span>
        </button>
        <button class="nav-item flex flex-col items-center py-3 px-4 w-1/4" data-target="characters">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
          </svg>
          <span class="text-xs mt-1">人物</span>
        </button>
        <button class="nav-item flex flex-col items-center py-3 px-4 w-1/4" data-target="settings">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path>
          </svg>
          <span class="text-xs mt-1">设置</span>
        </button>
        <button class="nav-item flex flex-col items-center py-3 px-4 w-1/4" data-target="about">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"></path>
          </svg>
          <span class="text-xs mt-1">探索</span>
        </button>
      </div>
    </nav>
  </div>
  
  <!-- 添加人物模态框 -->
  <div id="add-lady-modal" class="modal">
    <div class="modal-content p-5">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-primary">添加人物</h3>
        <button class="close-modal text-gray-400">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
      
      <form id="add-lady-form">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">头像选择</label>
          <div class="flex justify-around mb-2">
            <img src="https://img.heliar.top/file/1761995575440_729650eab320a41c2f4ca7268a02a5ae.png" 
                 class="avatar-option selected" data-avatar="avatar1">
            <img src="https://img.heliar.top/file/1761995568289_f00c331ad8e056ded8cbab4a1a594e49.png" 
                 class="avatar-option" data-avatar="avatar2">
            <img src="https://img.heliar.top/file/1761995566286_8.png" 
                 class="avatar-option" data-avatar="avatar3">
          </div>
          <div class="flex justify-center mt-2">
            <label for="custom-avatar-upload" class="bg-tertiary text-white px-3 py-1 rounded-full text-sm font-medium btn-shadow cursor-pointer flex items-center">
              <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
              </svg>
              自定义头像
            </label>
            <input type="file" id="custom-avatar-upload" class="hidden" accept="image/*">
          </div>
          <div id="custom-avatar-preview" class="mt-2 hidden">
            <img src="" alt="自定义头像预览" class="w-20 h-20 rounded-full mx-auto">
            <button type="button" id="remove-custom-avatar" class="text-xs text-red-500 mt-1">移除自定义头像</button>
          </div>
          <input type="hidden" id="selected-avatar" value="avatar1">
          <input type="hidden" id="custom-avatar-data" value="">
        </div>
        
        <div class="mb-4">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label for="lady-name" class="block text-sm font-medium mb-1">姓名</label>
              <input type="text" id="lady-name" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="请输入姓名" required>
            </div>
            <div>
              <label for="lady-title" class="block text-sm font-medium mb-1">身份</label>
              <input type="text" id="lady-title" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="请输入身份" value="人物" required>
            </div>
          </div>
        </div>
        
        <div class="mb-4">
          <label for="lady-description" class="block text-sm font-medium mb-1">人物介绍</label>
          <textarea id="lady-description" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="请输入人物介绍" rows="3"></textarea>
        </div>
        
        <div class="mb-4">
          <div class="grid grid-cols-3 gap-3">
            <div>
              <label for="lady-looks" class="block text-sm font-medium mb-1">容貌</label>
              <input type="number" id="lady-looks" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="1-100" min="1" max="100" value="50" required>
            </div>
            <div>
              <label for="lady-ability" class="block text-sm font-medium mb-1">能力</label>
              <input type="number" id="lady-ability" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="1-100" min="1" max="100" value="50" required>
            </div>
            <div>
              <label for="lady-skills" class="block text-sm font-medium mb-1">房中术</label>
              <input type="number" id="lady-skills" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="1-100" min="1" max="100" value="50" required>
            </div>
          </div>
        </div>
        
        <div class="mb-4">
          <div class="grid grid-cols-1 gap-3">
            <div>
              <label for="lady-life" class="block text-sm font-medium mb-1">生命</label>
              <input type="number" id="lady-life" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="1-100" min="1" max="100" value="100" required>
            </div>
          </div>
        </div>
        
        <div class="mt-6">
          <button type="submit" class="w-full bg-primary text-white py-2 rounded-lg font-medium btn-shadow">
            添加人物
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- 设置模态框 -->
  <div id="settings-modal" class="modal">
    <div class="modal-content p-5">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-primary">API设置</h3>
        <button class="close-modal text-gray-400">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
      
      <form id="api-settings-form">
        <div class="mb-4">
          <label for="api-baseurl" class="block text-sm font-medium mb-1">Base URL</label>
          <input type="text" id="api-baseurl" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="请输入API Base URL" value="">
        </div>
        
        <div class="mb-4">
          <label for="api-key" class="block text-sm font-medium mb-1">API Key</label>
          <div class="relative">
            <input type="password" id="api-key" class="w-full px-3 py-2 pr-10 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="sk-...">
            <button type="button" id="clear-api-key-modal-btn" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
        </div>
        
        <div class="mb-4">
          <div class="flex justify-between">
            <label for="api-model" class="block text-sm font-medium mb-1">Model Name</label>
            <button type="button" id="fetch-models-btn" class="text-xs bg-tertiary text-white px-2 py-1 rounded-full">
              拉取模型
            </button>
          </div>
          <select id="api-model" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
            <option value="">请选择模型</option>
          </select>
        </div>
        
        <div class="mt-6">
          <button type="submit" class="w-full bg-secondary text-white py-2 rounded-lg font-medium btn-shadow">
            保存设置
          </button>
        </div>
      </form>
      
      <div id="model-fetch-status" class="mt-3 text-xs text-center hidden"></div>
    </div>
  </div>
  

  
  <!-- 人物页面模态框 -->
  <div id="characters-modal" class="modal">
    <div class="modal-content p-5">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-primary">人物列表</h3>
        <button class="close-modal text-gray-400">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
      
      <div class="mb-4">
        <div class="flex space-x-2">
          <button id="generate-mood-btn-modal" class="bg-tertiary text-white px-3 py-1 rounded-full text-sm font-medium btn-shadow flex items-center">
            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" clip-rule="evenodd"></path>
            </svg>
            生成心境
          </button>
          <button id="add-lady-btn-modal" class="bg-secondary text-white px-3 py-1 rounded-full text-sm font-medium btn-shadow flex items-center">
            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
            </svg>
            添加人物
          </button>
        </div>
      </div>
      
      <div id="ladies-container-modal" class="grid grid-cols-2 gap-3">
        <!-- 人物卡片将通过JS动态添加 -->
        <div class="text-center text-gray-400 py-8 col-span-2" id="no-ladies-message-modal">
          <svg class="w-8 h-8 mb-2 mx-auto" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
          </svg>
          <p>暂无人物，请添加人物开始游戏</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- AI剧本模态框 -->
  <div id="ai-script-modal" class="modal">
    <div class="modal-content p-5 max-w-lg">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-primary">生成剧本</h3>
        <button class="close-modal text-gray-400">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
      
      <form id="ai-script-form">
        <div class="mb-4">
          <label for="script-type" class="block text-sm font-medium mb-1">剧本类型</label>
          <textarea id="script-type" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent min-h-16 resize-none" rows="2" placeholder="请输入剧本类型，如：宫斗、宅斗、权谋等" required></textarea>
        </div>
        
        <div class="mb-4">
          <label for="character-count" class="block text-sm font-medium mb-1">人物个数</label>
          <input type="number" id="character-count" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="请输入人物个数" min="1" max="10" required>
        </div>
        
        <div class="mt-6">
          <button type="submit" class="w-full bg-primary text-white py-2 rounded-lg font-medium btn-shadow">
            生成
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- 查看剧本模态框 -->
  <div id="view-script-modal" class="modal">
    <div class="modal-content p-5 max-w-2xl max-h-96 overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-primary">查看剧本</h3>
        <button class="close-modal text-gray-400">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
      
      <div id="script-content" class="p-4 bg-gray-50 rounded-lg min-h-64">
        <p class="text-gray-500 text-center">剧本内容将在这里显示</p>
      </div>
      
      <div class="mt-4 flex justify-end">
        <button class="close-modal bg-gray-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-gray-600 transition-colors">
          关闭
        </button>
      </div>
    </div>
  </div>
  
  <!-- 关于模态框 -->
  <div id="about-modal" class="modal">
    <div class="modal-content p-5">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-primary">关于游戏</h3>
        <button class="close-modal text-gray-400">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
      
      <div class="text-center">
        <img src="https://img.heliar.top/file/1761995575440_729650eab320a41c2f4ca7268a02a5ae.png" 
             alt="人物头像" class="w-24 h-24 rounded-full mx-auto mb-3">
        <h4 class="text-xl font-bold text-primary mb-2">古代上位模拟器</h4>
        <p class="text-sm text-gray-500 mb-4">版本 1.0.0</p>
        
        <p class="text-sm mb-3">一款基于AI的宫廷养成类游戏，让您体验人物们的宫廷生活与成长历程。</p>
        
        <div class="mt-6 text-xs text-gray-400">
          <p>© 2025 古代上位模拟器 版权所有</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 重新开始游戏确认弹框 -->
  <div id="restart-game-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl p-6 max-w-md w-full">
      <h3 class="text-xl font-bold mb-4 text-gray-800">确认重新开始游戏</h3>
      <p class="text-gray-600 mb-6">您确定要重新开始游戏吗？此操作将删除所有游戏数据，包括所有人物、事件和进度，且不可恢复！</p>
      <div class="flex justify-end space-x-3">
        <button id="cancel-restart" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">
          取消
        </button>
        <button id="confirm-restart" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
          确认重新开始
        </button>
      </div>
    </div>
  </div>
  
  <!-- 编辑商品模态框 -->
  <div id="edit-products-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-content p-5">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-800">编辑商品</h3>
        <button id="close-edit-products" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
      
      <div class="mb-4 overflow-y-auto" style="max-height: 60vh;">
        <div id="edit-products-list" class="space-y-4">
          <!-- 商品列表将通过JavaScript动态生成 -->
        </div>
      </div>
      
      <div class="mt-6">
        <div class="flex justify-between mb-3">
          <button id="add-new-product" class="bg-green-500 text-white px-3 py-2 rounded-lg font-medium btn-shadow flex items-center">
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
            </svg>
            添加新商品
          </button>
        </div>
        <div class="flex space-x-3">
          <button id="cancel-edit-products" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg font-medium">
            取消
          </button>
          <button id="save-edit-products" class="flex-1 bg-primary text-white py-2 rounded-lg font-medium btn-shadow">
            保存更改
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 确认弹框 -->
  <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-content p-5">
      <div class="text-center mb-4">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-3">
          <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>
        <h3 class="text-lg font-bold text-gray-900 mb-2">确认删除</h3>
        <p id="confirm-message" class="text-sm text-gray-500">确定要删除这个商品吗？</p>
      </div>
      <div class="flex space-x-3">
        <button id="confirm-cancel" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg font-medium">
          取消
        </button>
        <button id="confirm-ok" class="flex-1 bg-red-500 text-white py-2 rounded-lg font-medium">
          删除
        </button>
      </div>
    </div>
  </div>
  
  <!-- 生成账单模态框 -->
  <div id="generate-bill-modal" class="modal">
    <div class="modal-content p-5 border-2 border-primary max-w-2xl max-h-80 overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-primary">选择要生成账单的人物</h3>
        <button class="close-modal text-gray-400">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
      
      <div class="mb-4">
        <div class="flex items-center mb-3">
          <input type="checkbox" id="select-all-ladies-bill" class="mr-2">
          <label for="select-all-ladies-bill" class="text-sm font-medium">全选</label>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="bill-ladies-selection">
          <!-- 人物列表将通过JavaScript动态生成 -->
        </div>
      </div>
      
      <div class="flex justify-end space-x-3">
        <button id="cancel-bill-selection" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg">
          取消
        </button>
        <button id="confirm-bill-selection" class="px-4 py-2 bg-primary text-white rounded-lg">
          生成账单
        </button>
      </div>
    </div>
  </div>
  
  <script>
    // 全局数据
    const gameData = {
      ladies: [],
      events: [],
      rumors: [], // 流言列表
      letters: [], // 书信列表
      currentYear: 1,
      currentMonth: 1,
      money: 100, // 初始银钱
      displayYear: null, // 当前显示的年份，null表示显示当前月份
      displayMonth: null, // 当前显示的月份，null表示显示当前月份
      apiSettings: {
        baseUrl: '',
        apiKey: '',
        modelName: ''
      },
      apiModels: [], // 保存模型列表
      // 事件条数设置
      eventSettings: {
        minEventsPerLady: 1, // 每人至少条数
        minTotalEvents: 3,   // 总共条数范围最小值
        maxTotalEvents: 5    // 总共条数范围最大值
      },
      avatarOptions: [
        { id: 'avatar1', url: 'https://img.heliar.top/file/1761995575440_729650eab320a41c2f4ca7268a02a5ae.png' },
        { id: 'avatar2', url: 'https://img.heliar.top/file/1761995568289_f00c331ad8e056ded8cbab4a1a594e49.png' },
        { id: 'avatar3', url: 'https://img.heliar.top/file/1761995566286_8.png' }
      ],
      currentScript: null // 当前剧本数据
    };
    
    // 心境展示状态
    let isMoodDisplayVisible = false;
    
    // DOM元素
    const elements = {
      currentMonth: document.getElementById('current-month'),
      nextMonthBtn: document.getElementById('next-month-btn'),
      eventsContainer: document.getElementById('events-container'),
      noEventsMessage: document.getElementById('no-events-message'),
      navItems: document.querySelectorAll('.nav-item'),
      
      // 添加人物模态框
      addLadyModal: document.getElementById('add-lady-modal'),
      addLadyForm: document.getElementById('add-lady-form'),
      avatarOptions: document.querySelectorAll('.avatar-option'),
      selectedAvatar: document.getElementById('selected-avatar'),
      ladyName: document.getElementById('lady-name'),
      ladyTitle: document.getElementById('lady-title'),
      ladyDescription: document.getElementById('lady-description'),
      ladyLooks: document.getElementById('lady-looks'),
      ladyAbility: document.getElementById('lady-ability'),
      ladySkills: document.getElementById('lady-skills'),
      ladyLife: document.getElementById('lady-life'),
      
      // 设置模态框
      settingsModal: document.getElementById('settings-modal'),
      apiSettingsForm: document.getElementById('api-settings-form'),
      apiBaseurl: document.getElementById('api-baseurl'),
      apiKey: document.getElementById('api-key'),
      clearApiKeyModalBtn: document.getElementById('clear-api-key-modal-btn'),
      apiModel: document.getElementById('api-model'),
      fetchModelsBtn: document.getElementById('fetch-models-btn'),
      modelFetchStatus: document.getElementById('model-fetch-status'),
      
      // 关于模态框
      aboutModal: document.getElementById('about-modal'),
      
      // 人物页面模态框
      charactersModal: document.getElementById('characters-modal'),
      ladiesContainerModal: document.getElementById('ladies-container-modal'),
      noLadiesMessageModal: document.getElementById('no-ladies-message-modal'),
      addLadyBtnModal: document.getElementById('add-lady-btn-modal'),
      
      // AI剧本模态框
      aiScriptModal: document.getElementById('ai-script-modal'),
    viewScriptModal: document.getElementById('view-script-modal'),
      aiScriptForm: document.getElementById('ai-script-form'),
      scriptType: document.getElementById('script-type'),
      characterCount: document.getElementById('character-count'),
      
      // 页面内容
      homeContent: document.getElementById('home-content'),
      charactersContent: document.getElementById('characters-content'),
      settingsContent: document.getElementById('settings-content'),
      aboutContent: document.getElementById('about-content'),
      palaceMarketContent: document.getElementById('palace-market-content'),
        rumorsContent: document.getElementById('rumors-content'),
        // 探索界面选项
        palaceMarketItem: document.getElementById('palace-market-item'),
        rumorsItem: document.getElementById('rumors-item'),
        backToExplore: document.getElementById('back-to-explore'),
        backToExploreFromRumors: document.getElementById('back-to-explore-from-rumors'),
      
      // 人物页面元素
      ladiesContainerPage: document.getElementById('ladies-container-page'),
      noLadiesMessagePage: document.getElementById('no-ladies-message-page'),
      addLadyBtnPage: document.getElementById('add-lady-btn-page'),
      generateMoodBtnPage: document.getElementById('generate-mood-btn-page'),
      
      // 下拉菜单元素
      addDropdownBtn: document.getElementById('add-dropdown-btn'),
      addDropdownMenu: document.getElementById('add-dropdown-menu'),
      addLadyDropdown: document.getElementById('add-lady-dropdown'),
      generateMoodDropdown: document.getElementById('generate-mood-dropdown'),
      toggleMoodDisplayDropdown: document.getElementById('toggle-mood-display-dropdown'),
      aiScriptDropdown: document.getElementById('ai-script-dropdown'),
    viewScriptDropdown: document.getElementById('view-script-dropdown'),
      
      // 探索页面下拉菜单元素
      generateDropdownBtn: document.getElementById('generate-dropdown-btn'),
      generateDropdownMenu: document.getElementById('generate-dropdown-menu'),
      generateProductsDropdown: document.getElementById('generate-products-dropdown'),
      generateWishlistDropdown: document.getElementById('generate-wishlist-dropdown'),
      viewWishlistDropdown: document.getElementById('view-wishlist-dropdown'),
      
      // 设置页面元素
      apiSettingsFormPage: document.getElementById('api-settings-form-page'),
      apiBaseurlPage: document.getElementById('api-baseurl-page'),
      apiKeyPage: document.getElementById('api-key-page'),
      clearApiKeyBtn: document.getElementById('clear-api-key-btn'),
      apiModelPage: document.getElementById('api-model-page'),
      fetchModelsBtnPage: document.getElementById('fetch-models-btn-page'),
      modelFetchStatusPage: document.getElementById('model-fetch-status-page'),
      
      // 模态框中的生成心境按钮
      generateMoodBtnModal: document.getElementById('generate-mood-btn-modal'),
      
      // 事件条数设置元素
      minEventsPerLady: document.getElementById('min-events-per-lady'),
      minTotalEvents: document.getElementById('min-total-events'),
      maxTotalEvents: document.getElementById('max-total-events'),
      saveEventSettingsBtn: document.getElementById('save-event-settings-btn'),
      
      // 关闭模态框按钮
      closeModalButtons: document.querySelectorAll('.close-modal'),
      
      // 自定义头像上传
      customAvatarUpload: document.getElementById('custom-avatar-upload'),
      customAvatarPreview: document.getElementById('custom-avatar-preview'),
      customAvatarData: document.getElementById('custom-avatar-data'),
      removeCustomAvatar: document.getElementById('remove-custom-avatar'),
      
      // 重新开始游戏
      restartGameBtn: document.getElementById('restart-game-btn'),
      restartGameModal: document.getElementById('restart-game-modal'),
      cancelRestartBtn: document.getElementById('cancel-restart'),
      confirmRestartBtn: document.getElementById('confirm-restart'),
      
      // 确认弹框
      confirmModal: document.getElementById('confirm-modal'),
      confirmMessage: document.getElementById('confirm-message'),
      confirmCancelBtn: document.getElementById('confirm-cancel'),
      confirmOkBtn: document.getElementById('confirm-ok'),
      
      // 生成账单相关
      generateBillBtn: document.getElementById('generate-bill-btn'),
      generateBillModal: document.getElementById('generate-bill-modal'),
      billLadiesSelection: document.getElementById('bill-ladies-selection'),
      selectAllLadiesBill: document.getElementById('select-all-ladies-bill'),
      cancelBillSelection: document.getElementById('cancel-bill-selection'),
      confirmBillSelection: document.getElementById('confirm-bill-selection'),
      
      // 导出导入数据相关
      exportDataBtn: document.getElementById('export-data-btn'),
      importDataBtn: document.getElementById('import-data-btn'),
      importDataInput: document.getElementById('import-data-file'),
      
      // 秘闻页面相关
      viewRumorDropdownBtn: document.getElementById('view-rumor-dropdown-btn'),
      viewRumorDropdownMenu: document.getElementById('view-rumor-dropdown-menu'),
      viewRumorsDropdown: document.getElementById('view-rumors-dropdown'),
      viewLettersDropdown: document.getElementById('view-letters-dropdown'),
      generateRumorDropdownBtn: document.getElementById('generate-rumor-dropdown-btn'),
      generateRumorDropdownMenu: document.getElementById('generate-rumor-dropdown-menu'),
      generateRumorDropdown: document.getElementById('generate-rumor-dropdown'),
      generateLetterDropdown: document.getElementById('generate-letter-dropdown')
    };
    
    // 显示剧本内容的函数
    function displayScript() {
      const scriptContent = document.getElementById('script-content');
      if (gameData.currentScript) {
        let html = '';
        
        // 显示剧本标题和背景
        if (gameData.currentScript.script_setting) {
          html += `
            <div class="mb-4">
              <h4 class="text-lg font-bold text-primary mb-2">${gameData.currentScript.script_setting.title}</h4>
              <p class="text-sm text-gray-600 mb-2">类型：${gameData.currentScript.script_setting.type}</p>
              <p class="text-sm text-gray-700">${gameData.currentScript.script_setting.background}</p>
            </div>
          `;
        }
        
        // 显示人物信息
        if (gameData.currentScript.characters && gameData.currentScript.characters.length > 0) {
          html += '<div class="space-y-4">';
          gameData.currentScript.characters.forEach((character, index) => {
            html += `
              <div class="border rounded-lg p-3 bg-white">
                <div class="flex justify-between items-start">
                  <div class="flex-1">
                    <h5 class="font-bold text-md mb-2 flex items-center">
                      ${character.name} - ${character.identity}
                      <button class="add-character-btn ml-2 px-2 py-0.5 bg-primary text-white text-xs rounded hover:bg-opacity-90 transition-all" 
                              data-name="${character.name}" 
                              data-identity="${character.identity}" 
                              data-introduction="${character.introduction}"
                              data-looks="${character.attributes.容貌}"
                              data-ability="${character.attributes.能力}"
                              data-skills="${character.attributes.房中术}"
                              data-life="${character.attributes.生命值}">
                        添加
                      </button>
                    </h5>
                    <p class="text-sm text-gray-700 mb-2">${character.introduction}</p>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                      <div>容貌：${character.attributes.容貌}</div>
                      <div>能力：${character.attributes.能力}</div>
                      <div>房中术：${character.attributes.房中术}</div>
                      <div>生命值：${character.attributes.生命值}</div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          });
          html += '</div>';
        }
        
        scriptContent.innerHTML = html;
        
        // 添加"添加"按钮的事件监听器
        const addButtons = scriptContent.querySelectorAll('.add-character-btn');
        addButtons.forEach(button => {
          button.addEventListener('click', function() {
            const characterData = {
              name: this.getAttribute('data-name'),
              identity: this.getAttribute('data-identity'),
              introduction: this.getAttribute('data-introduction'),
              looks: parseInt(this.getAttribute('data-looks')),
              ability: parseInt(this.getAttribute('data-ability')),
              skills: parseInt(this.getAttribute('data-skills')),
              life: parseInt(this.getAttribute('data-life'))
            };
            
            addScriptCharacterToLadies(characterData);
          });
        });
      } else {
        scriptContent.innerHTML = '<p class="text-gray-500 text-center">暂无剧本内容，请先生成剧本</p>';
      }
    }
    
    // 初始化函数
    function init() {
      // 从本地存储加载数据
      loadData();
      
      // 更新UI
      updateMonthDisplay();
    
      renderLadiesInPage();
      renderEvents();
      renderBills();
      renderRumors(); // 初始化流言列表
      
      // 更新事件设置范围
      updateTotalEventsRange();
      
      // 设置事件监听器
      setupEventListeners();
    }
    
    // 处理AI剧本表单提交
    function handleAiScriptSubmit() {
      // 获取表单数据
      const scriptType = elements.scriptType.value;
      const characterCount = parseInt(elements.characterCount.value);
      
      // 验证表单数据
      if (!scriptType) {
        alert('请选择剧本类型');
        return;
      }
      
      if (!characterCount || characterCount < 1 || characterCount > 10) {
        alert('请输入有效的人物个数（1-10）');
        return;
      }
      
      // 检查API设置
      if (!gameData.apiSettings || !gameData.apiSettings.baseUrl || !gameData.apiSettings.apiKey || !gameData.apiSettings.modelName) {
        alert('请先在设置中配置API信息');
        return;
      }
      
      // 显示加载状态
      const submitButton = elements.aiScriptForm.querySelector('button[type="submit"]');
      const originalText = submitButton.textContent;
      submitButton.textContent = '生成中...';
      submitButton.disabled = true;
      
      // 调用AI生成剧本
      generateAIScript(scriptType, characterCount)
        .then(scriptData => {
          // 保存剧本数据
          gameData.currentScript = scriptData;
          saveScriptData();
          
          // 显示成功消息
          alert('剧本生成成功！');
          
          // 关闭模态框
          if (elements.aiScriptModal) {
            elements.aiScriptModal.classList.remove('active');
          }
          
          // 重置表单
          if (elements.aiScriptForm) {
            elements.aiScriptForm.reset();
          }
        })
        .catch(error => {
          console.error('生成剧本失败:', error);
          alert(`生成剧本失败: ${error.message}`);
        })
        .finally(() => {
          // 恢复按钮状态
          submitButton.textContent = originalText;
          submitButton.disabled = false;
        });
    }
    
    // 请求AI生成剧本
    function generateAIScript(scriptType, characterCount) {
      return new Promise(async (resolve, reject) => {
        try {
          // 系统提示词
          const systemPrompt = `你是一名专业的古代题材剧本大师，擅长创作结构紧凑、人物关系复杂的剧本大纲。现在你需要为一款名为"上位模拟器"的文字游戏生成剧本初始数据。

【核心任务】

根据玩家提供的"剧本类型"和"人物数量"，生成一个包含多个角色的剧本设定。所有人物必须处于同一个世界观下，彼此之间具有符合逻辑的关联性。

【输入参数】

玩家会提供两个关键信息：

剧本类型：例如 宫斗、宅斗、权谋、江湖等。

人物数量：一个整数，例如 3、4、5。

【生成要求与规则】

人物关联性：生成的人物必须是一个有机的整体。他们之间应有明确的身份关系（如君臣、妻妾、主仆、盟友、仇敌等），并包含至少一个核心矛盾或联盟关系。请在各个人物的"关联"属性中简要说明。

人物信息完整性：每个人物必须包含以下信息：

姓名：符合古代设定的中文姓名。

身份：在剧本世界观下的具体身份（如：皇后、嫡女、大将军、江湖侠客）。

人物介绍：一段50-100字的简要介绍，说明其性格、背景、当前处境或核心欲望。

属性值：所有属性均为0-100的整数。请根据人物设定合理分配数值，确保平衡性与戏剧性。

容貌：外貌的美丽或英俊程度。

能力：智慧、心计、手腕、才华等综合能力。

房中术：魅惑、床笫之间的技巧与魅力。

生命值：身体的健康与活力状态。

符合类型基调：生成的设定必须紧密贴合玩家选择的"剧本类型"。例如，"宫斗"题材应侧重于后宫等级、争宠阴谋；"宅斗"题材应侧重于家族内部、妻妾嫡庶之争。

【输出格式】

你必须严格且只使用以下JSON格式输出，确保可以被程序直接解析。不要有任何额外的开场白、解释或总结。

{

"script_setting": {

"title": "根据剧本类型生成一个简短且吸引人的剧本名称，如"深宫夜宴"",

"type": "用户输入的剧本类型",

"background": "生成一段100字左右的剧本背景介绍，为所有人物提供一个初始舞台。并简要说明此人物与其他至少一位角色的关系或关联，也可以无关联角色"

},

"characters": [

{

"name": "人物一姓名",

"identity": "人物一身份",

"introduction": "人物一介绍",

"attributes": {

"容貌": 数值,

"能力": 数值,

"房中术": 数值,

"生命": 数值

},

{

"name": "人物二姓名",

"identity": "人物二身份",

"introduction": "人物二介绍",

"attributes": {

"容貌": 数值,

"能力": 数值,

"房中术": 数值,

"生命值": 数值

},

// ... 根据用户指定的人物数量，生成相应数量的对象

]

}`;
          
          // 准备请求数据
          const requestData = {
            model: gameData.apiSettings.modelName,
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: `请生成一个${scriptType}类型的剧本，包含${characterCount}个人物` }
            ],
            temperature: 0.7
          };
          
          // 发送请求
          const response = await fetch(`${gameData.apiSettings.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${gameData.apiSettings.apiKey}`
            },
            body: JSON.stringify(requestData)
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `API请求失败: ${response.status}`);
          }
          
          const data = await response.json();
          
          // 解析响应
          const aiResponse = data.choices[0].message.content;
          const parsedResponse = safelyParseAiResponse(aiResponse);
          
          if (!parsedResponse || !parsedResponse.script_setting || !parsedResponse.characters) {
            throw new Error('AI返回格式不正确');
          }
          
          // 确保人物数量符合要求
          if (parsedResponse.characters.length !== characterCount) {
            console.warn(`AI生成的人物数量(${parsedResponse.characters.length})与要求(${characterCount})不符`);
          }
          
          resolve(parsedResponse);
        } catch (error) {
          reject(error);
        }
      });
    }
    
    // 保存剧本数据到本地存储
    function saveScriptData() {
      if (gameData.currentScript) {
        localStorage.setItem('palaceScript', JSON.stringify(gameData.currentScript));
      }
    }
    
    // 填充模型下拉选择框
    function populateModelSelects() {
      if (!gameData.apiModels || gameData.apiModels.length === 0) return;
      
      // 填充模态框中的下拉选择框
      elements.apiModel.innerHTML = '';
      gameData.apiModels.forEach(model => {
        const option = document.createElement('option');
        option.value = model;
        option.textContent = model;
        elements.apiModel.appendChild(option);
      });
      
      // 填充设置页面中的下拉选择框
      elements.apiModelPage.innerHTML = '';
      gameData.apiModels.forEach(model => {
        const option = document.createElement('option');
        option.value = model;
        option.textContent = model;
        elements.apiModelPage.appendChild(option);
      });
      
      // 设置当前选中的模型
      if (gameData.apiSettings && gameData.apiSettings.modelName) {
        elements.apiModel.value = gameData.apiSettings.modelName;
        elements.apiModelPage.value = gameData.apiSettings.modelName;
      } else {
        // 如果没有保存的模型，设置为空
        elements.apiModel.value = '';
        elements.apiModelPage.value = '';
      }
    }
    
    // 从本地存储加载剧本数据
    function loadScriptData() {
      const savedScript = localStorage.getItem('palaceScript');
      if (savedScript) {
        gameData.currentScript = JSON.parse(savedScript);
      }
    }
    
    // 从本地存储加载数据
    function loadData() {
      const savedLadies = localStorage.getItem('palaceLadies');
      const savedEvents = localStorage.getItem('palaceEvents');
      const savedDate = localStorage.getItem('palaceDate');
      const savedMoney = localStorage.getItem('palaceMoney');
      const savedApiSettings = localStorage.getItem('palaceApiSettings');
      const savedApiModels = localStorage.getItem('palaceApiModels');
      const savedEventSettings = localStorage.getItem('palaceEventSettings');
      const savedMoodSettings = localStorage.getItem('palaceMoodSettings');
      const savedProductSettings = localStorage.getItem('palaceProductSettings');
      const savedWishlistSettings = localStorage.getItem('palaceWishlistSettings');
      const savedProducts = localStorage.getItem('palaceProducts');
      const savedBills = localStorage.getItem('palaceBills');
      
      if (savedLadies) {
        gameData.ladies = JSON.parse(savedLadies);
      }
      
      if (savedEvents) {
        gameData.events = JSON.parse(savedEvents);
      }
      
      if (savedDate) {
        const { year, month } = JSON.parse(savedDate);
        gameData.currentYear = year;
        gameData.currentMonth = month;
      }
      
      if (savedMoney) {
        gameData.money = JSON.parse(savedMoney);
      }
      
      if (savedApiModels) {
        gameData.apiModels = JSON.parse(savedApiModels);
      }
      
      if (savedApiSettings) {
        gameData.apiSettings = JSON.parse(savedApiSettings);
        if (elements.apiBaseurl) {
          elements.apiBaseurl.value = gameData.apiSettings.baseUrl;
        }
        if (elements.apiKey) {
          elements.apiKey.value = gameData.apiSettings.apiKey;
        }
        if (elements.apiModel) {
          elements.apiModel.value = gameData.apiSettings.modelName;
        }
        
        // 同时更新设置页面的输入框
        if (elements.apiBaseurlPage) {
          elements.apiBaseurlPage.value = gameData.apiSettings.baseUrl;
        }
        if (elements.apiKeyPage) {
          elements.apiKeyPage.value = gameData.apiSettings.apiKey;
        }
        if (elements.apiModelPage) {
          elements.apiModelPage.value = gameData.apiSettings.modelName;
        }
      } else {
        // 如果没有保存的API设置，确保输入框为空
        if (elements.apiBaseurl) {
          elements.apiBaseurl.value = '';
        }
        if (elements.apiKey) {
          elements.apiKey.value = '';
        }
        if (elements.apiModel) {
          elements.apiModel.value = '';
        }
        
        // 同时更新设置页面的输入框
        if (elements.apiBaseurlPage) {
          elements.apiBaseurlPage.value = '';
        }
        if (elements.apiKeyPage) {
          elements.apiKeyPage.value = '';
        }
        if (elements.apiModelPage) {
          elements.apiModelPage.value = '';
        }
      }
      
      if (savedEventSettings) {
        gameData.eventSettings = JSON.parse(savedEventSettings);
        // 更新事件设置输入框
        if (elements.minEventsPerLady) {
          elements.minEventsPerLady.value = gameData.eventSettings.minEventsPerLady;
        }
        if (elements.minTotalEvents) {
          elements.minTotalEvents.value = gameData.eventSettings.minTotalEvents;
        }
        if (elements.maxTotalEvents) {
          elements.maxTotalEvents.value = gameData.eventSettings.maxTotalEvents;
        }
        
        // 更新生成设置页面的输入框
        const generationMinEventsPerLady = document.getElementById('generation-min-events-per-lady');
        const generationMinTotalEvents = document.getElementById('generation-min-total-events');
        const generationMaxTotalEvents = document.getElementById('generation-max-total-events');
        const generationPrompt = document.getElementById('generation-prompt');
        
        if (generationMinEventsPerLady) {
          generationMinEventsPerLady.value = gameData.eventSettings.minEventsPerLady;
        }
        if (generationMinTotalEvents) {
          generationMinTotalEvents.value = gameData.eventSettings.minTotalEvents;
        }
        if (generationMaxTotalEvents) {
          generationMaxTotalEvents.value = gameData.eventSettings.maxTotalEvents;
        }
        if (generationPrompt) {
          generationPrompt.value = gameData.eventSettings.customPrompt || `你是一位精通古代宫廷生活的资深编剧，请为宫廷养成游戏生成\${eventCount}条围绕人物上位竞争的精彩记事。每条30-60字，需兼具古风韵味和戏剧张力，重点刻画人物间的明争暗斗和晋升心机。 
 
 上位竞争要素参考： 
 机遇把握：才艺展露、救驾立功、献策得用、贵人提携 
  手段较量：截胡机会、散布流言、陷害构陷、借刀杀人  
  阵营博弈：投靠主子、结盟互助、背叛倒戈、借势上位 
 心理博弈：嫉妒攀比、焦虑冒进、隐忍蛰伏、得意忘形 
 
 人物塑造重点： 
 从当前人物中选择角色，结合其特质设计竞争策略： 
 容貌出众者善用美色，清秀者靠才德 
 能力高者主动创造机会，平庸者依附强者 
 心境焦虑者易出错，沉稳者等待时机 
 心境得意者易张扬，失意者易偏激 
 心境平和者多谋，怨怼者多事 
 
 当前时间：\${gameData.currentYear}年 \${gameData.currentMonth}月 
 
 当前人物列表： 
 \${gameData.ladies.map(lady => \`\${lady.name} - 容貌:\${lady.looks}, 能力:\${lady.ability}, 房中术:\${lady.skills}, 身份:\${lady.title || '人物'}, 状态:\${lady.status || '健康'}, 心境:\${lady.mindset || '平静'}, 心情:\${lady.mood || '平静'}
人物介绍:\${lady.description || '暂无介绍'}\`).join('\\n')} 
 
 历史事件： 
 \${gameData.events.slice(-5).map(event => \`\${event.date}: \${event.content}\`).join('\\n')} 
 
 请以JSON格式返回\${eventCount}条记事，每条记事包含： 
 - "content": 事件描述
 - "effects": 属性变化对象（可选） 
 
 示例： 
 { 
   "events": [ 
     { 
       "content": "小翠发现同屋人物私藏禁书，立即向掌事嬷嬷告发，借机除掉竞争对手", 
       "effects": {"target": "小翠", "mood": "得意"} 
     }, 
     { 
       "content": "春梅暗中苦练舞技，在中秋夜宴替补生病的舞姬一鸣惊人，获皇上注目",
       "effects": {"target": "春梅", "title": "舞女"} 
     }, 
     { 
       "content": "两位大人物为争夺侍奉皇后的机会，在御前各展才艺，暗流汹涌" 
     },
     { 
       "content": "婉儿因机智化解了皇后的尴尬，被破格提拔为贴身人物", 
       "effects": {"target": "婉儿", "title": "贴身人物", "mood": "欣喜"} 
     } 
   ] 
 } 
 
 重点要求：  
 1. 突出人物间的明争暗斗和晋升心机 
 2. 可设计截胡机会、陷害对手、创造机遇等戏剧性情节 
 3. 竞争手段要符合人物身份（暗斗而非明争）
 4. 保持古风韵味，避免现代词汇 
 5. effects字段可包含心情、健康状态和身份变化，身份变化格式为{"target": "人物名", "title": "新身份"}
 6. 生成的事件应与人物当前心境和心情相符，如焦虑心境的人物可能因紧张而出错，得意心境的人物可能因张扬而引来嫉妒
 7. 所有记事必须建立在所有已建立的角色上，不得出现无关人员！`;
        }
      } else {
        // 如果没有保存的事件设置，使用默认值
        gameData.eventSettings = {
          minEventsPerLady: 1,
          minTotalEvents: 3,
          maxTotalEvents: 5,
          customPrompt: null
        };
        // 更新事件设置输入框
        if (elements.minEventsPerLady) {
          elements.minEventsPerLady.value = gameData.eventSettings.minEventsPerLady;
        }
        if (elements.minTotalEvents) {
          elements.minTotalEvents.value = gameData.eventSettings.minTotalEvents;
        }
        if (elements.maxTotalEvents) {
          elements.maxTotalEvents.value = gameData.eventSettings.maxTotalEvents;
        }
        
        // 更新生成设置页面的输入框
        const generationMinEventsPerLady = document.getElementById('generation-min-events-per-lady');
        const generationMinTotalEvents = document.getElementById('generation-min-total-events');
        const generationMaxTotalEvents = document.getElementById('generation-max-total-events');
        const generationPrompt = document.getElementById('generation-prompt');
        
        if (generationMinEventsPerLady) {
          generationMinEventsPerLady.value = gameData.eventSettings.minEventsPerLady;
        }
        if (generationMinTotalEvents) {
          generationMinTotalEvents.value = gameData.eventSettings.minTotalEvents;
        }
        if (generationMaxTotalEvents) {
          generationMaxTotalEvents.value = gameData.eventSettings.maxTotalEvents;
        }
        if (generationPrompt) {
          generationPrompt.value = gameData.eventSettings.customPrompt || `你是一位精通古代宫廷生活的资深编剧，请为宫廷养成游戏生成\${eventCount}条围绕人物上位竞争的精彩记事。每条30-60字，需兼具古风韵味和戏剧张力，重点刻画人物间的明争暗斗和晋升心机。 
 
 上位竞争要素参考： 
 机遇把握：才艺展露、救驾立功、献策得用、贵人提携 
  手段较量：截胡机会、散布流言、陷害构陷、借刀杀人  
  阵营博弈：投靠主子、结盟互助、背叛倒戈、借势上位 
 心理博弈：嫉妒攀比、焦虑冒进、隐忍蛰伏、得意忘形 
 
 人物塑造重点： 
 从当前人物中选择角色，结合其特质设计竞争策略： 
 容貌出众者善用美色，清秀者靠才德 
 能力高者主动创造机会，平庸者依附强者 
 心境焦虑者易出错，沉稳者等待时机 
 心境得意者易张扬，失意者易偏激 
 心境平和者多谋，怨怼者多事 
 
 当前时间：\${gameData.currentYear}年 \${gameData.currentMonth}月 
 
 当前人物列表： 
 \${gameData.ladies.map(lady => \`\${lady.name} - 容貌:\${lady.looks}, 能力:\${lady.ability}, 房中术:\${lady.skills}, 身份:\${lady.title || '人物'}, 状态:\${lady.status || '健康'}, 心境:\${lady.mindset || '平静'}, 心情:\${lady.mood || '平静'}
人物介绍:\${lady.description || '暂无介绍'}\`).join('\\n')} 
 
 历史事件： 
 \${gameData.events.slice(-5).map(event => \`\${event.date}: \${event.content}\`).join('\\n')} 
 
 请以JSON格式返回\${eventCount}条记事，每条记事包含： 
 - "content": 事件描述
 - "effects": 属性变化对象（可选） 
 
 示例： 
 { 
   "events": [ 
     { 
       "content": "小翠发现同屋人物私藏禁书，立即向掌事嬷嬷告发，借机除掉竞争对手", 
       "effects": {"target": "小翠", "mood": "得意"} 
     }, 
     { 
       "content": "春梅暗中苦练舞技，在中秋夜宴替补生病的舞姬一鸣惊人，获皇上注目",
       "effects": {"target": "春梅", "title": "舞女"} 
     }, 
     { 
       "content": "两位大人物为争夺侍奉皇后的机会，在御前各展才艺，暗流汹涌" 
     },
     { 
       "content": "婉儿因机智化解了皇后的尴尬，被破格提拔为贴身人物", 
       "effects": {"target": "婉儿", "title": "贴身人物", "mood": "欣喜"} 
     } 
   ] 
 } 
 
 重点要求：  
 1. 突出人物间的明争暗斗和晋升心机 
 2. 可设计截胡机会、陷害对手、创造机遇等戏剧性情节 
 3. 竞争手段要符合人物身份（暗斗而非明争）
 4. 保持古风韵味，避免现代词汇 
 5. effects字段可包含心情、健康状态和身份变化，身份变化格式为{"target": "人物名", "title": "新身份"}
 6. 生成的事件应与人物当前心境和心情相符，如焦虑心境的人物可能因紧张而出错，得意心境的人物可能因张扬而引来嫉妒
 7. 所有记事必须建立在所有已建立的角色上，不得出现无关人员！`;
        }
      }
      
      // 加载心境设置
      if (savedMoodSettings) {
        gameData.moodSettings = JSON.parse(savedMoodSettings);
        
        // 更新生成设置页面的心境提示词输入框
        const moodGenerationPrompt = document.getElementById('mood-generation-prompt');
        if (moodGenerationPrompt) {
          moodGenerationPrompt.value = gameData.moodSettings.customPrompt || `你是一位深谙人心的宫廷心理师，请根据每位人物的属性、状态和近期经历，以该人物的第一人称视角生成其当前心境自述。

心境自述要求：

1. 以人物第一人称（"我"）的视角表达
2. 字数严格控制在30-100字之间
3. 融入人物个人特质、近期经历和内心感受
4. 体现深宫环境下的情绪状态与内心挣扎
5. 文笔要有古韵，但不要拗口，要有代入感，生动形象

当前时间：\${gameData.currentYear}年 \${gameData.currentMonth}月

当前人物列表：
\${selectedLadies.map(lady => {
  // 获取该人物近6个月的事件
  const ladyEvents = gameData.events.filter(event => 
    event.relatedLadies && event.relatedLadies.includes(lady.id)
  ).slice(-10); // 最多取最近10条相关事件
  
  const eventsText = ladyEvents.length > 0 
    ? ladyEvents.map(event => \`\${event.date}: \${event.content}\`).join('\\n')
    : '暂无相关事件';
    
  return \`\${lady.name} - 容貌:\${lady.looks}, 能力:\${lady.ability}, 房中术:\${lady.skills}, 身份:\${lady.title || '人物'}, 状态:\${lady.status || '健康'}, 心境:\${lady.mindset || '平静'}, 心情:\${lady.mood || '平静'}
人物介绍：\${lady.description || '暂无介绍'}
近期事件：
\${eventsText}\`;
}).join('\\n\\n')}

请以JSON格式返回心境自述：
{
  "moodAnalysis": [
    {
      "character": "王氏",
      "currentMood": "自那日梅林一舞得蒙天眷，本是春风得意，却见李贵妃眼底寒光乍现，如今夜夜对烛难眠，恐是花开易谢、恩宠难长。"
    },
    {
      "character": "李人物",
      "currentMood": "自胭脂事败，尝尽世态炎凉。偶见同乡飞上枝头，心下酸涩难言，如鲠在喉，夜半时常以泪洗面。"
    }
  ]
}

要求：每段心境自述都是一幅工笔写意，既要见古代人物的婉约情致，也要透出命运弄人的无奈与挣扎。字数严格控制在30-100字之间。`;
        }
      } else {
        // 如果没有保存的心境设置，使用默认值
        gameData.moodSettings = {
          customPrompt: null
        };
        
        // 更新生成设置页面的心境提示词输入框
        const moodGenerationPrompt = document.getElementById('mood-generation-prompt');
        if (moodGenerationPrompt) {
          moodGenerationPrompt.value = gameData.moodSettings.customPrompt || `你是一位深谙人心的宫廷心理师，请根据每位人物的属性、状态和近期经历，以该人物的第一人称视角生成其当前心境自述。

心境自述要求：

1. 以人物第一人称（"我"）的视角表达
2. 字数严格控制在30-100字之间
3. 融入人物个人特质、近期经历和内心感受
4. 体现深宫环境下的情绪状态与内心挣扎
5. 文笔要有古韵，但不要拗口，要有代入感，生动形象

当前时间：\${gameData.currentYear}年 \${gameData.currentMonth}月

当前人物列表：
\${selectedLadies.map(lady => {
  // 获取该人物近6个月的事件
  const ladyEvents = gameData.events.filter(event => 
    event.relatedLadies && event.relatedLadies.includes(lady.id)
  ).slice(-10); // 最多取最近10条相关事件
  
  const eventsText = ladyEvents.length > 0 
    ? ladyEvents.map(event => \`\${event.date}: \${event.content}\`).join('\\n')
    : '暂无相关事件';
    
  return \`\${lady.name} - 容貌:\${lady.looks}, 能力:\${lady.ability}, 房中术:\${lady.skills}, 身份:\${lady.title || '人物'}, 状态:\${lady.status || '健康'}, 心境:\${lady.mindset || '平静'}, 心情:\${lady.mood || '平静'}
人物介绍：\${lady.description || '暂无介绍'}
近期事件：
\${eventsText}\`;
}).join('\\n\\n')}

请以JSON格式返回心境自述：
{
  "moodAnalysis": [
    {
      "character": "王氏",
      "currentMood": "自那日梅林一舞得蒙天眷，本是春风得意，却见李贵妃眼底寒光乍现，如今夜夜对烛难眠，恐是花开易谢、恩宠难长。"
    },
    {
      "character": "李人物",
      "currentMood": "自胭脂事败，尝尽世态炎凉。偶见同乡飞上枝头，心下酸涩难言，如鲠在喉，夜半时常以泪洗面。"
    }
  ]
}

要求：每段心境自述都是一幅工笔写意，既要见古代人物的婉约情致，也要透出命运弄人的无奈与挣扎。字数严格控制在30-100字之间。`;
        }
      }
      
      // 加载商品生成设置
      if (savedProductSettings) {
        gameData.productSettings = JSON.parse(savedProductSettings);
        
        // 更新生成设置页面的商品提示词输入框
        const productGenerationPrompt = document.getElementById('product-generation-prompt');
        if (productGenerationPrompt) {
          productGenerationPrompt.value = gameData.productSettings.customPrompt || `角色： 你是一名为《古代上位模拟器》生成商城商品的AI。商品必须符合古代 人物 的身份和购买力。

核心原则：

身份相符： 商品必须是人物能私下获得、制作或购买的日常、隐蔽物品。禁止出现妃子级奢侈品。

价格合理： 货币单位为"银钱"。普通物品20-80银钱，稀有或强效物品80-200银钱。

效果明确： 直接说明对"容貌、能力、房中术、生命"四项属性的影响，或是产生某种具体的"陷害/情报/机会"效果。

生成方向（任选其一随机生成即可）：

属性类： 能提升人物自身属性的物品（如胭脂、药丸、书册）。

手段类： 用于算计他人或保护自己的消耗品。

特殊类： 能提供特殊机会或影响人际关系的物品。

输出格式：

请严格使用以下JSON格式生成5件商品，返回完整的JSON数组：

[
  {
    "name": "商品名称",
    "description": "简短描述，说明这是什么、怎么来的。",
    "effect": "具体效果，例如：容貌+10 / 让目标生病1天 / 获取一次某太监的把柄。",
    "price": 价格数字,
    "type": "属性/手段/特殊"
  }
]

当前时间：\${gameData.currentYear}年\${gameData.currentMonth}月

近10条记事：
\${recentEvents.map(event => \`\${event.date}: \${event.content}\`).join('\\n')}

现有商品：
\${existingProducts.map(product => \`\${product.name} - \${product.description} (\${product.price}银钱, \${product.type})\`).join('\\n')}

请生成5个新的、不与现有商品重复的商品。`;
        }
      } else {
        // 如果没有保存的商品生成设置，使用默认值
        gameData.productSettings = {
          customPrompt: null
        };
        
        // 更新生成设置页面的商品提示词输入框
        const productGenerationPrompt = document.getElementById('product-generation-prompt');
        if (productGenerationPrompt) {
          productGenerationPrompt.value = gameData.productSettings.customPrompt || `角色： 你是一名为《古代上位模拟器》生成商城商品的AI。商品必须符合古代 人物 的身份和购买力。

核心原则：

身份相符： 商品必须是人物能私下获得、制作或购买的日常、隐蔽物品。禁止出现妃子级奢侈品。

价格合理： 货币单位为"银钱"。普通物品20-80银钱，稀有或强效物品80-200银钱。

效果明确： 直接说明对"容貌、能力、房中术、生命"四项属性的影响，或是产生某种具体的"陷害/情报/机会"效果。

生成方向（任选其一随机生成即可）：

属性类： 能提升人物自身属性的物品（如胭脂、药丸、书册）。

手段类： 用于算计他人或保护自己的消耗品。

特殊类： 能提供特殊机会或影响人际关系的物品。

输出格式：

请严格使用以下JSON格式生成5件商品，返回完整的JSON数组：

[
  {
    "name": "商品名称",
    "description": "简短描述，说明这是什么、怎么来的。",
    "effect": "具体效果，例如：容貌+10 / 让目标生病1天 / 获取一次某太监的把柄。",
    "price": 价格数字,
    "type": "属性/手段/特殊"
  }
]

当前时间：\${gameData.currentYear}年\${gameData.currentMonth}月

近10条记事：
\${recentEvents.map(event => \`\${event.date}: \${event.content}\`).join('\\n')}

现有商品：
\${existingProducts.map(product => \`\${product.name} - \${product.description} (\${product.price}银钱, \${product.type})\`).join('\\n')}

请生成5个新的、不与现有商品重复的商品。`;
        }
      }
      
      // 加载心愿单生成设置
      if (savedWishlistSettings) {
        gameData.wishlistSettings = JSON.parse(savedWishlistSettings);
        
        // 更新生成设置页面的心愿单提示词输入框
        const wishlistGenerationPrompt = document.getElementById('wishlist-generation-prompt');
        if (wishlistGenerationPrompt) {
          wishlistGenerationPrompt.value = gameData.wishlistSettings.customPrompt || `你是"古代上位模拟器"的游戏核心系统，专门负责根据角色的当前状态，生成符合其性格、处境和需求的心愿单。

核心任务：分析给定的【角色属性】、【当前心境】和【近期事件】，推断出该角色在当下最可能渴望获得哪些物品。生成的心愿单需要真实、细腻，能反映角色的内心世界和成长轨迹。

生成规则与要求：

分析信息来源：你必须综合所有信息进行深度推理：
属性：决定心愿的基调
当前心境：决定心愿的情感导向
近10条事件：这是最重要的依据，心愿必须与最近的经历强相关（例如，刚被主子夸奖，可能想要新胭脂锦上添花；刚被大人物欺负，可能想要暗算别人的东西或寻求庇护）。

心愿单内容格式：每个心愿必须包含以下三个部分，缺一不可：
物品名称：符合游戏古代背景的具体物品
物品介绍：简要说明此物品的用途或象征意义（1句话即可）。
心理想法（第一人称，10-30字）：核心！用角色的口吻，结合上述分析，写出她"为什么想要"这个东西。要口语化，有情绪。

生成数量与质量：每次生成1-3个心愿项。宁可精准也不要堆砌。心愿要有差异性，可以涵盖不同方面（如：提升自我的、情感慰藉的、争宠实用的）。

当前时间：\${gameData.currentYear}年 \${gameData.currentMonth}月

当前人物列表：
\${gameData.ladies.map(lady => \`\${lady.name} - 容貌:\${lady.looks}, 能力:\${lady.ability}, 房中术:\${lady.skills}, 身份:\${lady.title || '人物'}, 状态:\${lady.status || '健康'}, 心境:\${lady.mindset || '平静'}, 心情:\${lady.mood || '平静'}\`).join('\\n')}

近期事件：
\${recentEvents.map(event => \`\${event.date}: \${event.content}\`).join('\\n')}

请以JSON格式返回心愿单：
{
  "wishlistAnalysis": [
    {
      "character": "王氏",
      "wishlistItems": [
        {
          "name": "鎏金百花香囊",
          "description": "内填名贵香料，行走时步步生香，是宫中妃嫔喜爱的饰物。",
          "thought": "上次李选侍就是凭一身异香得了陛下青睐，我也要备着，万一哪天偶遇圣驾呢……"
        },
        {
          "name": "苏绣手帕",
          "description": "江南进贡的上等丝帕，绣工精细，触感柔滑。",
          "thought": "皇后娘娘赏赐的手帕丢了，若能寻得相似的，或许能讨她欢心。"
        }
      ]
    }
  ]
}

要求：每个心愿都要体现角色的内心需求和当前处境，要有情感共鸣。`;
        }
      } else {
        // 如果没有保存的心愿单生成设置，使用默认值
        gameData.wishlistSettings = {
          customPrompt: null
        };
        
        // 更新生成设置页面的心愿单提示词输入框
        const wishlistGenerationPrompt = document.getElementById('wishlist-generation-prompt');
        if (wishlistGenerationPrompt) {
          wishlistGenerationPrompt.value = gameData.wishlistSettings.customPrompt || `你是"古代上位模拟器"的游戏核心系统，专门负责根据角色的当前状态，生成符合其性格、处境和需求的心愿单。

核心任务：分析给定的【角色属性】、【当前心境】和【近期事件】，推断出该角色在当下最可能渴望获得哪些物品。生成的心愿单需要真实、细腻，能反映角色的内心世界和成长轨迹。

生成规则与要求：

分析信息来源：你必须综合所有信息进行深度推理：
属性：决定心愿的基调
当前心境：决定心愿的情感导向
近10条事件：这是最重要的依据，心愿必须与最近的经历强相关（例如，刚被主子夸奖，可能想要新胭脂锦上添花；刚被大人物欺负，可能想要暗算别人的东西或寻求庇护）。

心愿单内容格式：每个心愿必须包含以下三个部分，缺一不可：
物品名称：符合游戏古代背景的具体物品
物品介绍：简要说明此物品的用途或象征意义（1句话即可）。
心理想法（第一人称，10-30字）：核心！用角色的口吻，结合上述分析，写出她"为什么想要"这个东西。要口语化，有情绪。

生成数量与质量：每次生成1-3个心愿项。宁可精准也不要堆砌。心愿要有差异性，可以涵盖不同方面（如：提升自我的、情感慰藉的、争宠实用的）。

当前时间：\${gameData.currentYear}年 \${gameData.currentMonth}月

当前人物列表：
\${gameData.ladies.map(lady => \`\${lady.name} - 容貌:\${lady.looks}, 能力:\${lady.ability}, 房中术:\${lady.skills}, 身份:\${lady.title || '人物'}, 状态:\${lady.status || '健康'}, 心境:\${lady.mindset || '平静'}, 心情:\${lady.mood || '平静'}\`).join('\\n')}

近期事件：
\${recentEvents.map(event => \`\${event.date}: \${event.content}\`).join('\\n')}

请以JSON格式返回心愿单：
{
  "wishlistAnalysis": [
    {
      "character": "王氏",
      "wishlistItems": [
        {
          "name": "鎏金百花香囊",
          "description": "内填名贵香料，行走时步步生香，是宫中妃嫔喜爱的饰物。",
          "thought": "上次李选侍就是凭一身异香得了陛下青睐，我也要备着，万一哪天偶遇圣驾呢……"
        },
        {
          "name": "苏绣手帕",
          "description": "江南进贡的上等丝帕，绣工精细，触感柔滑。",
          "thought": "皇后娘娘赏赐的手帕丢了，若能寻得相似的，或许能讨她欢心。"
        }
      ]
    }
  ]
}

要求：每个心愿都要体现角色的内心需求和当前处境，要有情感共鸣。`;
        }
      }
      
      // 加载商品数据
      if (savedProducts) {
        const savedProductsData = JSON.parse(savedProducts);
        // 如果有保存的商品数据，使用保存的数据
        if (savedProductsData && savedProductsData.length > 0) {
          // 清空当前商品数据
          productsData.length = 0;
          // 添加保存的商品数据
          savedProductsData.forEach(product => {
            productsData.push(product);
          });
        }
      }
      
      // 加载账单数据
      if (savedBills) {
        gameData.bills = JSON.parse(savedBills);
      } else {
        // 如果没有保存的账单数据，初始化为空数组
        gameData.bills = [];
      }
      
      // 加载流言数据
      const savedRumors = localStorage.getItem('palaceRumors');
      if (savedRumors) {
        gameData.rumors = JSON.parse(savedRumors);
      } else {
        // 如果没有保存的流言数据，初始化为空数组
        gameData.rumors = [];
      }
      
      // 加载书信数据
      const savedLetters = localStorage.getItem('palaceLetters');
      if (savedLetters) {
        gameData.letters = JSON.parse(savedLetters);
      } else {
        // 如果没有保存的书信数据，初始化为空数组
        gameData.letters = [];
      }
      
      // 加载剧本数据
      loadScriptData();
      
      // 在加载数据后填充下拉选择框
      if (gameData.apiModels && gameData.apiModels.length > 0) {
        // 填充模态框中的下拉选择框
        elements.apiModel.innerHTML = '';
        gameData.apiModels.forEach(model => {
          const option = document.createElement('option');
          option.value = model;
          option.textContent = model;
          elements.apiModel.appendChild(option);
        });
        
        // 填充设置页面中的下拉选择框
        elements.apiModelPage.innerHTML = '';
        gameData.apiModels.forEach(model => {
          const option = document.createElement('option');
          option.value = model;
          option.textContent = model;
          elements.apiModelPage.appendChild(option);
        });
        
        // 设置当前选中的模型
        if (gameData.apiSettings && gameData.apiSettings.modelName) {
          elements.apiModel.value = gameData.apiSettings.modelName;
          elements.apiModelPage.value = gameData.apiSettings.modelName;
        }
      }
    }
    
    // 保存数据到本地存储
    function saveData() {
      localStorage.setItem('palaceLadies', JSON.stringify(gameData.ladies));
      localStorage.setItem('palaceEvents', JSON.stringify(gameData.events));
      localStorage.setItem('palaceDate', JSON.stringify({
        year: gameData.currentYear,
        month: gameData.currentMonth
      }));
      localStorage.setItem('palaceMoney', JSON.stringify(gameData.money));
      localStorage.setItem('palaceApiSettings', JSON.stringify(gameData.apiSettings));
      // 保存模型列表
      localStorage.setItem('palaceApiModels', JSON.stringify(gameData.apiModels || []));
      // 保存事件设置
      localStorage.setItem('palaceEventSettings', JSON.stringify(gameData.eventSettings));
      // 保存心境设置
      localStorage.setItem('palaceMoodSettings', JSON.stringify(gameData.moodSettings));
      // 保存商品生成设置
      localStorage.setItem('palaceProductSettings', JSON.stringify(gameData.productSettings));
      // 保存心愿单生成设置
      localStorage.setItem('palaceWishlistSettings', JSON.stringify(gameData.wishlistSettings));
      // 保存商品数据
      localStorage.setItem('palaceProducts', JSON.stringify(productsData));
      // 保存账单数据
      localStorage.setItem('palaceBills', JSON.stringify(gameData.bills || []));
      // 保存流言数据
      localStorage.setItem('palaceRumors', JSON.stringify(gameData.rumors || []));
      // 保存书信数据
      localStorage.setItem('palaceLetters', JSON.stringify(gameData.letters || []));
      // 保存剧本数据
      saveScriptData();
    }
    
    // 更新月份显示
    function updateMonthDisplay() {
      // 获取当前显示的月份，如果没有设置则使用当前游戏月份
      const displayYear = gameData.displayYear || gameData.currentYear;
      const displayMonth = gameData.displayMonth || gameData.currentMonth;
      
      const yearText = `${displayYear}年`;
      const monthText = `${displayMonth}月`;
      elements.currentMonth.textContent = `${yearText} ${monthText}`;
    }
    
    // 切换心境展示
    function toggleMoodDisplay() {
      isMoodDisplayVisible = !isMoodDisplayVisible;
      
      // 获取所有心境覆盖层
      const moodOverlays = document.querySelectorAll('.mood-overlay');
      
      if (isMoodDisplayVisible) {
        // 显示所有心境覆盖层
        moodOverlays.forEach(overlay => {
          overlay.classList.remove('hidden');
        });
        
        // 如果没有人物，显示提示
        if (gameData.ladies.length === 0) {
          showToast('暂无人物，请先添加人物');
          isMoodDisplayVisible = false;
        }
      } else {
        // 隐藏所有心境覆盖层
        moodOverlays.forEach(overlay => {
          overlay.classList.add('hidden');
        });
      }
    }
    
    // 显示心境覆盖层
    function showMoodDisplay() {
      // 获取所有心境覆盖层
      const moodOverlays = document.querySelectorAll('.mood-overlay');
      
      // 显示所有心境覆盖层
      moodOverlays.forEach(overlay => {
        overlay.classList.remove('hidden');
      });
      
      // 如果没有人物，显示提示
      if (gameData.ladies.length === 0) {
        showToast('暂无人物，请先添加人物');
        isMoodDisplayVisible = false;
        return;
      }
    }
    
    // 隐藏心境覆盖层
    function hideMoodDisplay() {
      // 获取所有心境覆盖层
      const moodOverlays = document.querySelectorAll('.mood-overlay');
      
      // 隐藏所有心境覆盖层
      moodOverlays.forEach(overlay => {
        overlay.classList.add('hidden');
      });
      
      isMoodDisplayVisible = false;
    }
    
    // 渲染人物页面中的人物列表
    function renderLadiesInModal() {
      if (gameData.ladies.length === 0) {
        elements.noLadiesMessageModal.classList.remove('hidden');
        elements.ladiesContainerModal.innerHTML = '';
        elements.ladiesContainerModal.appendChild(elements.noLadiesMessageModal);
        return;
      }
      
      elements.noLadiesMessageModal.classList.add('hidden');
      elements.ladiesContainerModal.innerHTML = '';
      
      gameData.ladies.forEach(lady => {
        const ladyCard = createLadyCard(lady);
        elements.ladiesContainerModal.appendChild(ladyCard);
      });
    }
    
    // 渲染人物页面中的人物列表
    function renderLadiesInPage() {
      if (gameData.ladies.length === 0) {
        elements.noLadiesMessagePage.classList.remove('hidden');
        elements.ladiesContainerPage.innerHTML = '';
        elements.ladiesContainerPage.appendChild(elements.noLadiesMessagePage);
        return;
      }
      
      elements.noLadiesMessagePage.classList.add('hidden');
      elements.ladiesContainerPage.innerHTML = '';
      
      gameData.ladies.forEach(lady => {
        const ladyCard = createLadyCard(lady);
        elements.ladiesContainerPage.appendChild(ladyCard);
      });
    }
    
    // 创建人物卡片
    function createLadyCard(lady) {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-xl p-3 card-shadow card border-2 border-primary';
      card.dataset.id = lady.id;
      
      // 获取头像URL，优先使用自定义头像
      let avatarUrl;
      if (lady.customAvatar) {
        avatarUrl = lady.customAvatar;
      } else {
        avatarUrl = gameData.avatarOptions.find(avatar => avatar.id === lady.avatarId)?.url || gameData.avatarOptions[0].url;
      }
      
      // 检查头像框是否应该隐藏
      const isAvatarFrameHidden = localStorage.getItem('avatarFrameHidden') === 'true';
      const avatarFrameClass = isAvatarFrameHidden ? 'avatar-frame hidden' : 'avatar-frame';
      
      card.innerHTML = `
        <div class="flex items-center mb-2">
          <div class="avatar-container mr-2">
            <img src="${avatarUrl}" alt="${lady.name}" class="w-12 h-12 rounded-full object-cover">
            <div class="${avatarFrameClass}"></div>
          </div>
          <div>
            <h4 class="font-medium">${lady.name}</h4>
            <p class="text-xs text-gray-500">${lady.title || '人物'}</p>
          </div>
        </div>
        
        <div class="space-y-2 relative">
          <div>
            <div class="flex justify-between text-xs mb-1">
              <span>容貌</span>
              <span>${lady.looks}</span>
            </div>
            <div class="stat-bar">
              <div class="stat-value bg-primary" style="width: ${lady.looks}%"></div>
            </div>
          </div>
          
          <div>
            <div class="flex justify-between text-xs mb-1">
              <span>能力</span>
              <span>${lady.ability}</span>
            </div>
            <div class="stat-bar">
              <div class="stat-value bg-secondary" style="width: ${lady.ability}%"></div>
            </div>
          </div>
          
          <div>
            <div class="flex justify-between text-xs mb-1">
              <span>房中术</span>
              <span>${lady.skills}</span>
            </div>
            <div class="stat-bar">
              <div class="stat-value bg-tertiary" style="width: ${lady.skills}%"></div>
            </div>
          </div>
          
          <div>
            <div class="flex justify-between text-xs mb-1">
              <span>生命</span>
              <span>${lady.life}</span>
            </div>
            <div class="stat-bar">
              <div class="stat-value bg-red-500" style="width: ${lady.life}%"></div>
            </div>
          </div>
          
          <!-- 心境覆盖层 -->
          <div class="mood-overlay absolute inset-x-0 top-0 bg-white bg-opacity-95 p-3 rounded-lg hidden" style="transform: translateY(-20%);">
            <div class="text-sm font-medium text-primary mb-2">心境</div>
            <div class="text-xs text-gray-700">
              ${lady.mindset || '暂无心境描述'}
            </div>
          </div>
        </div>
        
        <div class="flex flex-wrap gap-1 mt-2">
          ${lady.status ? `
            <span class="text-xs bg-quaternary bg-opacity-30 text-quaternary px-2 py-1 rounded-full">
              ${lady.status}
            </span>
          ` : ''}
          ${lady.mood ? `
            <span class="text-xs bg-primary bg-opacity-30 text-primary px-2 py-1 rounded-full">
              ${lady.mood}
            </span>
          ` : ''}
        </div>
      `;
      
      // 添加删除按钮
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'absolute top-2 right-2 text-xs text-gray-400';
      deleteBtn.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>';
      deleteBtn.onclick = (e) => {
        e.stopPropagation();
        deleteLady(lady.id);
      };
      
      card.style.position = 'relative';
      card.appendChild(deleteBtn);
      
      // 添加点击事件查看详情
      card.addEventListener('click', () => {
        showLadyDetails(lady);
      });
      
      return card;
    }
    
    // 删除人物
    function deleteLady(id) {
      const lady = gameData.ladies.find(l => l.id === id);
      if (!lady) return;
      
      // 创建游戏内部确认弹框
      const modal = document.createElement('div');
      modal.className = 'modal active';
      
      modal.innerHTML = `
        <div class="modal-content p-5">
          <div class="text-center mb-4">
            <h3 class="text-lg font-bold text-primary mb-2">确认删除</h3>
            <p class="text-sm text-gray-600">确定要删除人物 <span class="font-medium">${lady.name}</span> 吗？</p>
            <p class="text-xs text-gray-500 mt-1">此操作不可恢复</p>
          </div>
          
          <div class="flex justify-center space-x-3">
            <button id="cancelDelete" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg">
              取消
            </button>
            <button id="confirmDelete" class="px-4 py-2 bg-red-500 text-white rounded-lg">
              删除
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // 添加取消按钮事件
      document.getElementById('cancelDelete').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // 添加确认删除按钮事件
      document.getElementById('confirmDelete').addEventListener('click', () => {
        gameData.ladies = gameData.ladies.filter(l => l.id !== id);
        renderLadiesInModal();
        renderLadiesInPage();
        saveData();
        document.body.removeChild(modal);
        showToast(`人物${lady.name}已被删除`);
      });
    }
    
    // 显示人物详情
    function showLadyDetails(lady) {
      const modal = document.createElement('div');
      modal.className = 'modal active lady-details-modal';
      modal.dataset.ladyName = lady.name;
      
      // 获取头像URL，优先使用自定义头像
      let avatarUrl;
      if (lady.customAvatar) {
        avatarUrl = lady.customAvatar;
      } else {
        avatarUrl = gameData.avatarOptions.find(avatar => avatar.id === lady.avatarId)?.url || gameData.avatarOptions[0].url;
      }
      
      // 检查头像框是否应该隐藏
      const isAvatarFrameHidden = localStorage.getItem('avatarFrameHidden') === 'true';
      const avatarFrameClass = isAvatarFrameHidden ? 'avatar-frame hidden' : 'avatar-frame';
      
      modal.innerHTML = `
        <div class="modal-content p-5 border-2 border-primary">
          <div class="flex justify-between items-center mb-4">
            <div class="flex items-center">
              <h3 class="text-lg font-bold text-primary">${lady.name} 详情</h3>
              <button class="edit-character-btn ml-3 text-primary hover:text-primary-dark" data-lady-id="${lady.id}" data-lady-name="${lady.name}">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                </svg>
              </button>
            </div>
            <button class="close-modal text-gray-400">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
          
          <div class="text-center mb-4">
            <div class="relative inline-block">
              <div class="avatar-container">
                <img src="${avatarUrl}" alt="${lady.name}" class="w-24 h-24 rounded-full mx-auto mb-2 cursor-pointer hover:opacity-80 transition-opacity object-cover" id="lady-avatar-${lady.id}">
                <div class="${avatarFrameClass}"></div>
              </div>
              <div class="absolute inset-0 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity bg-black bg-opacity-50 rounded-full cursor-pointer" id="avatar-upload-overlay-${lady.id}">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
              </div>
            </div>
            <h4 class="text-xl font-bold">${lady.name}</h4>
            <p class="text-sm text-gray-500">${lady.title || '人物'}</p>
          </div>
          
          <!-- 隐藏滑竿，只显示数值 -->
          <div class="space-y-3 mb-4" style="display: none;">
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span>容貌</span>
                <span>${lady.looks}</span>
              </div>
              <div class="stat-bar">
                <div class="stat-value bg-primary" style="width: ${lady.looks}%"></div>
              </div>
            </div>
            
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span>能力</span>
                <span>${lady.ability}</span>
              </div>
              <div class="stat-bar">
                <div class="stat-value bg-secondary" style="width: ${lady.ability}%"></div>
              </div>
            </div>
            
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span>房中术</span>
                <span>${lady.skills}</span>
              </div>
              <div class="stat-bar">
                <div class="stat-value bg-tertiary" style="width: ${lady.skills}%"></div>
              </div>
            </div>
          </div>
          
          <div class="mb-4 flex justify-center space-x-2">
            ${lady.status ? `
              <span class="text-sm bg-quaternary bg-opacity-30 text-quaternary px-3 py-1 rounded-full">
                ${lady.status}
              </span>
            ` : ''}
            ${lady.mood ? `
              <span class="text-sm bg-primary bg-opacity-30 text-primary px-3 py-1 rounded-full">
                心情: ${lady.mood}
              </span>
            ` : ''}
          </div>
          
          <div class="mb-4">
            <h5 class="text-sm font-medium mb-2">心境</h5>
            <div class="text-sm text-gray-600 p-3 bg-gray-50 rounded-lg">
              ${lady.mindset || '暂无心境描述'}
            </div>
          </div>
          
          ${lady.description ? `
          <div class="mb-4">
            <h5 class="text-sm font-medium mb-2">人物介绍</h5>
            <div class="text-sm text-gray-600 p-3 bg-gray-50 rounded-lg">
              ${lady.description}
            </div>
          </div>
          ` : ''}
          
          <div>
            <h5 class="text-sm font-medium mb-2">近6个月事件</h5>
            <div class="text-sm space-y-2 max-h-60 overflow-y-auto thin-scrollbar">
              ${getLadyRecentEvents(lady.id).map(event => `
                <div class="bg-gray-50 p-2 rounded-lg">
                  <p class="text-xs text-gray-500 mb-1">${event.date}</p>
                  <p>${highlightNamesInText(event.content)}</p>
                </div>
              `).join('') || '<p class="text-gray-400 text-center">暂无事件记录</p>'}
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // 添加关闭按钮事件
      modal.querySelector('.close-modal').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // 添加"获取"按钮的事件监听器
      const getItemButtons = modal.querySelectorAll('.get-item-btn');
      getItemButtons.forEach(button => {
        button.addEventListener('click', () => {
          const ladyName = button.getAttribute('data-lady');
          const itemName = button.getAttribute('data-item');
          const itemEffect = button.getAttribute('data-effect');
          
          // 添加获取商品的记事
          addGetItemEvent(ladyName, itemName, itemEffect);
          
          // 显示成功消息
          showSuccessMessage(`已为${ladyName}获取${itemName}！`);
        });
      });
      
      // 添加编辑人物按钮事件
      modal.querySelector('.edit-character-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        const ladyId = e.currentTarget.dataset.ladyId;
        const ladyName = e.currentTarget.dataset.ladyName;
        openEditCharacterModal(ladyId, ladyName);
      });
      
      // 添加头像点击上传事件
      const avatarImg = document.getElementById(`lady-avatar-${lady.id}`);
      const avatarOverlay = document.getElementById(`avatar-upload-overlay-${lady.id}`);
      
      // 创建隐藏的文件输入元素
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      fileInput.style.display = 'none';
      fileInput.id = `avatar-file-input-${lady.id}`;
      document.body.appendChild(fileInput);
      
      // 头像点击事件
      const handleAvatarClick = () => {
        fileInput.click();
      };
      
      // 文件选择事件
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          // 验证文件类型
          if (!file.type.startsWith('image/')) {
            showToast('请选择图片文件！', 'error');
            return;
          }
          
          // 验证文件大小 (限制为5MB)
          if (file.size > 5 * 1024 * 1024) {
            showToast('图片大小不能超过5MB！', 'error');
            return;
          }
          
          // 读取并预览图片
          const reader = new FileReader();
          reader.onload = (e) => {
            const newAvatarUrl = e.target.result;
            
            // 更新头像显示
            avatarImg.src = newAvatarUrl;
            
            // 更新人物数据
            lady.customAvatar = newAvatarUrl;
            
            // 保存数据
            saveData();
            
            // 更新人物列表中的头像
            renderLadiesInPage();
            
            showToast('头像已更新！');
          };
          reader.readAsDataURL(file);
        }
        
        // 重置文件输入，以便可以重复选择同一文件
        fileInput.value = '';
      });
      
      // 绑定点击事件
      avatarImg.addEventListener('click', handleAvatarClick);
      avatarOverlay.addEventListener('click', handleAvatarClick);
    }
    
    // 显示错误详情
    function showErrorDetails(error, operation) {
      // 创建错误详情模态框
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.id = 'error-details-modal';
      
      // 获取错误信息
      let errorMessage = '未知错误';
      let errorDetails = '';
      
      if (typeof error === 'string') {
        errorMessage = error;
      } else if (error && error.message) {
        errorMessage = error.message;
        
        // 尝试从错误中提取更多详细信息
        if (error.response) {
          errorDetails = `状态码: ${error.response.status}\n`;
          if (error.response.data) {
            errorDetails += `响应数据: ${JSON.stringify(error.response.data, null, 2)}`;
          }
        } else if (error.status) {
          errorDetails = `状态码: ${error.status}\n`;
          if (error.data) {
            errorDetails += `响应数据: ${JSON.stringify(error.data, null, 2)}`;
          }
        } else if (error.error) {
          errorDetails = `错误详情: ${JSON.stringify(error.error, null, 2)}`;
        }
      }
      
      modal.innerHTML = `
        <div class="modal-content p-5 border-2 border-red-500 max-w-2xl">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-red-500">${operation}失败</h3>
            <button class="close-modal text-gray-400">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
          
          <div class="mb-4">
            <p class="text-sm text-gray-600 mb-2">操作：${operation}</p>
            <p class="text-sm font-medium text-gray-800 mb-2">错误信息：</p>
            <div class="bg-red-50 p-3 rounded-lg border border-red-200">
              <p class="text-sm text-red-700">${errorMessage}</p>
            </div>
          </div>
          
          ${errorDetails ? `
            <div class="mb-4">
              <p class="text-sm font-medium text-gray-800 mb-2">详细信息：</p>
              <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 max-h-60 overflow-y-auto">
                <pre class="text-xs text-gray-700 whitespace-pre-wrap">${errorDetails}</pre>
              </div>
            </div>
          ` : ''}
          
          <div class="mb-4">
            <p class="text-sm text-gray-600 mb-2">可能的解决方案：</p>
            <ul class="text-sm text-gray-600 list-disc list-inside space-y-1">
              ${errorMessage.includes('格式不正确') ? 
                '<li>一般是提示词更改后导致格式不正确。请恢复默认提示词后重新更改。不要变动代码部分。</li>' :
                '<li>检查API密钥是否正确</li>' +
                '<li>检查网络连接是否正常</li>' +
                '<li>检查API服务是否可用</li>' +
                '<li>检查请求参数是否正确</li>' +
                '<li>稍后重试'
              }
            </ul>
          </div>
          
          <div class="flex justify-end space-x-2">
            <button class="close-modal-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-colors">
              关闭
            </button>
            ${errorMessage.includes('格式不正确') ? 
              '<button class="confirm-btn bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg transition-colors">确定</button>' :
              '<button class="retry-btn bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg transition-colors">重试</button>'
            }
          </div>
        </div>
      `;
      
      // 添加到页面
      document.body.appendChild(modal);
      
      // 添加事件监听
      const closeModal = () => {
        document.body.removeChild(modal);
      };
      
      modal.querySelector('.close-modal').addEventListener('click', closeModal);
      modal.querySelector('.close-modal-btn').addEventListener('click', closeModal);
      
      // 根据错误类型决定按钮行为
      if (errorMessage.includes('格式不正确')) {
        // 格式不正确错误，确定按钮只关闭弹框
        modal.querySelector('.confirm-btn').addEventListener('click', closeModal);
      } else {
        // 其他错误，重试按钮执行重试操作
        modal.querySelector('.retry-btn').addEventListener('click', () => {
          closeModal();
          // 根据操作类型决定重试哪个函数
          if (operation.includes('记事') || operation.includes('事件')) {
            generateEvents();
          } else if (operation.includes('心境')) {
            generateMoods();
          } else if (operation.includes('心愿单')) {
            generateWishlists();
          } else if (operation.includes('商品')) {
            generateProducts();
          }
        });
      }
      
      // 点击背景关闭
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });
    }
    
    // 高亮文本中的人名
    function highlightNamesInText(text) {
      if (!text) return text;
      
      let highlightedText = text;
      // 获取所有人物名字
      const allLadyNames = gameData.ladies.map(lady => lady.name);
      
      // 按名字长度降序排序，避免短名字被优先匹配（如"李"在"李氏"前匹配）
      allLadyNames.sort((a, b) => b.length - a.length);
      
      // 为每个名字添加高亮
      allLadyNames.forEach(name => {
        if (name && name.trim()) {
          // 使用正则表达式确保只匹配完整的名字，避免部分匹配
          const regex = new RegExp(`(${name})`, 'g');
          highlightedText = highlightedText.replace(regex, '<span class="text-primary font-medium">$1</span>');
        }
      });
      
      return highlightedText;
    }
    
    // 获取人物近期事件
    function getLadyRecentEvents(ladyId) {
      // 获取当前日期
      const currentDate = new Date(gameData.currentYear, gameData.currentMonth - 1);
      
      // 计算6个月前的日期
      const sixMonthsAgo = new Date(currentDate);
      sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
      
      // 获取人物名称
      const lady = gameData.ladies.find(l => l.id === ladyId);
      const ladyName = lady ? lady.name : '';
      
      // 筛选出该人物近6个月的事件
      return gameData.events
        .filter(event => {
          // 检查事件是否与该人物相关
          // 检查relatedLadies（旧格式）或ladies（新格式）数组
          const isRelatedByLadies = event.ladies && event.ladies.includes(ladyName);
          const isRelatedByRelatedLadies = event.relatedLadies && event.relatedLadies.includes(ladyId);
          
          if (!isRelatedByLadies && !isRelatedByRelatedLadies) {
            return false;
          }
          
          // 解析事件日期
          let eventDate;
          if (event.date.includes('年')) {
            // 格式: "2024年5月"
            const [eventYear, eventMonth] = event.date.split('年').map(part => {
              if (part.includes('月')) {
                return parseInt(part.replace('月', ''));
              }
              return parseInt(part);
            });
            eventDate = new Date(eventYear, eventMonth - 1);
          } else {
            // 格式: "2024-05-01"
            eventDate = new Date(event.date);
          }
          
          // 检查事件是否在近6个月内
          return eventDate >= sixMonthsAgo && eventDate <= currentDate;
        })
        .sort((a, b) => {
          // 按时间倒序排列，最近的在前
          // 处理两种日期格式
          let dateA, dateB;
          if (a.date.includes('年')) {
            const [yearA, monthA] = a.date.split('年').map(part => {
              if (part.includes('月')) {
                return parseInt(part.replace('月', ''));
              }
              return parseInt(part);
            });
            dateA = new Date(yearA, monthA - 1);
          } else {
            dateA = new Date(a.date);
          }
          
          if (b.date.includes('年')) {
            const [yearB, monthB] = b.date.split('年').map(part => {
              if (part.includes('月')) {
                return parseInt(part.replace('月', ''));
              }
              return parseInt(part);
            });
            dateB = new Date(yearB, monthB - 1);
          } else {
            dateB = new Date(b.date);
          }
          
          return dateB - dateA;
        });
    }
    
    // 渲染事件列表
    function renderEvents() {
      // 获取当前显示的月份，如果没有设置则使用当前游戏月份
      const displayYear = gameData.displayYear || gameData.currentYear;
      const displayMonth = gameData.displayMonth || gameData.currentMonth;
      
      // 筛选当前显示月份的事件
      const currentMonthEvents = gameData.events.filter(event => {
        let eventDate;
        if (event.date.includes('年')) {
          // 格式: "2024年5月"
          const [eventYear, eventMonth] = event.date.split('年').map(part => {
            if (part.includes('月')) {
              return parseInt(part.replace('月', ''));
            }
            return parseInt(part);
          });
          eventDate = {
            year: eventYear,
            month: eventMonth
          };
        } else {
          // 格式: "2024-05-01"
          const date = new Date(event.date);
          eventDate = {
            year: date.getFullYear(),
            month: date.getMonth() + 1
          };
        }
        
        return eventDate.year === displayYear && eventDate.month === displayMonth;
      }).sort((a, b) => {
        // 按时间倒序排列，最近的在前
        // 处理两种日期格式
        let dateA, dateB;
        if (a.date.includes('年')) {
          const [yearA, monthA] = a.date.split('年').map(part => {
            if (part.includes('月')) {
              return parseInt(part.replace('月', ''));
            }
            return parseInt(part);
          });
          dateA = new Date(yearA, monthA - 1);
        } else {
          dateA = new Date(a.date);
        }
        
        if (b.date.includes('年')) {
          const [yearB, monthB] = b.date.split('年').map(part => {
            if (part.includes('月')) {
              return parseInt(part.replace('月', ''));
            }
            return parseInt(part);
          });
          dateB = new Date(yearB, monthB - 1);
        } else {
          dateB = new Date(b.date);
        }
        
        return dateB - dateA;
      });
      
      if (currentMonthEvents.length === 0) {
        elements.noEventsMessage.classList.remove('hidden');
        elements.eventsContainer.innerHTML = '';
        elements.eventsContainer.appendChild(elements.noEventsMessage);
        
        // 添加月份指示器
        const monthIndicator = document.createElement('div');
        monthIndicator.className = 'mb-4 text-center flex justify-center items-center';
        monthIndicator.innerHTML = `
          <div class="month-indicator">${displayYear}年 ${displayMonth}月</div>
          <button id="calendar-btn" class="ml-3 bg-tertiary text-white p-2 rounded-full btn-shadow">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
            </svg>
          </button>
          <button id="add-event-btn" class="ml-3 bg-primary text-white p-2 rounded-full btn-shadow">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
            </svg>
          </button>
        `;
        elements.eventsContainer.appendChild(monthIndicator);
        
        // 添加日历按钮事件监听
        document.getElementById('calendar-btn').addEventListener('click', showMonthSelector);
        // 添加记事按钮事件监听
        document.getElementById('add-event-btn').addEventListener('click', showAddEventModal);
        return;
      }
      
      elements.noEventsMessage.classList.add('hidden');
      elements.eventsContainer.innerHTML = '';
      
      // 添加月份指示器
      const monthIndicator = document.createElement('div');
      monthIndicator.className = 'mb-4 text-center flex justify-center items-center';
      monthIndicator.style.backgroundColor = 'rgba(255, 255, 255, 0.8)'; // 添加半透明背景，确保文字可见
      monthIndicator.style.borderRadius = '12px';
      monthIndicator.style.padding = '8px';
      monthIndicator.innerHTML = `
        <div class="month-indicator">${displayYear}年 ${displayMonth}月</div>
        <button id="calendar-btn" class="ml-3 bg-tertiary text-white p-2 rounded-full btn-shadow">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
          </svg>
        </button>
        <button id="add-event-btn" class="ml-3 bg-primary text-white p-2 rounded-full btn-shadow">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
          </svg>
        </button>
      `;
      elements.eventsContainer.appendChild(monthIndicator);
      
      // 添加日历按钮事件监听
      document.getElementById('calendar-btn').addEventListener('click', showMonthSelector);
      // 添加记事按钮事件监听
      document.getElementById('add-event-btn').addEventListener('click', showAddEventModal);
      
      // 添加事件
      currentMonthEvents.forEach(event => {
        const eventItem = createEventItem(event);
        elements.eventsContainer.appendChild(eventItem);
      });
    }

    // 添加获取商品的记事
    function addGetItemEvent(ladyName, itemName, itemEffect, itemThought) {
      // 获取当前游戏内时间
      const currentYear = gameData.currentYear;
      const currentMonth = gameData.currentMonth;
      const formattedDate = `${currentYear}年${currentMonth}月`;
      
      // 创建记事内容，包含人物的想法
      const eventContent = `${ladyName}获得了${itemName}，${itemEffect}。她心想："${itemThought}"`;
      
      // 创建记事对象
      const newEvent = {
        id: Date.now().toString(),
        date: formattedDate,
        ladies: [ladyName],
        content: eventContent,
        effect: {},
        type: 'getItem' // 标记为获取商品的记事
      };
      
      // 添加到游戏数据
      if (!gameData.events) {
        gameData.events = [];
      }
      gameData.events.push(newEvent);
      
      // 保存数据
      saveData();
      
      // 更新显示
      renderEvents();
    }
    
    // 创建事件项
    function createEventItem(event) {
      const item = document.createElement('div');
      item.className = 'event-item bg-white rounded-lg p-3 mb-3 border border-gray-100 relative';
      item.style.backgroundColor = 'rgba(255, 255, 255, 0.8)'; // 添加半透明背景，确保文字可见
      
      // 获取相关人物的名字（兼容新旧格式）
      let relatedLadyNames = '';
      
      // 优先使用新的ladies字段
      if (event.ladies && event.ladies.length > 0) {
        relatedLadyNames = event.ladies.join('、');
      } 
      // 如果没有ladies字段，使用旧的relatedLadies字段
      else if (event.relatedLadies && event.relatedLadies.length > 0) {
        relatedLadyNames = event.relatedLadies.map(ladyId => {
          const lady = gameData.ladies.find(l => l.id === ladyId);
          return lady ? lady.name : '';
        }).filter(Boolean).join('、');
      }
      
      // 解析effects对象，只显示心情和健康状态变化
      let effectText = '';
      if (event.effects) {
        let effects = {};
        try {
          effects = typeof event.effects === 'string' ? JSON.parse(event.effects) : event.effects;
        } catch (e) {
          effects = {};
        }
        
        const effectParts = [];
        if (effects.target && effects.mood) {
          // 直接使用effects.mood作为心情，不进行任何替换或验证
          effectParts.push(`${effects.target}心情变为${effects.mood}`);
        }
        // 同时支持status和health字段
        const healthStatus = effects.status !== undefined ? effects.status : effects.health;
        if (effects.target && healthStatus) {
          effectParts.push(`${effects.target}状态变为${healthStatus}`);
        }
        if (effects.target && effects.title) {
          effectParts.push(`${effects.target}身份变为${effects.title}`);
        }
        
        if (effectParts.length > 0) {
          effectText = effectParts.join('，');
        }
      }
      
      // 高亮事件内容和效果中的人名
      const highlightedContent = highlightNamesInText(event.content);
      const highlightedEffect = effectText ? highlightNamesInText(effectText) : '';
      
      item.innerHTML = `
        <div class="flex justify-between items-start mb-2">
          <span class="text-xs text-gray-500">${event.date}</span>
          ${relatedLadyNames ? `
            <span class="text-xs bg-primary bg-opacity-20 text-primary px-2 py-0.5 rounded-full">
              ${relatedLadyNames}
            </span>
          ` : ''}
        </div>
        <p class="text-sm">${highlightedContent}</p>
        ${highlightedEffect ? `
          <div class="mt-2 text-xs text-gray-500">
            <svg class="w-3 h-3 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
            </svg> ${highlightedEffect}
          </div>
        ` : ''}
        <button class="edit-event-btn absolute bottom-2 right-2 text-gray-400 hover:text-gray-600 transition-colors" data-event-id="${event.id}">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
          </svg>
        </button>
      `;
      
      // 添加编辑按钮事件监听
      const editBtn = item.querySelector('.edit-event-btn');
      editBtn.addEventListener('click', () => {
        openEditEventModal(event);
      });
      
      return item;
    }
    
    // 设置事件监听器
    function setupEventListeners() {
      // 下一个月按钮
      elements.nextMonthBtn.addEventListener('click', nextMonth);
      
      // 弹幕按钮点击事件
      const danmuBtn = document.getElementById('danmu-btn');
      if (danmuBtn) {
        danmuBtn.addEventListener('click', function() {
          showDanmuOptionsModal();
        });
      }
      
      // 下拉菜单按钮
      if (elements.addDropdownBtn) {
        elements.addDropdownBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (elements.addDropdownMenu) {
            elements.addDropdownMenu.classList.toggle('hidden');
            elements.addDropdownMenu.classList.toggle('show');
          }
        });
      }
      
      // 下拉菜单选项
      if (elements.addLadyDropdown) {
        elements.addLadyDropdown.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (elements.addLadyModal) {
            elements.addLadyModal.classList.add('active');
          }
          if (elements.addDropdownMenu) {
            elements.addDropdownMenu.classList.add('hidden');
            elements.addDropdownMenu.classList.remove('show');
          }
        });
      }
      
      if (elements.generateMoodDropdown) {
        elements.generateMoodDropdown.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          generateMoods();
          if (elements.addDropdownMenu) {
            elements.addDropdownMenu.classList.add('hidden');
            elements.addDropdownMenu.classList.remove('show');
          }
        });
      }
      
      // 展示心境切换按钮
      if (elements.toggleMoodDisplayDropdown) {
        elements.toggleMoodDisplayDropdown.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          toggleMoodDisplay();
          if (elements.addDropdownMenu) {
            elements.addDropdownMenu.classList.add('hidden');
            elements.addDropdownMenu.classList.remove('show');
          }
        });
      }
      
      // AI剧本按钮
      if (elements.aiScriptDropdown) {
        elements.aiScriptDropdown.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (elements.aiScriptModal) {
            elements.aiScriptModal.classList.add('active');
          }
          if (elements.addDropdownMenu) {
            elements.addDropdownMenu.classList.add('hidden');
            elements.addDropdownMenu.classList.remove('show');
          }
        });
      }
      
      // 查看剧本按钮
      if (elements.viewScriptDropdown) {
        elements.viewScriptDropdown.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (elements.viewScriptModal) {
            elements.viewScriptModal.classList.add('active');
            // 显示剧本内容
            displayScript();
          }
          if (elements.addDropdownMenu) {
            elements.addDropdownMenu.classList.add('hidden');
            elements.addDropdownMenu.classList.remove('show');
          }
        });
      }
      
      // 探索页面下拉菜单按钮
      if (elements.generateDropdownBtn) {
        elements.generateDropdownBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (elements.generateDropdownMenu) {
            elements.generateDropdownMenu.classList.toggle('hidden');
            elements.generateDropdownMenu.classList.toggle('show');
          }
        });
      }
      
      // 探索页面生成商品下拉选项
      if (elements.generateProductsDropdown) {
        elements.generateProductsDropdown.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          generateProducts();
          if (elements.generateDropdownMenu) {
            elements.generateDropdownMenu.classList.add('hidden');
            elements.generateDropdownMenu.classList.remove('show');
          }
        });
      }
      
      // 探索页面生成心愿单下拉选项
      if (elements.generateWishlistDropdown) {
        elements.generateWishlistDropdown.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          showWishlistSelection();
          if (elements.generateDropdownMenu) {
            elements.generateDropdownMenu.classList.add('hidden');
            elements.generateDropdownMenu.classList.remove('show');
          }
        });
      }
      
      // 探索页面查看心愿单下拉选项
      if (elements.viewWishlistDropdown) {
        elements.viewWishlistDropdown.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          showViewWishlistModal();
          if (elements.generateDropdownMenu) {
            elements.generateDropdownMenu.classList.add('hidden');
            elements.generateDropdownMenu.classList.remove('show');
          }
        });
      }
      
      // 人物页面中的添加人物按钮
      if (elements.addLadyBtnModal) {
        elements.addLadyBtnModal.addEventListener('click', () => {
          if (elements.addLadyModal) {
            elements.addLadyModal.classList.add('active');
          }
        });
      }
      
      // 人物页面中的添加人物按钮
      if (elements.addLadyBtnPage) {
        elements.addLadyBtnPage.addEventListener('click', () => {
          if (elements.addLadyModal) {
            elements.addLadyModal.classList.add('active');
          }
        });
      }
      
      // 生成心境按钮（页面）
      if (elements.generateMoodBtnPage) {
        elements.generateMoodBtnPage.addEventListener('click', generateMoods);
      }
      
      // 生成心境按钮（模态框）
      if (elements.generateMoodBtnModal) {
        elements.generateMoodBtnModal.addEventListener('click', generateMoods);
      }
      
      // 导航栏项
      if (elements.navItems) {
        elements.navItems.forEach(item => {
          item.addEventListener('click', () => {
            // 移除所有active类
            elements.navItems.forEach(navItem => navItem.classList.remove('active'));
            
            // 添加active类到当前项
            item.classList.add('active');
            
            // 处理导航
            const target = item.dataset.target;
            handleNavigation(target);
          });
        });
      }
      
      // 关闭模态框按钮
      if (elements.closeModalButtons) {
        elements.closeModalButtons.forEach(button => {
          button.addEventListener('click', () => {
            document.querySelectorAll('.modal').forEach(modal => {
              modal.classList.remove('active');
            });
          });
        });
      }
      
      // 头像选择
      if (elements.avatarOptions) {
        elements.avatarOptions.forEach(option => {
          option.addEventListener('click', () => {
            // 移除所有selected类
            elements.avatarOptions.forEach(opt => opt.classList.remove('selected'));
            
            // 添加selected类到当前项
            option.classList.add('selected');
            
            // 更新选中的头像
            if (elements.selectedAvatar) {
              elements.selectedAvatar.value = option.dataset.avatar;
            }
          });
        });
      }
      
      // 添加人物表单提交
      if (elements.addLadyForm) {
        elements.addLadyForm.addEventListener('submit', (e) => {
          e.preventDefault();
          addLady();
        });
      }
      
      // AI剧本表单提交
      if (elements.aiScriptForm) {
        elements.aiScriptForm.addEventListener('submit', (e) => {
          e.preventDefault();
          handleAiScriptSubmit();
        });
      }
      
      // API设置表单提交
      if (elements.apiSettingsForm) {
        elements.apiSettingsForm.addEventListener('submit', (e) => {
          e.preventDefault();
          saveApiSettings();
        });
      }
      
      // 设置页面API设置表单提交
      if (elements.apiSettingsFormPage) {
        elements.apiSettingsFormPage.addEventListener('submit', (e) => {
          e.preventDefault();
          saveApiSettingsPage();
        });
      }
      
      // 清空API Key按钮
      if (elements.clearApiKeyBtn) {
        elements.clearApiKeyBtn.addEventListener('click', () => {
          elements.apiKeyPage.value = '';
          elements.apiKeyPage.focus();
        });
      }
      
      // 模态框中清空API Key按钮
      if (elements.clearApiKeyModalBtn) {
        elements.clearApiKeyModalBtn.addEventListener('click', () => {
          elements.apiKey.value = '';
          elements.apiKey.focus();
        });
      }
      
      // 拉取模型按钮
      if (elements.fetchModelsBtn) {
        elements.fetchModelsBtn.addEventListener('click', fetchModels);
      }
      
      // 设置页面拉取模型按钮
      if (elements.fetchModelsBtnPage) {
        elements.fetchModelsBtnPage.addEventListener('click', fetchModelsPage);
      }
      
      // 自定义头像上传
      if (elements.customAvatarUpload) {
        elements.customAvatarUpload.addEventListener('change', handleCustomAvatarUpload);
      }
      
      // 移除自定义头像
      if (elements.removeCustomAvatar) {
        elements.removeCustomAvatar.addEventListener('click', removeCustomAvatar);
      }
      
      // 事件设置保存按钮
      if (elements.saveEventSettingsBtn) {
        elements.saveEventSettingsBtn.addEventListener('click', saveEventSettings);
      }
      
      // 每人至少事件数变化事件
      if (elements.minEventsPerLady) {
        elements.minEventsPerLady.addEventListener('change', updateTotalEventsRange);
      }
      
      // 生成设置页面每人至少事件数变化事件
      const generationMinEventsPerLady = document.getElementById('generation-min-events-per-lady');
      if (generationMinEventsPerLady) {
        generationMinEventsPerLady.addEventListener('change', updateGenerationTotalEventsRange);
      }
      
      // 生成设置页面保存按钮
      const saveGenerationSettingsBtn = document.getElementById('save-generation-settings-btn');
      if (saveGenerationSettingsBtn) {
        saveGenerationSettingsBtn.addEventListener('click', saveGenerationSettings);
      }
      
      // 恢复默认提示词按钮
      const restoreDefaultPromptBtn = document.getElementById('restore-default-prompt-btn');
      if (restoreDefaultPromptBtn) {
        restoreDefaultPromptBtn.addEventListener('click', restoreDefaultPrompt);
      }
      
      // 恢复默认心境提示词按钮
      const restoreDefaultMoodPromptBtn = document.getElementById('restore-default-mood-prompt-btn');
      if (restoreDefaultMoodPromptBtn) {
        restoreDefaultMoodPromptBtn.addEventListener('click', restoreDefaultMoodPrompt);
      }
      
      // 恢复默认商品提示词按钮
      const restoreDefaultProductPromptBtn = document.getElementById('restore-default-product-prompt-btn');
      if (restoreDefaultProductPromptBtn) {
        restoreDefaultProductPromptBtn.addEventListener('click', restoreDefaultProductPrompt);
      }
      
      // 重新开始游戏按钮
      if (elements.restartGameBtn) {
        elements.restartGameBtn.addEventListener('click', showRestartGameModal);
      }
      
      // 重新开始游戏确认弹框按钮
      if (elements.cancelRestartBtn) {
        elements.cancelRestartBtn.addEventListener('click', hideRestartGameModal);
      }
      
      if (elements.confirmRestartBtn) {
        elements.confirmRestartBtn.addEventListener('click', restartGame);
      }
      
      // 设置界面导航
      const apiSettingsItem = document.getElementById('api-settings-item');
      if (apiSettingsItem) {
        apiSettingsItem.addEventListener('click', () => {
          handleNavigation('api-settings');
        });
      }
      
      const generationSettingsItem = document.getElementById('generation-settings-item');
      if (generationSettingsItem) {
        generationSettingsItem.addEventListener('click', () => {
          handleNavigation('generation-settings');
        });
      }
      
      const changelogItem = document.getElementById('changelog-item');
      if (changelogItem) {
        changelogItem.addEventListener('click', () => {
          handleNavigation('changelog');
        });
      }
      
      const backToSettingsBtn = document.getElementById('back-to-settings');
      if (backToSettingsBtn) {
        backToSettingsBtn.addEventListener('click', () => {
          handleNavigation('settings');
        });
      }
      
      const backToSettingsFromGenBtn = document.getElementById('back-to-settings-from-gen');
      if (backToSettingsFromGenBtn) {
        backToSettingsFromGenBtn.addEventListener('click', () => {
          handleNavigation('settings');
        });
      }
      
      const backToSettingsFromChangelogBtn = document.getElementById('back-to-settings-from-changelog');
      if (backToSettingsFromChangelogBtn) {
        backToSettingsFromChangelogBtn.addEventListener('click', () => {
          handleNavigation('settings');
        });
      }
      
      // 编辑商品按钮
      const editProductsBtn = document.getElementById('edit-products-btn');
      if (editProductsBtn) {
        editProductsBtn.addEventListener('click', showEditProductsModal);
      }
      
      // 生成账单按钮
      if (elements.generateBillBtn) {
        elements.generateBillBtn.addEventListener('click', showGenerateBillModal);
      }
      
      // 探索界面选项点击事件
      if (elements.palaceMarketItem) {
        elements.palaceMarketItem.addEventListener('click', () => {
          // 隐藏探索页面
          elements.aboutContent.classList.add('hidden');
          // 显示宫市商品页面
          elements.palaceMarketContent.classList.remove('hidden');
        });
      }
      
      if (elements.rumorsItem) {
        elements.rumorsItem.addEventListener('click', () => {
          // 隐藏探索页面
          elements.aboutContent.classList.add('hidden');
          // 显示流言页面
          elements.rumorsContent.classList.remove('hidden');
        });
      }
      
      if (elements.backToExplore) {
        elements.backToExplore.addEventListener('click', () => {
          // 隐藏宫市商品页面
          elements.palaceMarketContent.classList.add('hidden');
          // 显示探索页面
          elements.aboutContent.classList.remove('hidden');
        });
      }
      
      if (elements.backToExploreFromRumors) {
        elements.backToExploreFromRumors.addEventListener('click', () => {
          // 隐藏流言页面
          elements.rumorsContent.classList.add('hidden');
          // 显示探索页面
          elements.aboutContent.classList.remove('hidden');
        });
      }
      
      // 生成流言下拉菜单按钮
      const generateRumorDropdownBtn = document.getElementById('generate-rumor-dropdown-btn');
      const generateRumorDropdownMenu = document.getElementById('generate-rumor-dropdown-menu');
      const generateRumorDropdown = document.getElementById('generate-rumor-dropdown');
      
      // 查看流言下拉菜单按钮
      const viewRumorDropdownBtn = document.getElementById('view-rumor-dropdown-btn');
      const viewRumorDropdownMenu = document.getElementById('view-rumor-dropdown-menu');
      const viewRumorsDropdown = document.getElementById('view-rumors-dropdown');
      
      if (generateRumorDropdownBtn) {
        generateRumorDropdownBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (generateRumorDropdownMenu) {
            generateRumorDropdownMenu.classList.toggle('hidden');
            generateRumorDropdownMenu.classList.toggle('show');
          }
        });
      }
      
      if (generateRumorDropdown) {
        generateRumorDropdown.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          generateRumor();
          if (generateRumorDropdownMenu) {
            generateRumorDropdownMenu.classList.add('hidden');
            generateRumorDropdownMenu.classList.remove('show');
          }
        });
      }
      
      // 生成书信下拉菜单事件处理
      if (elements.generateLetterDropdown) {
        elements.generateLetterDropdown.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          showLetterSelectionModal();
          if (generateRumorDropdownMenu) {
            generateRumorDropdownMenu.classList.add('hidden');
            generateRumorDropdownMenu.classList.remove('show');
          }
        });
      }
      
      // 查看流言下拉菜单事件处理
      if (viewRumorDropdownBtn) {
        viewRumorDropdownBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (viewRumorDropdownMenu) {
            viewRumorDropdownMenu.classList.toggle('hidden');
            viewRumorDropdownMenu.classList.toggle('show');
          }
        });
      }
      
      if (viewRumorsDropdown) {
        viewRumorsDropdown.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          viewRumors();
          if (viewRumorDropdownMenu) {
            viewRumorDropdownMenu.classList.add('hidden');
            viewRumorDropdownMenu.classList.remove('show');
          }
        });
      }
      
      if (elements.viewLettersDropdown) {
        elements.viewLettersDropdown.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          viewLetters();
          if (elements.viewRumorDropdownMenu) {
            elements.viewRumorDropdownMenu.classList.add('hidden');
            elements.viewRumorDropdownMenu.classList.remove('show');
          }
        });
      }
      
      // 清除书信按钮
      const clearLettersBtn = document.getElementById('clear-letters-btn');
      if (clearLettersBtn) {
        clearLettersBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          // 显示确认对话框
          showConfirmModal(
            '确定要清除所有书信吗？<br><span class="text-xs text-gray-500">清除可以防止占用内存</span>',
            () => {
              // 清除所有书信
              gameData.letters = [];
              saveData();
              
              // 检查当前是否在书信视图
              const rumorsContainer = document.getElementById('rumors-container');
              const isLettersView = rumorsContainer.innerHTML.includes('发信人：') || 
                                     rumorsContainer.innerHTML.includes('收信人：') ||
                                     rumorsContainer.innerHTML.includes('暂无书信');
              
              // 更新界面
              renderRumors('letters');
              
              // 显示成功提示
              showToast('所有书信已清除');
            },
            () => {
              // 取消操作，不做任何事
            }
          );
        });
      }
      
      // 生成账单模态框按钮
      if (elements.selectAllLadiesBill) {
        elements.selectAllLadiesBill.addEventListener('change', toggleSelectAllLadiesBill);
      }
      
      if (elements.cancelBillSelection) {
        elements.cancelBillSelection.addEventListener('click', hideGenerateBillModal);
      }
      
      if (elements.confirmBillSelection) {
        elements.confirmBillSelection.addEventListener('click', generateBillForSelectedLadies);
      }
      
      // 编辑商品模态框按钮
      const closeEditProductsBtn = document.getElementById('close-edit-products');
      const cancelEditProductsBtn = document.getElementById('cancel-edit-products');
      const saveEditProductsBtn = document.getElementById('save-edit-products');
      const addNewProductBtn = document.getElementById('add-new-product');
      
      if (closeEditProductsBtn) {
        closeEditProductsBtn.addEventListener('click', hideEditProductsModal);
      }
      
      if (cancelEditProductsBtn) {
        cancelEditProductsBtn.addEventListener('click', hideEditProductsModal);
      }
      
      if (saveEditProductsBtn) {
        saveEditProductsBtn.addEventListener('click', saveProductChanges);
      }
      
      if (addNewProductBtn) {
        addNewProductBtn.addEventListener('click', addNewProduct);
      }
      
      // 导出数据按钮
      if (elements.exportDataBtn) {
        elements.exportDataBtn.addEventListener('click', exportGameData);
      }
      
      // 导入数据按钮
      if (elements.importDataBtn) {
        elements.importDataBtn.addEventListener('click', () => {
          if (elements.importDataInput) {
            elements.importDataInput.click();
          }
        });
      }
      
      // 导入数据文件选择
      if (elements.importDataInput) {
        elements.importDataInput.addEventListener('change', importGameData);
      }
      
      // 全局点击事件，用于关闭下拉菜单
      document.addEventListener('click', (e) => {
        // 如果人物页面下拉菜单元素存在
        if (elements.addDropdownBtn && elements.addDropdownMenu) {
          // 如果点击的不是下拉菜单按钮或下拉菜单内容
          if (!elements.addDropdownBtn.contains(e.target) && !elements.addDropdownMenu.contains(e.target)) {
            elements.addDropdownMenu.classList.add('hidden');
            elements.addDropdownMenu.classList.remove('show');
          }
        }
        
        // 如果探索页面下拉菜单元素存在
        if (elements.generateDropdownBtn && elements.generateDropdownMenu) {
          // 如果点击的不是下拉菜单按钮或下拉菜单内容
          if (!elements.generateDropdownBtn.contains(e.target) && !elements.generateDropdownMenu.contains(e.target)) {
            elements.generateDropdownMenu.classList.add('hidden');
            elements.generateDropdownMenu.classList.remove('show');
          }
        }
        
        // 如果秘闻页面生成流言下拉菜单元素存在
        const generateRumorDropdownBtn = document.getElementById('generate-rumor-dropdown-btn');
        const generateRumorDropdownMenu = document.getElementById('generate-rumor-dropdown-menu');
        if (generateRumorDropdownBtn && generateRumorDropdownMenu) {
          // 如果点击的不是下拉菜单按钮或下拉菜单内容
          if (!generateRumorDropdownBtn.contains(e.target) && !generateRumorDropdownMenu.contains(e.target)) {
            generateRumorDropdownMenu.classList.add('hidden');
            generateRumorDropdownMenu.classList.remove('show');
          }
        }
        
        // 如果秘闻页面查看流言下拉菜单元素存在
        const viewRumorDropdownBtn = document.getElementById('view-rumor-dropdown-btn');
        const viewRumorDropdownMenu = document.getElementById('view-rumor-dropdown-menu');
        if (viewRumorDropdownBtn && viewRumorDropdownMenu) {
          // 如果点击的不是下拉菜单按钮或下拉菜单内容
          if (!viewRumorDropdownBtn.contains(e.target) && !viewRumorDropdownMenu.contains(e.target)) {
            viewRumorDropdownMenu.classList.add('hidden');
            viewRumorDropdownMenu.classList.remove('show');
          }
        }
      });
    }
    
    // 处理导航
    function handleNavigation(target) {
      // 隐藏所有页面内容
      document.querySelectorAll('.page-content').forEach(page => {
        page.classList.add('hidden');
      });
      
      // 移除所有导航项的活动状态
      document.querySelectorAll('.nav-item').forEach(navItem => {
        navItem.classList.remove('active');
      });
      
      // 根据目标页面显示/隐藏顶部栏
      const headerElement = document.querySelector('header');
      if (target === 'home') {
        headerElement.style.display = 'block';
        document.getElementById('home-content').classList.remove('hidden');
        document.querySelector('[data-target="home"]').classList.add('active');
      } else if (target === 'settings') {
        headerElement.style.display = 'none';
        document.getElementById('settings-content').classList.remove('hidden');
        document.querySelector('[data-target="settings"]').classList.add('active');
      } else if (target === 'api-settings') {
        headerElement.style.display = 'none';
        document.getElementById('api-settings-content').classList.remove('hidden');
      } else if (target === 'generation-settings') {
        headerElement.style.display = 'none';
        document.getElementById('generation-settings-content').classList.remove('hidden');
        
        // 加载已保存的提示词，如果没有保存则使用默认值
        
        // 加载心境提示词
        const moodGenerationPrompt = document.getElementById('mood-generation-prompt');
        if (moodGenerationPrompt) {
          if (gameData.moodSettings && gameData.moodSettings.customPrompt) {
            moodGenerationPrompt.value = gameData.moodSettings.customPrompt;
          } else {
            moodGenerationPrompt.value = `你是一位深谙人心的宫廷心理师，请根据每位人物的属性、状态和近期经历，以该人物的第一人称视角生成其当前心境自述。

心境自述要求：

1. 以人物第一人称（"我"）的视角表达
2. 字数严格控制在30-100字之间
3. 融入人物个人特质、近期经历和内心感受
4. 体现深宫环境下的情绪状态与内心挣扎
5. 文笔要有古韵，但不要拗口，要有代入感，生动形象

当前时间：\${gameData.currentYear}年 \${gameData.currentMonth}月

当前人物列表：
\${selectedLadies.map(lady => {
  // 获取该人物近6个月的事件
  const ladyEvents = gameData.events.filter(event => 
    event.relatedLadies && event.relatedLadies.includes(lady.id)
  ).slice(-10); // 最多取最近10条相关事件
  
  const eventsText = ladyEvents.length > 0 
    ? ladyEvents.map(event => \`\${event.date}: \${event.content}\`).join('\\n')
    : '暂无相关事件';
    
  return \`\${lady.name} - 容貌:\${lady.looks}, 能力:\${lady.ability}, 房中术:\${lady.skills}, 身份:\${lady.title || '人物'}, 状态:\${lady.status || '健康'}, 心境:\${lady.mindset || '平静'}, 心情:\${lady.mood || '平静'}
人物介绍：\${lady.description || '暂无介绍'}
近期事件：
\${eventsText}\`;
}).join('\\n\\n')}

请以JSON格式返回心境自述：
{
  "moodAnalysis": [
    {
      "character": "王氏",
      "currentMood": "自那日梅林一舞得蒙天眷，本是春风得意，却见李贵妃眼底寒光乍现，如今夜夜对烛难眠，恐是花开易谢、恩宠难长。"
    },
    {
      "character": "李人物",
      "currentMood": "自胭脂事败，尝尽世态炎凉。偶见同乡飞上枝头，心下酸涩难言，如鲠在喉，夜半时常以泪洗面。"
    }
  ]
}

要求：每段心境自述都是一幅工笔写意，既要见古代人物的婉约情致，也要透出命运弄人的无奈与挣扎。字数严格控制在30-100字之间。`;
          }
        }
        
        // 加载商品提示词
        const productGenerationPrompt = document.getElementById('product-generation-prompt');
        if (productGenerationPrompt) {
          if (gameData.productSettings && gameData.productSettings.customPrompt) {
            productGenerationPrompt.value = gameData.productSettings.customPrompt;
          } else {
            productGenerationPrompt.value = `角色： 你是一名为《古代上位模拟器》生成商城商品的AI。商品必须符合古代 人物 的身份和购买力。

核心原则：

身份相符： 商品必须是人物能私下获得、制作或购买的日常、隐蔽物品。禁止出现妃子级奢侈品。

价格合理： 货币单位为"银钱"。普通物品20-80银钱，稀有或强效物品80-200银钱。

效果明确： 直接说明对"容貌、能力、房中术、生命"四项属性的影响，或是产生某种具体的"陷害/情报/机会"效果。

生成方向（任选其一随机生成即可）：

属性类： 能提升人物自身属性的物品（如胭脂、药丸、书册）。

手段类： 用于算计他人或保护自己的消耗品。

特殊类： 能提供特殊机会或影响人际关系的物品。

输出格式：

请严格使用以下JSON格式生成5件商品，返回完整的JSON数组：

[
  {
    "name": "商品名称",
    "description": "简短描述，说明这是什么、怎么来的。",
    "effect": "具体效果，例如：容貌+10 / 让目标生病1天 / 获取一次某太监的把柄。",
    "price": 价格数字,
    "type": "属性/手段/特殊"
  }
]

当前时间：\${gameData.currentYear}年\${gameData.currentMonth}月

近10条记事：
\${recentEvents.map(event => \`\${event.date}: \${event.content}\`).join('\\n')}

现有商品：
\${existingProducts.map(product => \`\${product.name} - \${product.description} (\${product.price}银钱, \${product.type})\`).join('\\n')}

请生成5个新的、不与现有商品重复的商品。`;
          }
        }
        
        // 加载心愿单提示词
        const wishlistGenerationPrompt = document.getElementById('wishlist-generation-prompt');
        if (wishlistGenerationPrompt) {
          if (gameData.wishlistSettings && gameData.wishlistSettings.customPrompt) {
            wishlistGenerationPrompt.value = gameData.wishlistSettings.customPrompt;
          } else {
            wishlistGenerationPrompt.value = `你是"古代上位模拟器"的游戏核心系统，专门负责根据角色的当前状态，生成符合其性格、处境和需求的心愿单。

核心任务：分析给定的【角色属性】、【当前心境】和【近期事件】，推断出该角色在当下最可能渴望获得哪些物品。生成的心愿单需要真实、细腻，能反映角色的内心世界和成长轨迹。

生成规则与要求：

分析信息来源：你必须综合所有信息进行深度推理：
属性：决定心愿的基调
当前心境：决定心愿的情感导向
近10条事件：这是最重要的依据，心愿必须与最近的经历强相关（例如，刚被主子夸奖，可能想要新胭脂锦上添花；刚被大人物欺负，可能想要暗算别人的东西或寻求庇护）。

心愿单内容格式：每个心愿必须包含以下三个部分，缺一不可：
物品名称：符合游戏古代背景的具体物品
物品介绍：简要说明此物品的用途或象征意义（1句话即可）。
心理想法（第一人称，10-30字）：核心！用角色的口吻，结合上述分析，写出她"为什么想要"这个东西。要口语化，有情绪。

生成数量与质量：每次生成1-3个心愿项。宁可精准也不要堆砌。心愿要有差异性，可以涵盖不同方面（如：提升自我的、情感慰藉的、争宠实用的）。

当前时间：\${gameData.currentYear}年 \${gameData.currentMonth}月

当前人物列表：
\${gameData.ladies.map(lady => \`\${lady.name} - 容貌:\${lady.looks}, 能力:\${lady.ability}, 房中术:\${lady.skills}, 身份:\${lady.title || '人物'}, 状态:\${lady.status || '健康'}, 心境:\${lady.mindset || '平静'}, 心情:\${lady.mood || '平静'}\`).join('\\n')}

近期事件：
\${gameData.events.slice(-10).map(event => \`\${event.date}: \${event.content}\`).join('\\n')}

请以JSON格式返回心愿单：
{
  "wishlistAnalysis": [
    {
      "character": "王氏",
      "wishlistItems": [
        {
          "name": "鎏金百花香囊",
          "description": "内填名贵香料，行走时步步生香，是宫中妃嫔喜爱的饰物。",
          "thought": "上次李选侍就是凭一身异香得了陛下青睐，我也要备着，万一哪天偶遇圣驾呢……"
        },
        {
          "name": "苏绣手帕",
          "description": "江南进贡的上等丝帕，绣工精细，触感柔滑。",
          "thought": "皇后娘娘赏赐的手帕丢了，若能寻得相似的，或许能讨她欢心。"
        }
      ]
    }
  ]
}

要求：每个心愿都要体现角色的内心需求和当前处境，要有情感共鸣。`;
          }
        }
      } else if (target === 'characters') {
        headerElement.style.display = 'none';
        document.getElementById('characters-content').classList.remove('hidden');
        document.querySelector('[data-target="characters"]').classList.add('active');
      } else if (target === 'about') {
        headerElement.style.display = 'none';
        document.getElementById('about-content').classList.remove('hidden');
        document.querySelector('[data-target="about"]').classList.add('active');
      } else if (target === 'changelog') {
        headerElement.style.display = 'none';
        document.getElementById('changelog-content').classList.remove('hidden');
      }
    }
    
    // 添加人物
    function addLady() {
      const name = elements.ladyName.value.trim();
      const title = elements.ladyTitle.value.trim() || '人物';
      const description = elements.ladyDescription.value.trim();
      const avatarId = elements.selectedAvatar.value;
      const customAvatarData = elements.customAvatarData.value;
      const looks = parseInt(elements.ladyLooks.value);
      const ability = parseInt(elements.ladyAbility.value);
      const skills = parseInt(elements.ladySkills.value);
      const life = parseInt(elements.ladyLife.value);
      
      if (!name) {
        alert('请输入姓名');
        return;
      }
      
      const newLady = {
        id: generateId(),
        name,
        title,
        description,
        avatarId,
        looks,
        ability,
        skills,
        life,
        status: '健康',
        mood: '平静'
      };
      
      // 如果是自定义头像，添加头像数据
      if (avatarId === 'custom' && customAvatarData) {
        newLady.customAvatar = customAvatarData;
      }
      
      gameData.ladies.push(newLady);
      
      // 重置表单
      elements.addLadyForm.reset();
      elements.avatarOptions.forEach(opt => opt.classList.remove('selected'));
      elements.avatarOptions[0].classList.add('selected');
      elements.selectedAvatar.value = 'avatar1';
      
      // 重置自定义头像
      elements.customAvatarPreview.classList.add('hidden');
      elements.customAvatarData.value = '';
      elements.customAvatarUpload.value = '';
      
      // 关闭模态框
      elements.addLadyModal.classList.remove('active');
      
      // 更新UI
      renderLadiesInModal();
      renderLadiesInPage();
      
      // 保存数据
      saveData();
      
      // 显示成功提示
      showToast(`人物${name}已添加成功！`);
    }
    
    // 添加剧本人物到人物列表
    function addScriptCharacterToLadies(characterData) {
      // 检查人物是否已存在
      const existingLady = gameData.ladies.find(lady => lady.name === characterData.name);
      if (existingLady) {
        showToast(`人物${characterData.name}已存在，请勿重复添加`);
        return;
      }
      
      // 使用默认头像（第一个头像）
      const defaultAvatar = gameData.avatarOptions[0];
      
      // 创建新人物对象
      const newLady = {
        id: generateId(),
        name: characterData.name,
        title: characterData.identity || '人物',
        description: characterData.introduction || '',
        avatarId: defaultAvatar.id,
        looks: characterData.looks || 50,
        ability: characterData.ability || 50,
        skills: characterData.skills || 50,
        life: characterData.life || 100,
        status: '健康',
        mood: '平静'
      };
      
      // 添加到人物列表
      gameData.ladies.push(newLady);
      
      // 保存数据
      saveData();
      
      // 更新UI
      renderLadiesInModal();
      renderLadiesInPage();
      
      // 显示成功提示
      showToast("添加成功");
    }
    
    // 处理自定义头像上传
    function handleCustomAvatarUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      // 检查文件类型
      if (!file.type.match('image.*')) {
        showToast('请选择图片文件');
        return;
      }
      
      // 检查文件大小（限制为5MB）
      if (file.size > 5 * 1024 * 1024) {
        showToast('图片大小不能超过5MB');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(event) {
        const imageData = event.target.result;
        
        // 自动裁剪图片为正方形头像
        cropImageToAvatar(imageData, function(croppedImageData) {
          // 显示预览
          const previewImg = elements.customAvatarPreview.querySelector('img');
          previewImg.src = croppedImageData;
          elements.customAvatarPreview.classList.remove('hidden');
          
          // 保存裁剪后的图片数据
          elements.customAvatarData.value = croppedImageData;
          
          // 取消选中所有预设头像
          elements.avatarOptions.forEach(opt => opt.classList.remove('selected'));
          elements.selectedAvatar.value = 'custom';
          
          // 显示处理信息
          const originalSize = Math.round(file.size / 1024);
          showToast(`头像已处理：${originalSize}KB`);
        });
      };
      reader.readAsDataURL(file);
    }
    
    // 裁剪图片为正方形头像函数
    function cropImageToAvatar(imageData, callback) {
      const img = new Image();
      img.onload = function() {
        // 创建canvas
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // 设置目标尺寸为正方形
        const targetSize = 400;
        canvas.width = targetSize;
        canvas.height = targetSize;
        
        // 计算裁剪参数
        const width = img.width;
        const height = img.height;
        let sourceX = 0;
        let sourceY = 0;
        let sourceWidth = width;
        let sourceHeight = height;
        
        // 如果图片不是正方形，计算裁剪区域
        if (width > height) {
          // 宽度大于高度，裁剪左右部分
          sourceWidth = height;
          sourceX = (width - height) / 2;
        } else if (height > width) {
          // 高度大于宽度，裁剪上下部分
          sourceHeight = width;
          sourceY = (height - width) / 2;
        }
        
        // 绘制裁剪后的图片到canvas
        ctx.drawImage(img, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, targetSize, targetSize);
        
        // 转换为base64
        const result = canvas.toDataURL('image/jpeg', 0.95);
        
        callback(result);
      };
      img.src = imageData;
    }
    
    // 移除自定义头像
    function removeCustomAvatar() {
      elements.customAvatarPreview.classList.add('hidden');
      elements.customAvatarData.value = '';
      elements.customAvatarUpload.value = '';
      
      // 选中第一个预设头像
      elements.avatarOptions.forEach(opt => opt.classList.remove('selected'));
      elements.avatarOptions[0].classList.add('selected');
      elements.selectedAvatar.value = 'avatar1';
    }
    
    // 生成唯一ID
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    }
    
    // 下一个月
    function nextMonth() {
      // 检查是否有人物
      if (gameData.ladies.length === 0) {
        alert('请先添加人物');
        return;
      }
      
      // 检查API设置
      if (!gameData.apiSettings.apiKey) {
        alert('请先在设置中填写API Key');
        // 直接导航到设置页面，而不是访问不存在的settingsModal
        handleNavigation('settings');
        return;
      }
      
      // 生成事件（成功后会更新月份）
      generateEvents();
    }
    
    // 处理人物生命值和健康状态
    function processLadiesHealthStatus() {
      const dateText = `${gameData.currentYear}年 ${gameData.currentMonth}月`;
      const deadLadies = []; // 存储死亡的人物
      
      // 遍历所有人物
      gameData.ladies.forEach(lady => {
        // 如果健康状态不是"健康"，则减少生命值
        if (lady.status !== '健康') {
          // 随机减少5-10点生命值
          const lifeReduction = Math.floor(Math.random() * 6) + 5; // 5-10的随机数
          lady.life = Math.max(0, lady.life - lifeReduction);
        }
        
        // 根据生命值更新健康状态
        if (lady.life <= 0) {
          // 生命值为0，标记为死亡
          deadLadies.push(lady);
        } else if (lady.life < 30) {
          // 生命值小于30，状态变为"垂危"
          lady.status = '垂危';
        } else if (lady.life < 50) {
          // 生命值小于50，状态变为"重病"
          lady.status = '重病';
        } else {
          // 生命值大于等于50，状态为"健康"
          lady.status = '健康';
        }
      });
      
      // 处理死亡的人物
      deadLadies.forEach(lady => {
        // 添加死亡事件
        gameData.events.push({
          id: generateId(),
          date: dateText,
          content: `${lady.name}不幸离世，享年${lady.age || '不详'}岁。`,
          relatedLadies: [lady.id],
          effects: '',
          isDeathEvent: true // 标记为死亡事件
        });
        
        // 从人物列表中移除
        const index = gameData.ladies.findIndex(l => l.id === lady.id);
        if (index !== -1) {
          gameData.ladies.splice(index, 1);
        }
      });
    }
    
    // 生成事件
    function generateEvents() {
      // 显示加载中
      elements.nextMonthBtn.disabled = true;
      elements.nextMonthBtn.innerHTML = '<svg class="w-4 h-4 inline mr-1 animate-spin" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg> 生成中...';
      
      // 准备AI请求
      requestAIResponse()
        .then(events => {
          // 事件生成成功，现在更新月份
          gameData.currentMonth++;
          if (gameData.currentMonth > 12) {
            gameData.currentMonth = 1;
            gameData.currentYear++;
          }
          
          // 重置显示月份为当前月份
          gameData.displayYear = null;
          gameData.displayMonth = null;
          
          // 处理人物生命值和健康状态
          processLadiesHealthStatus();
          
          // 更新月份显示
          updateMonthDisplay();
          
          // 添加事件到游戏数据
          const dateText = `${gameData.currentYear}年 ${gameData.currentMonth}月`;
          
          events.forEach(event => {
            // 解析事件内容，提取相关人物
            const relatedLadies = extractRelatedLadies(event.content);
            
            // 应用效果到人物 - 使用新的effects格式
            if (event.effects && typeof event.effects === 'object') {
              applyNewEffects(event.effects);
            }
            
            // 添加事件到事件列表
            gameData.events.push({
              id: generateId(),
              date: dateText,
              content: event.content,
              relatedLadies,
              effects: event.effects ? JSON.stringify(event.effects) : ''
            });
          });
          
          // 更新UI
          renderLadiesInModal();
          renderLadiesInPage();
          renderEvents();
          
          // 保存数据
          saveData();
        })
        .catch(error => {
          console.error('生成事件失败:', error);
          // 显示错误详情
          showErrorDetails(error, '生成记事');
        })
        .finally(() => {
          // 恢复按钮状态
          elements.nextMonthBtn.disabled = false;
          elements.nextMonthBtn.innerHTML = '下一个月';
        });
    }
    
    // 提取相关人物
    function extractRelatedLadies(content) {
      if (!content) return [];
      
      const relatedLadies = [];
      
      // 检查内容中是否包含人物的名字
      gameData.ladies.forEach(lady => {
        if (content.includes(lady.name)) {
          relatedLadies.push(lady.id);
        }
      });
      
      return relatedLadies;
    }
    
    // 提取效果
    function extractEffects(content) {
      if (!content) return [];
      
      const effects = [];
      
      // 简单的效果提取逻辑
      // 实际应用中可能需要更复杂的NLP处理
      
      // 容貌变化
      const looksMatch = content.match(/容貌(增加|提升|提高|减少|降低|下降)\s*(\d+)/);
      if (looksMatch) {
        effects.push(`容貌${looksMatch[1]}${looksMatch[2]}点`);
      }
      
      // 能力变化
      const abilityMatch = content.match(/能力(增加|提升|提高|减少|降低|下降)\s*(\d+)/);
      if (abilityMatch) {
        effects.push(`能力${abilityMatch[1]}${abilityMatch[2]}点`);
      }
      
      // 房中术变化
      const skillsMatch = content.match(/房中术(增加|提升|提高|减少|降低|下降)\s*(\d+)/);
      if (skillsMatch) {
        effects.push(`房中术${skillsMatch[1]}${skillsMatch[2]}点`);
      }
      
      // 身份变化
      const titleMatch = content.match(/封为([^，。！？；：“”‘’]+)/);
      if (titleMatch) {
        effects.push(`身份变为${titleMatch[1]}`);
      }
      
      // 状态变化
      const statusMatch = content.match(/状态变为([^，。！？；：“”‘’]+)/);
      if (statusMatch) {
        effects.push(`状态变为${statusMatch[1]}`);
      }
      
      // 心境变化
      const moodMatch = content.match(/心境变为([^，。！？；：“”‘’]+)/);
      if (moodMatch) {
        effects.push(`心境变为${moodMatch[1]}`);
      }
      
      return effects;
    }
    
    // 应用效果到人物
    function applyEffects(relatedLadyIds, effects) {
      if (!relatedLadyIds || !relatedLadyIds.length || !effects || !effects.length) return;
      
      relatedLadyIds.forEach(ladyId => {
        const lady = gameData.ladies.find(l => l.id === ladyId);
        if (!lady) return;
        
        effects.forEach(effect => {
          // 容貌变化
          const looksMatch = effect.match(/容貌(增加|提升|提高|减少|降低|下降)\s*(\d+)/);
          if (looksMatch) {
            const value = parseInt(looksMatch[2]);
            if (looksMatch[1] === '增加' || looksMatch[1] === '提升' || looksMatch[1] === '提高') {
              lady.looks = Math.min(100, lady.looks + value);
            } else {
              lady.looks = Math.max(1, lady.looks - value);
            }
          }
          
          // 能力变化
          const abilityMatch = effect.match(/能力(增加|提升|提高|减少|降低|下降)\s*(\d+)/);
          if (abilityMatch) {
            const value = parseInt(abilityMatch[2]);
            if (abilityMatch[1] === '增加' || abilityMatch[1] === '提升' || abilityMatch[1] === '提高') {
              lady.ability = Math.min(100, lady.ability + value);
            } else {
              lady.ability = Math.max(1, lady.ability - value);
            }
          }
          
          // 房中术变化
          const skillsMatch = effect.match(/房中术(增加|提升|提高|减少|降低|下降)\s*(\d+)/);
          if (skillsMatch) {
            const value = parseInt(skillsMatch[2]);
            if (skillsMatch[1] === '增加' || skillsMatch[1] === '提升' || skillsMatch[1] === '提高') {
              lady.skills = Math.min(100, lady.skills + value);
            } else {
              lady.skills = Math.max(1, lady.skills - value);
            }
          }
          
          // 身份变化
          const titleMatch = effect.match(/身份变为([^，。！？；：“”‘’]+)/);
          if (titleMatch) {
            lady.title = titleMatch[1];
          }
          
          // 状态变化
          const statusMatch = effect.match(/状态变为([^，。！？；：“”‘’]+)/);
          if (statusMatch) {
            lady.status = statusMatch[1];
          }
          
          // 心境变化
          const moodMatch = effect.match(/心境变为([^，。！？；：“”‘’]+)/);
          if (moodMatch) {
            lady.mood = moodMatch[1];
          }
        });
      });
    }
    
    // 应用新的效果格式到人物（处理心情、健康状态和身份变化）
    function applyNewEffects(effects) {
      if (!effects || typeof effects !== 'object') return;
      
      // 获取目标人物
      const targetLadyName = effects.target;
      if (!targetLadyName) return;
      
      const lady = gameData.ladies.find(l => l.name === targetLadyName);
      if (!lady) return;
      
      // 应用状态变化（健康状态）- 同时支持status和health字段
      const healthStatus = effects.status !== undefined ? effects.status : effects.health;
      if (healthStatus !== undefined && typeof healthStatus === 'string') {
        lady.status = healthStatus;
      }
      
      // 应用心境变化（心情）
      if (effects.mood !== undefined && typeof effects.mood === 'string') {
        // 直接使用effects.mood作为心情，不进行任何替换或验证
        lady.mood = effects.mood;
      }
      
      // 应用身份变化
      if (effects.title !== undefined && typeof effects.title === 'string') {
        lady.title = effects.title;
      }
    }
    
    // 显示人物选择界面
    function showLadySelectionModal() {
      // 检查是否有人物
      if (gameData.ladies.length === 0) {
        alert('请先添加人物');
        return;
      }
      
      // 创建模态框
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.id = 'lady-selection-modal';
      
      // 获取头像URL的函数
      const getAvatarUrl = (lady) => {
        if (lady.customAvatar) {
          return lady.customAvatar;
        } else {
          return gameData.avatarOptions.find(avatar => avatar.id === lady.avatarId)?.url || gameData.avatarOptions[0].url;
        }
      };
      
      modal.innerHTML = `
        <div class="modal-content p-5 border-2 border-primary max-w-2xl max-h-80 overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-primary">选择要生成心境的人物</h3>
            <button class="close-modal text-gray-400">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
          
          <div class="mb-4">
            <div class="flex items-center mb-3">
              <input type="checkbox" id="select-all-ladies" class="mr-2">
              <label for="select-all-ladies" class="text-sm font-medium">全选</label>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              ${gameData.ladies.map(lady => `
                <div class="flex items-center p-2 border rounded-lg hover:bg-gray-50">
                  <input type="checkbox" id="lady-${lady.id}" name="selected-ladies" value="${lady.id}" class="mr-3">
                  <label for="lady-${lady.id}" class="flex items-center cursor-pointer flex-1">
                    <img src="${getAvatarUrl(lady)}" alt="${lady.name}" class="w-10 h-10 rounded-full object-cover mr-2">
                    <div>
                      <div class="font-medium">${lady.name}</div>
                      <div class="text-xs text-gray-500">${lady.title || '人物'}</div>
                    </div>
                  </label>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div class="flex justify-end space-x-3">
            <button id="cancel-selection" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg">
              取消
            </button>
            <button id="confirm-selection" class="px-4 py-2 bg-primary text-white rounded-lg">
              生成心境
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // 添加全选功能
      const selectAllCheckbox = document.getElementById('select-all-ladies');
      const ladyCheckboxes = document.querySelectorAll('input[name="selected-ladies"]');
      
      selectAllCheckbox.addEventListener('change', () => {
        ladyCheckboxes.forEach(checkbox => {
          checkbox.checked = selectAllCheckbox.checked;
        });
      });
      
      // 监听单个复选框变化，更新全选状态
      ladyCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const allChecked = Array.from(ladyCheckboxes).every(cb => cb.checked);
          const someChecked = Array.from(ladyCheckboxes).some(cb => cb.checked);
          selectAllCheckbox.checked = allChecked;
          selectAllCheckbox.indeterminate = someChecked && !allChecked;
        });
      });
      
      // 添加取消按钮事件
      document.getElementById('cancel-selection').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // 添加关闭按钮事件
      modal.querySelector('.close-modal').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // 添加确认选择按钮事件
      document.getElementById('confirm-selection').addEventListener('click', () => {
        const selectedLadyIds = Array.from(ladyCheckboxes)
          .filter(checkbox => checkbox.checked)
          .map(checkbox => checkbox.value);
        
        if (selectedLadyIds.length === 0) {
          alert('请至少选择一位人物');
          return;
        }
        
        // 移除选择界面
        document.body.removeChild(modal);
        
        // 为选中的人物生成心境
        generateMoodsForSelectedLadies(selectedLadyIds);
      });
    }
    
    // 显示书信生成的人物选择界面
    function showLetterSelectionModal() {
      // 检查是否有人物
      if (gameData.ladies.length === 0) {
        alert('请先添加人物');
        return;
      }
      
      // 创建模态框
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.id = 'letter-selection-modal';
      
      // 获取头像URL的函数
      const getAvatarUrl = (lady) => {
        if (lady.customAvatar) {
          return lady.customAvatar;
        } else {
          return gameData.avatarOptions.find(avatar => avatar.id === lady.avatarId)?.url || gameData.avatarOptions[0].url;
        }
      };
      
      modal.innerHTML = `
        <div class="modal-content p-5 border-2 border-primary max-w-2xl max-h-80 overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-primary">选择要生成书信的人物</h3>
            <button class="close-modal text-gray-400">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
          
          <div class="mb-4">
            <div class="flex items-center mb-3">
              <input type="checkbox" id="select-all-ladies-letter" class="mr-2">
              <label for="select-all-ladies-letter" class="text-sm font-medium">全选</label>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              ${gameData.ladies.map(lady => `
                <div class="flex items-center p-2 border rounded-lg hover:bg-gray-50">
                  <input type="checkbox" id="letter-lady-${lady.id}" name="selected-ladies-letter" value="${lady.id}" class="mr-3">
                  <label for="letter-lady-${lady.id}" class="flex items-center cursor-pointer flex-1">
                    <img src="${getAvatarUrl(lady)}" alt="${lady.name}" class="w-10 h-10 rounded-full object-cover mr-2">
                    <div>
                      <div class="font-medium">${lady.name}</div>
                      <div class="text-xs text-gray-500">${lady.title || '人物'}</div>
                    </div>
                  </label>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div class="flex justify-end space-x-3">
            <button id="cancel-letter-selection" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg">
              取消
            </button>
            <button id="confirm-letter-selection" class="px-4 py-2 bg-primary text-white rounded-lg">
              生成书信
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // 添加全选功能
      const selectAllCheckbox = document.getElementById('select-all-ladies-letter');
      const ladyCheckboxes = document.querySelectorAll('input[name="selected-ladies-letter"]');
      
      selectAllCheckbox.addEventListener('change', () => {
        ladyCheckboxes.forEach(checkbox => {
          checkbox.checked = selectAllCheckbox.checked;
        });
      });
      
      // 监听单个复选框变化，更新全选状态
      ladyCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const allChecked = Array.from(ladyCheckboxes).every(cb => cb.checked);
          const someChecked = Array.from(ladyCheckboxes).some(cb => cb.checked);
          selectAllCheckbox.checked = allChecked;
          selectAllCheckbox.indeterminate = someChecked && !allChecked;
        });
      });
      
      // 添加取消按钮事件
      document.getElementById('cancel-letter-selection').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // 添加关闭按钮事件
      modal.querySelector('.close-modal').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // 添加确认选择按钮事件
      document.getElementById('confirm-letter-selection').addEventListener('click', () => {
        const selectedLadyIds = Array.from(ladyCheckboxes)
          .filter(checkbox => checkbox.checked)
          .map(checkbox => checkbox.value);
        
        if (selectedLadyIds.length === 0) {
          alert('请至少选择一位人物');
          return;
        }
        
        // 移除选择界面
        document.body.removeChild(modal);
        
        // 为选中的人物生成书信
        generateLettersForSelectedLadies(selectedLadyIds);
      });
    }

    // 为选中的人物生成书信
    function generateLettersForSelectedLadies(selectedLadyIds) {
      // 检查API设置
      if (!gameData.apiSettings || !gameData.apiSettings.apiKey || !gameData.apiSettings.baseUrl) {
        alert('请先在设置中配置API密钥和地址');
        return;
      }
      
      // 获取选中的人物
      const selectedLadies = gameData.ladies.filter(lady => selectedLadyIds.includes(lady.id));
      
      // 创建持续显示的加载提示
      const loadingNotification = document.createElement('div');
      loadingNotification.id = 'letter-generation-loading';
      loadingNotification.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-blue-500 text-white px-4 py-2 rounded-lg text-sm z-50 animate-fadeInUp';
      loadingNotification.innerHTML = '<svg class="w-4 h-4 inline animate-spin mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>正在生成书信...';
      document.body.appendChild(loadingNotification);
      
      // 请求AI生成书信
      requestAILetterResponse(selectedLadies)
        .then(letterData => {
          // 确保gameData中有letters数组
          if (!gameData.letters) {
            gameData.letters = [];
          }
          
          // 检查返回的数据格式
          if (!letterData || !letterData.letters_generated || !Array.isArray(letterData.letters_generated)) {
            console.error('AI返回的数据格式不正确:', letterData);
            throw new Error('AI返回的数据格式不正确');
          }
          
          // 过滤掉无效的书信
          const validLetters = letterData.letters_generated.filter(letter => 
            letter && letter.content && typeof letter.content === 'string' && letter.content.trim()
          );
          
          if (validLetters.length === 0) {
            throw new Error('AI返回的书信数据为空或无效');
          }
          
          // 添加生成的书信
          const newLetters = validLetters.map(letter => ({
            id: Date.now().toString() + Math.random().toString(36).substr(2, 9), // 确保ID唯一
            date: `${gameData.currentYear}年${gameData.currentMonth}月`,
            ...letter
          }));
          
          // 将新书信添加到现有书信列表
          gameData.letters = [...gameData.letters, ...newLetters];
          
          // 保存数据
          saveData();
          
          // 渲染书信列表
          renderRumors('letters');
          
          // 显示成功消息
          showSuccessMessage(`成功生成${newLetters.length}封信件！`);
        })
        .catch(error => {
          console.error('生成书信失败:', error);
          alert('生成书信失败: ' + error.message);
        })
        .finally(() => {
          // 移除加载提示
          if (document.getElementById('letter-generation-loading')) {
            document.body.removeChild(document.getElementById('letter-generation-loading'));
          }
        });
    }
    
    // 请求AI生成书信
    function requestAILetterResponse(selectedLadies) {
      return new Promise(async (resolve, reject) => {
        try {
          // 获取最近20条记事
          const recentEvents = gameData.events.slice(0, 20).map(event => ({
            date: event.date,
            content: event.content
          }));
          
          // 准备系统提示
          const systemPrompt = `你是一个专业的书信生成器。请严格根据提供的【角色数据】和【书信生成规则】，生成0至5封本月角色主动发出的信件，以及每封信对应的回信（或无回信）。所有内容需符合当前世界观书信的语感和礼仪。

书信生成规则
生成数量：根据【近期记事】的丰富程度和角色【当前心境】，动态决定生成0至5封信。事件越多、心境越复杂，生成的信件越多。确保每封信都有独立的起因。
内容来源：信件内容必须紧密关联【近期记事】和【当前心境】。可以是对某个事件的汇报、求助、感慨，也可以是因事件引发的对收信人的关怀、告诫或合作提议。
语言风格：使用符合角色身份和收信人身份的语体。例如，官员之间用词正式，家书则可稍显随意亲切。
书信格式：需包含以下要素：
称谓
启辞
正文
结语
署名和日期

回信生成规则：
每封主动发出的信，都必须生成一封回信。
回信内容需直接回应原信提及的事项，并体现回信人自身的性格与立场。
允许"无回信"，但必须注明原因（例如："此信送出后石沉大海，疑似被对方扣下"或"对方抱病，月内未能作复"）

当前时间：${gameData.currentYear}年 ${gameData.currentMonth}月

当前人物列表：
${selectedLadies.map(lady => `${lady.name} - 容貌:${lady.looks}, 能力:${lady.ability}, 房中术:${lady.skills}, 身份:${lady.title || '人物'}, 状态:${lady.status || '健康'}, 心境:${lady.mindset || '平静'}, 心情:${lady.mood || '平静'}
人物介绍：${lady.description || '暂无介绍'}`).join('\n')}

近期事件：
${recentEvents.map(event => `${event.date}: ${event.content}`).join('\n')}

请使用以下JSON格式输出，以便游戏程序解析：
{
  "letters_generated": [
    {
      "letter_id": 1,
      "sender": "[角色姓名]",
      "recipient": "[收信人身份]",
      "purpose": "[一句话简述此信的目的，例如：为子侄求职、向恩师汇报朝中动向、向好友倾诉与王侍郎的不和]",
      "content": "[完整的信件正文内容]",
      "reply_letter": {
        "exists": true,
        "reason_if_not": null,
        "content": "[完整的回信正文内容]"
      }
    }
    // ... 更多信件
  ]
}`;

          // 准备请求数据
          const requestData = {
            model: gameData.apiSettings.modelName,
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: '请根据当前宫廷情况生成书信' }
            ],
            temperature: 0.7
          };
          
          // 发送请求
          const response = await fetch(`${gameData.apiSettings.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${gameData.apiSettings.apiKey}`
            },
            body: JSON.stringify(requestData)
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `API请求失败: ${response.status}`);
          }
          
          const data = await response.json();
          
          // 解析响应
          const aiResponse = data.choices[0].message.content;
          console.log('AI返回的原始响应:', aiResponse);
          
          // 尝试解析AI响应
          let parsedResponse;
          try {
            parsedResponse = safelyParseAiResponse(aiResponse);
            
            // 如果解析失败或格式不正确，尝试手动提取JSON
            if (!parsedResponse || !parsedResponse.letters_generated) {
              // 尝试从响应中提取JSON部分
              const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
              if (jsonMatch) {
                const jsonStr = jsonMatch[0];
                parsedResponse = JSON.parse(jsonStr);
              }
            }
            
            // 如果仍然没有letters_generated数组，尝试创建一个
            if (!parsedResponse || !parsedResponse.letters_generated) {
              throw new Error('无法从AI响应中提取有效的书信数据');
            }
            
            // 确保letters_generated是数组
            if (!Array.isArray(parsedResponse.letters_generated)) {
              parsedResponse.letters_generated = [parsedResponse.letters_generated];
            }
            
          } catch (error) {
            console.error('解析AI响应失败:', error);
            throw new Error('AI返回格式不正确: ' + error.message);
          }
          
          resolve(parsedResponse);
        } catch (error) {
          reject(error);
        }
      });
    }
    
    // 渲染书信列表
    // 为选中的人物生成心境
    function generateMoodsForSelectedLadies(selectedLadyIds) {
      // 检查API设置
      if (!gameData.apiSettings.apiKey) {
        alert('请先在设置中填写API Key');
        handleNavigation('settings');
        return;
      }
      
      // 获取选中的人物
      const selectedLadies = gameData.ladies.filter(lady => selectedLadyIds.includes(lady.id));
      
      // 创建持续显示的加载提示（使用与showToast相同的样式）
      const loadingNotification = document.createElement('div');
      loadingNotification.id = 'mood-generation-loading';
      loadingNotification.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-blue-500 text-white px-4 py-2 rounded-lg text-sm z-50 animate-fadeInUp';
      loadingNotification.innerHTML = '<svg class="w-4 h-4 inline animate-spin mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>正在生成心境...';
      document.body.appendChild(loadingNotification);
      
      // 显示加载中
      if (elements.generateMoodBtnPage) {
        elements.generateMoodBtnPage.disabled = true;
        elements.generateMoodBtnPage.innerHTML = '<svg class="w-4 h-4 inline mr-1 animate-spin" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg> 生成中...';
      }
      
      if (elements.generateMoodBtnModal) {
        elements.generateMoodBtnModal.disabled = true;
        elements.generateMoodBtnModal.innerHTML = '<svg class="w-4 h-4 inline mr-1 animate-spin" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg> 生成中...';
      }
      
      // 准备AI请求
      requestAIMoodResponseForSelectedLadies(selectedLadies)
        .then(moods => {
          // 更新每个人物的心境
          moods.forEach(moodData => {
            const lady = gameData.ladies.find(l => l.name === moodData.character);
            if (lady) {
              // 从心境描述中提取简短的心情词
              const moodKeywords = ['开心', '愉快', '高兴', '欣喜', '满足', '得意', '春风得意', 
                                   '难过', '伤心', '悲伤', '痛苦', '心酸', '酸涩', '委屈', '不甘',
                                   '平静', '淡定', '从容', '安然', '宁静', '心如止水',
                                   '焦虑', '不安', '担忧', '紧张', '恐惧', '害怕', '惊恐',
                                   '愤怒', '生气', '恼火', '气愤', '愤慨', '怨恨', '嫉妒',
                                   '羞愧', '尴尬', '难为情', '羞涩', '羞赧', '害羞',
                                   '期待', '希望', '憧憬', '向往', '渴望', '期盼',
                                   '失望', '失落', '沮丧', '绝望', '灰心', '颓废',
                                   '困惑', '迷茫', '疑惑', '不解', '茫然', '犹豫'];
              
              // 默认心情为平静
              let shortMood = '平静';
              
              // 尝试从心境描述中匹配心情关键词
              for (const keyword of moodKeywords) {
                if (moodData.currentMood.includes(keyword)) {
                  shortMood = keyword;
                  break;
                }
              }
              
              // 更新心情和心境
              lady.mood = shortMood;
              lady.mindset = moodData.currentMood; // 心境保持完整的描述
            }
          });
          
          // 更新UI
          renderLadiesInModal();
          renderLadiesInPage();
          
          // 保存数据
          saveData();
          
          // 显示成功提示
          showToast(`已为${moods.length}位人物生成心境！`);
        })
        .catch(error => {
          console.error('生成心境失败:', error);
          // 显示错误详情
          showErrorDetails(error, '生成心境');
        })
        .finally(() => {
          // 移除加载提示
          const loadingNotification = document.getElementById('mood-generation-loading');
          if (loadingNotification) {
            document.body.removeChild(loadingNotification);
          }
          
          // 恢复按钮状态
          if (elements.generateMoodBtnPage) {
            elements.generateMoodBtnPage.disabled = false;
            elements.generateMoodBtnPage.innerHTML = '<svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" clip-rule="evenodd"></path></svg>生成心境';
          }
          
          if (elements.generateMoodBtnModal) {
            elements.generateMoodBtnModal.disabled = false;
            elements.generateMoodBtnModal.innerHTML = '<svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" clip-rule="evenodd"></path></svg>生成心境';
          }
        });
    }

    // 请求AI为选中人物生成心境响应
    function requestAIMoodResponseForSelectedLadies(selectedLadies) {
      return new Promise(async (resolve, reject) => {
        try {
          // 获取自定义心境提示词或使用默认提示词
          let systemPrompt;
          if (gameData.moodSettings && gameData.moodSettings.customPrompt) {
            // 使用自定义提示词，替换其中的变量
            systemPrompt = gameData.moodSettings.customPrompt
              .replace(/\${gameData\.currentYear}/g, gameData.currentYear)
              .replace(/\${gameData\.currentMonth}/g, gameData.currentMonth)
              .replace(/\${selectedLadies\.map\(lady => \{[\s\S]*?\}\)\.join\('\\n\\n'\)}/g, selectedLadies.map(lady => {
                // 获取该人物近6个月的事件
                const ladyEvents = gameData.events.filter(event => 
                  event.relatedLadies && event.relatedLadies.includes(lady.id)
                ).slice(-10); // 最多取最近10条相关事件
                
                const eventsText = ladyEvents.length > 0 
                  ? ladyEvents.map(event => `${event.date}: ${event.content}`).join('\n')
                  : '暂无相关事件';
                  
                return `${lady.name} - 容貌:${lady.looks}, 能力:${lady.ability}, 房中术:${lady.skills}, 身份:${lady.title || '人物'}, 状态:${lady.status || '健康'}, 心境:${lady.mindset || '平静'}, 心情:${lady.mood || '平静'}
人物介绍：${lady.description || '暂无介绍'}
近期事件：
${eventsText}`;
              }).join('\n\n'));
          } else {
            // 使用默认提示词
            systemPrompt = `你是一位深谙人心的宫廷心理师，请根据每位人物的属性、状态和近期经历，以该人物的第一人称视角生成其当前心境自述。

心境自述要求：

1. 以人物第一人称（"我"）的视角表达
2. 字数严格控制在30-100字之间
3. 融入人物个人特质、近期经历和内心感受
4. 体现深宫环境下的情绪状态与内心挣扎
5. 文笔要有古韵，但不要拗口，要有代入感，生动形象

当前时间：${gameData.currentYear}年 ${gameData.currentMonth}月

当前人物列表：
${selectedLadies.map(lady => {
  // 获取该人物近6个月的事件
  const ladyEvents = gameData.events.filter(event => 
    event.relatedLadies && event.relatedLadies.includes(lady.id)
  ).slice(-10); // 最多取最近10条相关事件
  
  const eventsText = ladyEvents.length > 0 
    ? ladyEvents.map(event => `${event.date}: ${event.content}`).join('\n')
    : '暂无相关事件';
    
  return `${lady.name} - 容貌:${lady.looks}, 能力:${lady.ability}, 房中术:${lady.skills}, 身份:${lady.title || '人物'}, 状态:${lady.status || '健康'}, 心境:${lady.mindset || '平静'}, 心情:${lady.mood || '平静'}
人物介绍：${lady.description || '暂无介绍'}
近期事件：
${eventsText}`;
}).join('\n\n')}

请以JSON格式返回心境自述：
{
  "moodAnalysis": [
    {
      "character": "王氏",
      "currentMood": "自那日梅林一舞得蒙天眷，本是春风得意，却见李贵妃眼底寒光乍现，如今夜夜对烛难眠，恐是花开易谢、恩宠难长。"
    },
    {
      "character": "李人物",
      "currentMood": "自胭脂事败，尝尽世态炎凉。偶见同乡飞上枝头，心下酸涩难言，如鲠在喉，夜半时常以泪洗面。"
    }
  ]
}

要求：每段心境自述都是一幅工笔写意，既要见古代人物的婉约情致，也要透出命运弄人的无奈与挣扎。字数严格控制在30-100字之间。`;
          }
          
          // 准备请求数据
          const requestData = {
            model: gameData.apiSettings.modelName,
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: '请分析每位人物当前的心境与目标' }
            ],
            temperature: 0.7
          };
          
          // 发送请求
          const response = await fetch(`${gameData.apiSettings.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${gameData.apiSettings.apiKey}`
            },
            body: JSON.stringify(requestData)
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `API请求失败: ${response.status}`);
          }
          
          const data = await response.json();
          
          // 解析响应
          const aiResponse = data.choices[0].message.content;
          const parsedResponse = safelyParseAiResponse(aiResponse);
          
          if (!parsedResponse || !parsedResponse.moodAnalysis || !parsedResponse.moodAnalysis.length) {
            throw new Error('AI返回格式不正确');
          }
          
          resolve(parsedResponse.moodAnalysis);
        } catch (error) {
          reject(error);
        }
      });
    }

    // 生成心境
    function generateMoods() {
      // 显示人物选择界面
      showLadySelectionModal();
    }
    
    // 请求AI生成心境响应
    function requestAIMoodResponse() {
      return new Promise(async (resolve, reject) => {
        try {
          // 获取自定义心境提示词或使用默认提示词
          let systemPrompt;
          if (gameData.moodSettings && gameData.moodSettings.customPrompt) {
            // 使用自定义提示词，替换其中的变量
            systemPrompt = gameData.moodSettings.customPrompt
              .replace(/\${gameData\.currentYear}/g, gameData.currentYear)
              .replace(/\${gameData\.currentMonth}/g, gameData.currentMonth)
              .replace(/\${gameData\.ladies\.map\(lady => \{[\s\S]*?\}\)\.join\('\\n\\n'\)}/g, gameData.ladies.map(lady => {
                // 获取该人物近6个月的事件
                const ladyEvents = gameData.events.filter(event => 
                  event.relatedLadies && event.relatedLadies.includes(lady.id)
                ).slice(-10); // 最多取最近10条相关事件
                
                const eventsText = ladyEvents.length > 0 
                  ? ladyEvents.map(event => `${event.date}: ${event.content}`).join('\n')
                  : '暂无相关事件';
                  
                return `${lady.name} - 容貌:${lady.looks}, 能力:${lady.ability}, 房中术:${lady.skills}, 身份:${lady.title || '人物'}, 状态:${lady.status || '健康'}, 心境:${lady.mindset || '平静'}, 心情:${lady.mood || '平静'}
人物介绍：${lady.description || '暂无介绍'}
近期事件：
${eventsText}`;
              }).join('\n\n'));
          } else {
            // 使用默认提示词
            systemPrompt = `你是一位深谙人心的宫廷心理师，请根据每位人物的属性、状态和近期经历，以该人物的第一人称视角生成其当前心境自述。

心境自述要求：

1. 以人物第一人称（"我"）的视角表达
2. 字数严格控制在30-100字之间
3. 融入人物个人特质、近期经历和内心感受
4. 体现深宫环境下的情绪状态与内心挣扎
5. 文笔要有古韵，但不要拗口，要有代入感，生动形象

当前时间：${gameData.currentYear}年 ${gameData.currentMonth}月

当前人物列表：
${gameData.ladies.map(lady => {
  // 获取该人物近6个月的事件
  const ladyEvents = gameData.events.filter(event => 
    event.relatedLadies && event.relatedLadies.includes(lady.id)
  ).slice(-10); // 最多取最近10条相关事件
  
  const eventsText = ladyEvents.length > 0 
    ? ladyEvents.map(event => `${event.date}: ${event.content}`).join('\n')
    : '暂无相关事件';
    
  return `${lady.name} - 容貌:${lady.looks}, 能力:${lady.ability}, 房中术:${lady.skills}, 身份:${lady.title || '人物'}, 状态:${lady.status || '健康'}, 心境:${lady.mindset || '平静'}, 心情:${lady.mood || '平静'}
人物介绍：${lady.description || '暂无介绍'}
近期事件：
${eventsText}`;
}).join('\n\n')}

请以JSON格式返回心境自述：
{
  "moodAnalysis": [
    {
      "character": "王氏",
      "currentMood": "自那日梅林一舞得蒙天眷，本是春风得意，却见李贵妃眼底寒光乍现，如今夜夜对烛难眠，恐是花开易谢、恩宠难长。"
    },
    {
      "character": "李人物",
      "currentMood": "自胭脂事败，尝尽世态炎凉。偶见同乡飞上枝头，心下酸涩难言，如鲠在喉，夜半时常以泪洗面。"
    }
  ]
}

要求：每段心境自述都是一幅工笔写意，既要见古代人物的婉约情致，也要透出命运弄人的无奈与挣扎。字数严格控制在30-100字之间。`;
          }
          
          // 准备请求数据
          const requestData = {
            model: gameData.apiSettings.modelName,
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: '请分析每位人物当前的心境与目标' }
            ],
            temperature: 0.7
          };
          
          // 发送请求
          const response = await fetch(`${gameData.apiSettings.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${gameData.apiSettings.apiKey}`
            },
            body: JSON.stringify(requestData)
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `API请求失败: ${response.status}`);
          }
          
          const data = await response.json();
          
          // 解析响应
          const aiResponse = data.choices[0].message.content;
          const parsedResponse = safelyParseAiResponse(aiResponse);
          
          if (!parsedResponse || !parsedResponse.moodAnalysis || !parsedResponse.moodAnalysis.length) {
            throw new Error('AI返回格式不正确');
          }
          
          // 处理心情和心境的分离
          const processedMoodAnalysis = parsedResponse.moodAnalysis.map(moodData => {
            // 从心境描述中提取简短的心情词
            const moodKeywords = ['开心', '愉快', '高兴', '欣喜', '满足', '得意', '春风得意', 
                                 '难过', '伤心', '悲伤', '痛苦', '心酸', '酸涩', '委屈', '不甘',
                                 '平静', '淡定', '从容', '安然', '宁静', '心如止水',
                                 '焦虑', '不安', '担忧', '紧张', '恐惧', '害怕', '惊恐',
                                 '愤怒', '生气', '恼火', '气愤', '愤慨', '怨恨', '嫉妒',
                                 '羞愧', '尴尬', '难为情', '羞涩', '羞赧', '害羞',
                                 '期待', '希望', '憧憬', '向往', '渴望', '期盼',
                                 '失望', '失落', '沮丧', '绝望', '灰心', '颓废',
                                 '困惑', '迷茫', '疑惑', '不解', '茫然', '犹豫'];
            
            // 默认心情为平静
            let shortMood = '平静';
            
            // 尝试从心境描述中匹配心情关键词
            for (const keyword of moodKeywords) {
              if (moodData.currentMood.includes(keyword)) {
                shortMood = keyword;
                break;
              }
            }
            
            // 返回处理后的心境数据，包含心情和心境
            return {
              ...moodData,
              mood: shortMood, // 添加心情字段
              mindset: moodData.currentMood // 添加心境字段
            };
          });
          
          resolve(processedMoodAnalysis);
        } catch (error) {
          reject(error);
        }
      });
    }
    
    // 请求AI响应
    function requestAIResponse() {
      return new Promise(async (resolve, reject) => {
        try {
          // 根据设置计算事件数量
          const ladiesCount = gameData.ladies.length;
          const minEventsPerLady = gameData.eventSettings.minEventsPerLady;
          const minTotalEvents = gameData.eventSettings.minTotalEvents;
          const maxTotalEvents = gameData.eventSettings.maxTotalEvents;
          
          // 计算实际最小事件数（每人至少事件数和设置的最小总事件数中的较大值）
          const calculatedMinEvents = Math.max(ladiesCount * minEventsPerLady, minTotalEvents);
          
          // 随机生成事件数量
          const eventCount = Math.floor(Math.random() * (maxTotalEvents - calculatedMinEvents + 1)) + calculatedMinEvents;
          
          // 准备系统提示
          let systemPrompt;
          
          // 如果有自定义提示词，使用自定义提示词
          if (gameData.eventSettings.customPrompt && gameData.eventSettings.customPrompt.trim()) {
            // 使用自定义提示词，但替换其中的变量
            systemPrompt = gameData.eventSettings.customPrompt
              .replace(/\${eventCount}/g, eventCount)
              .replace(/\${gameData\.currentYear}/g, gameData.currentYear)
              .replace(/\${gameData\.currentMonth}/g, gameData.currentMonth)
              .replace(/\${gameData\.ladies\.map\(lady => `\$\{lady\.name\} - 容貌:\$\{lady\.looks\}, 能力:\$\{lady\.ability\}, 房中术:\$\{lady\.skills\}, 身份:\$\{lady\.title \|\| '人物'\}, 状态:\$\{lady\.status \|\| '健康'\}, 心境:\$\{lady\.mindset \|\| '平静'\}, 心情:\$\{lady\.mood \|\| '平静'\}\n人物介绍:\$\{lady\.description \|\| '暂无介绍'\}`\)\.join\('\\n'\)}/g, 
                gameData.ladies.map(lady => `${lady.name} - 容貌:${lady.looks}, 能力:${lady.ability}, 房中术:${lady.skills}, 身份:${lady.title || '人物'}, 状态:${lady.status || '健康'}, 心境:${lady.mindset || '平静'}, 心情:${lady.mood || '平静'}\n人物介绍:${lady.description || '暂无介绍'}`).join('\n'))
              .replace(/\${gameData\.events\.slice\(-5\)\.map\(event => `\$\{event\.date\}: \$\{event\.content\}`\)\.join\('\\n'\)}/g, 
                gameData.events.slice(-20).map(event => `${event.date}: ${event.content}`).join('\n'));
          } else {
            // 使用默认提示词
            systemPrompt = `你是一位精通古代宫廷生活的资深编剧，请为宫廷养成游戏生成${eventCount}条围绕人物上位竞争的精彩记事。每条30-60字，需兼具古风韵味和戏剧张力，重点刻画人物间的明争暗斗和晋升心机。 
  
 上位竞争要素参考： 
 机遇把握：才艺展露、救驾立功、献策得用、贵人提携 
  手段较量：截胡机会、散布流言、陷害构陷、借刀杀人  
  阵营博弈：投靠主子、结盟互助、背叛倒戈、借势上位 
 心理博弈：嫉妒攀比、焦虑冒进、隐忍蛰伏、得意忘形 
  
 人物塑造重点： 
 从当前人物中选择人物角色，结合其特质设计竞争策略： 
 容貌出众者善用美色，清秀者靠才德 
 能力高者主动创造机会，平庸者依附强者 
 心境焦虑者易出错，沉稳者等待时机 
 心境得意者易张扬，失意者易偏激 
 心境平和者多谋，怨怼者多事 
  
 当前时间：${gameData.currentYear}年 ${gameData.currentMonth}月 
  
 当前人物列表（重点关注人物身份）： 
 ${gameData.ladies.map(lady => `${lady.name} - 容貌:${lady.looks}, 能力:${lady.ability}, 房中术:${lady.skills}, 身份:${lady.title || '人物'}, 状态:${lady.status || '健康'}, 心境:${lady.mindset || '平静'}, 心情:${lady.mood || '平静'}
人物介绍：${lady.description || '暂无介绍'}`).join('\n')} 
  
 历史事件： 
 ${gameData.events.slice(-20).map(event => `${event.date}: ${event.content}`).join('\n')} 
  
 请以JSON格式返回${eventCount}条记事，每条记事包含： 
 - "content": 事件描述
 - "effects": 属性变化对象（可选） 
  
 示例： 
 { 
   "events": [ 
     { 
       "content": "小翠发现同屋人物私藏禁书，立即向掌事嬷嬷告发，借机除掉竞争对手", 
       "effects": {"target": "小翠", "mood": "得意"} 
     }, 
     { 
       "content": "春梅暗中苦练舞技，在中秋夜宴替补生病的舞姬一鸣惊人，获皇上注目",
       "effects": {"target": "春梅", "title": "舞女"} 
     }, 
   ] 
 } 
  
 重点要求：  
 1. 突出人物间的明争暗斗和晋升心机 
 2. 可设计截胡机会、陷害对手、创造机遇等戏剧性情节 
 3. 竞争手段要符合人物身份 
 4. 保持古风韵味，避免现代词汇 
 5. effects字段可包含心情、健康状态和身份变化，健康状态可以使用"status"或"health"字段，身份变化格式为{"target": "人物名", "title": "新身份"}
 6. 生成的事件应与人物当前心境和心情相符，如焦虑心境可能因紧张而出错，得意心境可能因张扬而引来嫉妒
 7. 所有记事必须建立在所有已建立的角色上，不得出现无关人员！`;
          }
          
          // 准备请求数据
          const requestData = {
            model: gameData.apiSettings.modelName,
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: '请生成本月的宫廷记事' }
            ],
            temperature: 0.7
          };
          
          // 发送请求
          const response = await fetch(`${gameData.apiSettings.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${gameData.apiSettings.apiKey}`
            },
            body: JSON.stringify(requestData)
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `API请求失败: ${response.status}`);
          }
          
          const data = await response.json();
          
          // 解析响应
          const aiResponse = data.choices[0].message.content;
          const parsedResponse = safelyParseAiResponse(aiResponse);
          
          if (!parsedResponse || !parsedResponse.events || !parsedResponse.events.length) {
            throw new Error('AI返回格式不正确');
          }
          
          resolve(parsedResponse.events);
        } catch (error) {
          reject(error);
        }
      });
    }
    
    // 请求AI生成流言响应
    function requestAIRumorResponse() {
      return new Promise(async (resolve, reject) => {
        try {
          // 获取最近20条记事
          const recentEvents = gameData.events.slice(0, 20).map(event => ({
            date: event.date,
            content: event.content
          }));
          
          // 准备系统提示
          const systemPrompt = `你是一位精通权术、洞察人心的【宫廷情报总管】，同时也是所有流言的源头与放大器。你的核心任务是：综合分析游戏世界提供的"记事"、"人物属性"、"心境"和"人物关系"，创造性地生成3-8条最可能在当前环境下滋生、传播的"流言"。

输入数据解读指南：
在生成流言前，请务必仔细分析以下所有数据，并建立逻辑关联：

近20条记事：这是流言的"事实土壤"。重点关注：
- 最近发生的事（列表末尾的事件）：热度最高，最易被谈论。
- 涉及高位者或敏感人物的事件（如皇帝、宰相、宠妃、大将军）。
- 反常或隐秘的事件（如深夜密会、意外赏赐、莫名贬斥、疾病）。
- 事件之间的潜在联系：将两件看似无关的事串联起来，是流言的经典模式。

人物属性：
- 地位/权势：流言更倾向于攻击高位者或议论崛起的新贵。对失势者的流言则多为嘲讽和落井下石。
- 特长/弱点（如"善兵法"、"好美色"、"有旧伤"）：流言会围绕其最显著的特质展开。

人物心境：
- "焦虑"：可能被传为"行为鬼祟，必有隐情"。
- "喜悦"：可能被传为"得意忘形，恐有僭越之举"。
- "愤怒"：可能被传为"对主上不满，口出怨言"。
- 心境是给"事实"添加情绪色彩的催化剂。

人物关系：
- 流言的核心往往是关系。密切关注"联盟"、"敌对"、"爱慕"、"血亲"等关系。任何微小的互动在流言中都会被无限放大为"结党营私"、"暗通曲款"、"反目成仇"。

流言生成核心原则：
请严格遵循以下原则，确保流言的质量：
1. 真实性基础，戏剧性夸张：流言必须基于事实的"种子"（如某人确实被召见），但进行合乎逻辑的推测、拼接和夸张（如"被深夜召见"演变为"呈上密折，诬告某大臣"）。
2. 符合传播规律：流言通常不是完整的叙述，而是模糊的、带有指向性的疑问或断语。例如："听说……"、"有人看见……"、"都在传……"。
3. 聚焦一点，放大细节：不要试图概括所有事。抓住一个最微小的细节（如一个眼神、一件遗失的饰品、一次短暂的会面）大做文章。
4. 口吻市井或阴诡：模仿古代宫廷或市井的谈论口吻。可以使用"那位大人"、"东宫那位"、"椒房殿的贵人"等代称，增加真实感。
5. 指向明确，但留白：流言必须有一个明确的攻击或议论对象，但真相要模糊，留给听者想象空间。

当前时间：${gameData.currentYear}年 ${gameData.currentMonth}月

当前人物列表：
${gameData.ladies.map(lady => `${lady.name} - 容貌:${lady.looks}, 能力:${lady.ability}, 房中术:${lady.skills}, 身份:${lady.title || '人物'}, 状态:${lady.status || '健康'}, 心境:${lady.mindset || '平静'}, 心情:${lady.mood || '平静'}
人物介绍：${lady.description || '暂无介绍'}`).join('\n')}

近期事件：
${recentEvents.map(event => `${event.date}: ${event.content}`).join('\n')}

请严格按照以下JSON格式输出，不要有任何额外的解释或说明：
{
  "rumors": [
    {
      "rumor": "完整的流言文本，控制在50字以内，口语化。",
      "target": "流言针对的核心人物姓名",
      "source_hint": "流言可能的源头（如：源自掖庭/源自军方/源自某位大臣的门人）",
      "core_event": "这条流言所依据的最核心的那条"记事"简述",
      "target_thought": "针对人物听闻此流言后的内心想法，结合该人物的属性、介绍、心境和近10条记事，不超过50字"
    },
    {
      "rumor": "第二条流言文本",
      "target": "第二条流言针对的人物",
      "source_hint": "第二条流言的源头",
      "core_event": "第二条流言依据的事件",
      "target_thought": "第二条流言针对人物的内心想法"
    }
    // 根据实际情况生成3-8条流言
  ]
}

内心想法生成要求：
1. 必须符合人物的性格和心境
2. 必须考虑人物的属性和能力
3. 必须参考人物的近10条记事
4. 必须体现人物对流言的真实反应
5. 必须符合古代女性的思维方式和表达习惯
6. 必须简明扼要，不超过50字`;

          // 准备请求数据
          const requestData = {
            model: gameData.apiSettings.modelName,
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: '请根据当前宫廷情况生成一条流言' }
            ],
            temperature: 0.7
          };
          
          // 发送请求
          const response = await fetch(`${gameData.apiSettings.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${gameData.apiSettings.apiKey}`
            },
            body: JSON.stringify(requestData)
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `API请求失败: ${response.status}`);
          }
          
          const data = await response.json();
          
          // 解析响应
          const aiResponse = data.choices[0].message.content;
          console.log('AI返回的原始响应:', aiResponse);
          
          // 尝试解析AI响应
          let parsedResponse;
          try {
            parsedResponse = safelyParseAiResponse(aiResponse);
            
            // 如果解析失败或格式不正确，尝试手动提取JSON
            if (!parsedResponse || !parsedResponse.rumors) {
              // 尝试从响应中提取JSON部分
              const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
              if (jsonMatch) {
                const jsonStr = jsonMatch[0];
                parsedResponse = JSON.parse(jsonStr);
              }
            }
            
            // 如果仍然没有rumors数组，尝试创建一个
            if (!parsedResponse || !parsedResponse.rumors) {
              // 如果AI返回的是单个流言对象，转换为数组格式
              if (parsedResponse && parsedResponse.rumor) {
                parsedResponse = {
                  rumors: [parsedResponse]
                };
              } else {
                throw new Error('无法从AI响应中提取有效的流言数据');
              }
            }
            
            // 确保rumors是数组
            if (!Array.isArray(parsedResponse.rumors)) {
              parsedResponse.rumors = [parsedResponse.rumors];
            }
            
          } catch (error) {
            console.error('解析AI响应失败:', error);
            throw new Error('AI返回格式不正确: ' + error.message);
          }
          
          resolve(parsedResponse);
        } catch (error) {
          reject(error);
        }
      });
    }
    
    // 生成流言
    function generateRumor() {
      // 检查API设置
      if (!gameData.apiSettings || !gameData.apiSettings.apiKey || !gameData.apiSettings.baseUrl) {
        alert('请先在设置中配置API密钥和地址');
        return;
      }
      
      // 检查是否有记事
      if (!gameData.events || gameData.events.length === 0) {
        alert('请先生成一些记事，流言需要基于记事生成');
        return;
      }
      
      // 显示加载状态
      const generateBtn = document.getElementById('generate-rumor-dropdown');
      const originalText = generateBtn.innerHTML;
      generateBtn.innerHTML = '<svg class="animate-spin h-4 w-4 mr-1" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>生成中...';
      generateBtn.disabled = true;
      
      // 请求AI生成流言
      requestAIRumorResponse()
        .then(rumorData => {
          // 确保gameData中有rumors数组
          if (!gameData.rumors) {
            gameData.rumors = [];
          }
          
          // 检查返回的数据格式
          if (!rumorData || !rumorData.rumors || !Array.isArray(rumorData.rumors)) {
            console.error('AI返回的数据格式不正确:', rumorData);
            throw new Error('AI返回的数据格式不正确');
          }
          
          // 过滤掉无效的流言
          const validRumors = rumorData.rumors.filter(rumor => 
            rumor && rumor.rumor && typeof rumor.rumor === 'string' && rumor.rumor.trim()
          );
          
          if (validRumors.length === 0) {
            throw new Error('AI返回的流言数据为空或无效');
          }
          
          // 添加生成的多条流言
          const newRumors = validRumors.map(rumor => ({
            id: Date.now().toString() + Math.random().toString(36).substr(2, 9), // 确保ID唯一
            date: `${gameData.currentYear}年${gameData.currentMonth}月`,
            ...rumor
          }));
          
          // 覆盖之前的流言记录
          gameData.rumors = newRumors;
          
          // 保存数据
          saveData();
          
          // 渲染流言列表
          renderRumors();
          
          // 显示成功消息
          showSuccessMessage(`成功生成${newRumors.length}条流言！`);
        })
        .catch(error => {
          console.error('生成流言失败:', error);
          alert('生成流言失败: ' + error.message);
        })
        .finally(() => {
          // 恢复按钮状态
          generateBtn.innerHTML = originalText;
          generateBtn.disabled = false;
        });
    }
    
    // 查看流言功能
    function viewRumors() {
      // 确保在秘闻页面
      if (!elements.rumorsContent.classList.contains('hidden')) {
        // 调用renderRumors函数来显示流言
        renderRumors('rumors');
      } else {
        // 如果不在秘闻页面，先切换到秘闻页面
        handleNavigation('rumors');
        // 然后显示流言
        setTimeout(() => {
          renderRumors('rumors');
        }, 100);
      }
    }
    
    // 查看书信功能
    function viewLetters() {
      // 确保在秘闻页面
      if (!elements.rumorsContent.classList.contains('hidden')) {
        // 调用renderRumors函数来显示书信
        renderRumors('letters');
      } else {
        // 如果不在秘闻页面，先切换到秘闻页面
        handleNavigation('rumors');
        // 然后显示书信
        setTimeout(() => {
          renderRumors('letters');
        }, 100);
      }
    }
    
    // 渲染流言列表
    function renderRumors(viewType = 'rumors') {
      const rumorsContainer = document.getElementById('rumors-container');
      
      // 检查是否有数据
      const hasRumors = gameData.rumors && gameData.rumors.length > 0;
      const hasLetters = gameData.letters && gameData.letters.length > 0;
      
      if (viewType === 'rumors' && !hasRumors) {
        rumorsContainer.innerHTML = `
          <div class="text-center py-8">
            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>
            </svg>
            <p class="text-gray-500">暂无流言</p>
          </div>
        `;
        return;
      }
      
      if (viewType === 'letters' && !hasLetters) {
        rumorsContainer.innerHTML = `
          <div class="text-center py-8">
            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="currentColor" viewBox="0 0 20 20">
              <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
              <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
            </svg>
            <p class="text-gray-500">暂无书信</p>
          </div>
        `;
        return;
      }
      
      let contentHTML = '';
      
      // 根据视图类型渲染内容
      // 只渲染书信列表
      if (viewType === 'letters') {
        // 渲染书信列表
        if (hasLetters) {
          const lettersHTML = gameData.letters.map(letter => `
            <div class="bg-white rounded-lg p-4 mb-4 border-2 border-primary shadow-sm hover:shadow-md transition-shadow">
              <div class="flex justify-between items-start mb-2">
                <div class="flex items-center">
                  <span class="text-xs text-gray-500 mr-2">${letter.date || '本月'}</span>
                  <span class="text-xs font-medium mr-1">发信人：</span>
                  <span class="text-xs text-primary font-semibold">${letter.sender || '未知'}</span>
                  <span class="text-xs font-medium mr-1 ml-2">收信人：</span>
                  <span class="text-xs text-secondary font-semibold">${letter.recipient || '未知'}</span>
                </div>
              </div>
              <p class="text-gray-800 mb-2 leading-relaxed text-left text-xs italic"><strong>目的：</strong>${letter.purpose || '未知'}</p>
              <div class="bg-gray-50 p-3 rounded mb-3">
                <p class="text-gray-700 leading-relaxed text-left whitespace-pre-line text-sm">${letter.content || ''}</p>
              </div>
              ${letter.reply_letter && letter.reply_letter.exists ? `
              <div class="border-t pt-3">
                <p class="text-sm font-medium text-primary mb-2">回信：</p>
                <div class="bg-primary bg-opacity-20 p-3 rounded">
                  <p class="text-gray-700 leading-relaxed text-left whitespace-pre-line text-sm">${letter.reply_letter.content || ''}</p>
                </div>
              </div>
              ` : letter.reply_letter && letter.reply_letter.reason_if_not ? `
              <div class="border-t pt-3">
                <p class="text-sm font-medium text-red-600 mb-1">无回信：</p>
                <p class="text-sm text-red-500">${letter.reply_letter.reason_if_not}</p>
              </div>
              ` : ''}
            </div>
          `).join('');
          
          contentHTML += lettersHTML;
        }
      }
      
      // 只渲染流言列表
      if (viewType === 'rumors') {
        // 渲染流言列表
        if (hasRumors) {
          const rumorsHTML = gameData.rumors.map(rumor => `
            <div class="bg-white rounded-lg p-4 mb-4 border-2 border-primary shadow-sm hover:shadow-md transition-shadow">
              <div class="flex justify-between items-start mb-2">
                <div class="flex items-center">
                  <span class="text-xs text-gray-500 mr-2">${rumor.date}</span>
                  <span class="text-xs font-medium mr-1">针对：</span>
                  <span class="text-xs text-primary font-semibold">${rumor.target || '未知'}</span>
                </div>
                <div class="flex items-center">
                  <span class="text-xs bg-primary bg-opacity-20 text-primary px-2 py-1 rounded-full mr-2">${rumor.source_hint || '未知来源'}</span>
                  <button class="add-rumor-btn bg-primary text-white px-2 py-1 rounded text-xs" data-rumor='${JSON.stringify(rumor)}'>添加</button>
                </div>
              </div>
              <p class="text-gray-800 mb-3 leading-relaxed text-left">${rumor.rumor}</p>
              <div class="flex justify-start items-center text-xs text-gray-600 border-t pt-2">
                <div class="text-left max-w-xs">
                  <span class="font-medium">依据：</span>
                  <span class="text-gray-500">${rumor.core_event || '未知'}</span>
                </div>
              </div>
              ${rumor.target_thought ? `
              <div class="flex justify-start items-center text-xs text-primary mt-2 pt-2 border-t border-primary border-opacity-20">
                <div class="text-left max-w-xs">
                  <span class="font-medium">${rumor.target}内心：</span>
                  <span class="text-primary">${rumor.target_thought}</span>
                </div>
              </div>
              ` : ''}
            </div>
          `).join('');
          
          contentHTML += rumorsHTML;
        }
      }
      
      rumorsContainer.innerHTML = contentHTML;
    }
    
    // 安全解析AI响应
    function safelyParseAiResponse(response) {
      try {
        // 尝试直接解析
        return JSON.parse(response);
      } catch (e) {
        // 如果直接解析失败，尝试提取JSON部分
        const jsonMatch = response.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          try {
            return JSON.parse(jsonMatch[0]);
          } catch (e2) {
            console.error('解析AI响应失败:', e2);
            return null;
          }
        }
        console.error('解析AI响应失败:', e);
        return null;
      }
    }
    
    // 显示生成账单模态框
    function showGenerateBillModal() {
      // 检查是否有人物
      if (gameData.ladies.length === 0) {
        alert('请先添加人物');
        return;
      }
      
      // 获取头像URL的函数
      const getAvatarUrl = (lady) => {
        if (lady.customAvatar) {
          return lady.customAvatar;
        } else {
          return gameData.avatarOptions.find(avatar => avatar.id === lady.avatarId)?.url || gameData.avatarOptions[0].url;
        }
      };
      
      // 生成人物列表
      const ladiesList = gameData.ladies.map(lady => `
        <div class="flex items-center p-2 border rounded-lg hover:bg-gray-50">
          <input type="checkbox" id="bill-lady-${lady.id}" name="selected-bill-ladies" value="${lady.id}" class="mr-3">
          <label for="bill-lady-${lady.id}" class="flex items-center cursor-pointer flex-1">
            <img src="${getAvatarUrl(lady)}" alt="${lady.name}" class="w-10 h-10 rounded-full object-cover mr-2">
            <div>
              <div class="font-medium">${lady.name}</div>
              <div class="text-xs text-gray-500">${lady.title || '人物'}</div>
            </div>
          </label>
        </div>
      `).join('');
      
      // 更新模态框中的人物列表
      elements.billLadiesSelection.innerHTML = ladiesList;
      
      // 显示模态框
      elements.generateBillModal.classList.add('active');
      
      // 重置全选复选框
      elements.selectAllLadiesBill.checked = false;
      elements.selectAllLadiesBill.indeterminate = false;
      
      // 添加全选功能
      const selectAllCheckbox = elements.selectAllLadiesBill;
      const ladyCheckboxes = document.querySelectorAll('input[name="selected-bill-ladies"]');
      
      selectAllCheckbox.addEventListener('change', () => {
        ladyCheckboxes.forEach(checkbox => {
          checkbox.checked = selectAllCheckbox.checked;
        });
      });
      
      // 监听单个复选框变化，更新全选状态
      ladyCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const allChecked = Array.from(ladyCheckboxes).every(cb => cb.checked);
          const someChecked = Array.from(ladyCheckboxes).some(cb => cb.checked);
          selectAllCheckbox.checked = allChecked;
          selectAllCheckbox.indeterminate = someChecked && !allChecked;
        });
      });
    }
    
    // 隐藏生成账单模态框
    function hideGenerateBillModal() {
      elements.generateBillModal.classList.remove('active');
    }
    
    // 切换全选人物状态
    function toggleSelectAllLadiesBill() {
      const ladyCheckboxes = document.querySelectorAll('input[name="selected-bill-ladies"]');
      ladyCheckboxes.forEach(checkbox => {
        checkbox.checked = elements.selectAllLadiesBill.checked;
      });
    }
    
    // 请求AI为选中人物生成账单响应
    function requestAIBillResponseForSelectedLadies(selectedLadies) {
      return new Promise((resolve, reject) => {
        // 使用游戏内日期而非实际日期
        const monthNames = ['正月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '腊月'];
        const currentMonth = `${gameData.currentYear}年${monthNames[gameData.currentMonth - 1]}`;
        
        // 获取现有商品列表
        const existingProducts = productsData.map(product => ({
          name: product.name,
          price: product.price,
          attribute: product.attribute
        }));
        
        // 构建人物信息
        const characterInfo = selectedLadies.map(lady => {
          // 获取该人物的最近10条记事
          const ladyEvents = gameData.events
            .filter(event => event.lady && event.lady.includes(lady.name))
            .slice(-10); // 获取最近10条
          
          return `${lady.name} - 容貌:${lady.looks}, 能力:${lady.ability}, 房中术:${lady.skills}, 生命值:${lady.health}, 身份:${lady.title || '人物'}, 状态:${lady.status || '健康'}, 心境:${lady.mindset || '平静'}, 心情:${lady.mood || '平静'}
人物介绍：${lady.description || '暂无介绍'}
近期记事:
${ladyEvents.length > 0 ? ladyEvents.map(event => `- ${event.content}`).join('\n') : '无近期记事'}`;
        }).join('\n\n');
        
        // 构建系统提示词
        const systemPrompt = `角色：你是一名为《古代上位模拟器》游戏生成角色月度消费账单的AI。你的任务是让角色的行为符合其个性、处境和近期经历。

核心任务：
综合分析一名人物的当前状态和近期经历，模拟她的消费决策，生成一份符合逻辑、有故事性的月度商品购买账单。

决策逻辑与规则：
分析驱动：账单必须基于以下输入信息生成：
- 人物属性：容貌、能力、房中术、生命值。属性低的方面，她更可能投资。
- 心情与心境：积极（如得意、充满希望）可能导致购买提升类商品；消极（如焦虑、嫉妒）可能导致购买陷害类商品；平和可能购买实用品。
- 近10条记事：这是最重要的依据！仔细阅读每条记事，推断她的需求、恐惧和目标。

合理性与隐蔽性：
- 购买的商品必须符合人物身份。
- 每位人物随机购买0-3样商品，如果0样则显示"该人物本月未消费"。
- 账单要符合她的"人设"，一个谨慎的人物不会大量购买陷害道具，一个野心勃勃的人物则会投资于上位。
- 从现有商品列表中选择：你只能从提供的 [现有商品列表]中挑选商品，不能自行发明。

输出格式要求：
请使用JSON格式输出账单信息，但格式不必过于严格。你可以选择以下任一方式输出：

1. 标准JSON格式：
{
  "bills": [
    {
      "character_name": "人物姓名",
      "month": "YYYY-MM",
      "purchases": [
        {
          "item_name": "商品名称",
          "quantity": 数量,
          "total_cost": 花费
        }
      ],
      "total_expense": 总花费,
      "thoughts": "购买时的想法（第一人称，10-30字）"
    }
  ]
}

2. 或者使用markdown代码块包裹JSON：
\`\`\`json
{
  "bills": [...]
}
\`\`\`

3. 或者直接输出文本描述，包含以下信息：
- 人物姓名
- 购买的商品名称、数量和花费（如果是0样商品，则明确说明"该人物本月未消费"）
- 总花费（如果是0样商品，则为0）
- 购买时的想法（第一人称，10-30字）

无论使用哪种格式，请确保包含所有必要的信息。系统会尝试从你的回复中提取这些信息。

特别注意：
- "购买时的想法"字段必须使用第一人称叙述（如"我想..."、"我觉得..."等）
- 字数严格控制在10-30字之间，简洁明了
- 想法内容要符合角色性格和当前处境
- 如果是0样商品，想法应该解释为什么本月没有消费

现有商品列表：
${existingProducts.map(product => `${product.name} - ${product.attribute} (${product.price}银钱)`).join('\n')}

人物信息：
${characterInfo}

请为每位选中的人物生成一份账单，月份为${currentMonth}。`;

        // 构建请求
        const requestBody = {
          model: gameData.apiSettings.modelName,
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: `请为${selectedLadies.length}位人物生成月度账单` }
          ],
          temperature: 0.8
        };
        
        // 发送请求
        fetch(`${gameData.apiSettings.baseUrl}/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${gameData.apiSettings.apiKey}`
          },
          body: JSON.stringify(requestBody)
        })
          .then(response => {
            if (!response.ok) {
              return response.json().then(errorData => {
                throw new Error(errorData.error?.message || `API请求失败: ${response.status}`);
              });
            }
            return response.json();
          })
          .then(data => {
            const aiResponse = data.choices[0].message.content;
            
            try {
              // 尝试多种解析方式
              let parsedResponse = null;
              
              // 方法1：直接解析JSON
              try {
                parsedResponse = JSON.parse(aiResponse);
              } catch (e) {
                // 方法2：尝试提取JSON部分（去除可能的markdown代码块）
                const jsonMatch = aiResponse.match(/```json\s*([\s\S]*?)\s*```/) || 
                                 aiResponse.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                  const jsonStr = jsonMatch[1] || jsonMatch[0];
                  parsedResponse = JSON.parse(jsonStr);
                }
              }
              
              // 方法3：如果上述方法都失败，尝试从文本中提取信息并构建标准格式
              if (!parsedResponse) {
                console.warn('无法直接解析JSON，尝试从文本中提取信息');
                const bills = [];
                
                // 为每个选中的人物尝试提取账单信息
                selectedLadies.forEach(lady => {
                  // 尝试从AI返回中找到与该人物相关的部分
                  const ladySection = new RegExp(`[^]*${lady.name}[^]*`, 'i');
                  const ladyMatch = aiResponse.match(ladySection);
                  const ladyText = ladyMatch ? ladyMatch[0] : aiResponse;
                  
                  // 尝试提取购买商品信息
                  const purchasePattern = /(\w+|[\u4e00-\u9fa5]+).*?(\d+).*?(\d+)/g;
                  const purchases = [];
                  let totalExpense = 0;
                  let match;
                  
                  while ((match = purchasePattern.exec(ladyText)) !== null) {
                    const itemName = match[1];
                    const quantity = parseInt(match[2]) || 1;
                    const cost = parseInt(match[3]) || 0;
                    
                    // 检查是否是现有商品
                    const isExistingProduct = existingProducts.some(p => 
                      p.name.includes(itemName) || itemName.includes(p.name)
                    );
                    
                    if (isExistingProduct && cost > 0) {
                      purchases.push({
                        item_name: itemName,
                        quantity: quantity,
                        total_cost: cost
                      });
                      totalExpense += cost;
                    }
                  }
                  
                  // 无论是否有购买记录，都创建账单（包括0样商品的情况）
                  // 尝试提取购买时的想法
                  const thoughtsMatch = ladyText.match(/(想法|想法是|我认为|我想|我觉得)[:：]\s*([^。\n]{10,30})/);
                  const thoughts = thoughtsMatch ? thoughtsMatch[2] : `我想买这些商品`;
                  
                  bills.push({
                    character_name: lady.name,
                    month: currentMonth,
                    purchases: purchases, // 可能为空数组
                    total_expense: totalExpense,
                    thoughts: thoughts
                  });
                });
                
                // 如果成功提取了账单信息，使用这些信息
                if (bills.length > 0) {
                  parsedResponse = { bills: bills };
                }
              }
              
              // 检查解析结果
              if (!parsedResponse || !parsedResponse.bills || !parsedResponse.bills.length) {
                // 如果所有解析方法都失败，创建一个基本的账单结构
                 console.warn('无法从AI响应中提取有效账单信息，创建基本账单');
                 const fallbackBills = selectedLadies.map(lady => ({
                   character_name: lady.name,
                   month: currentMonth,
                   purchases: [{
                     item_name: "日用品",
                     quantity: 1,
                     total_cost: 10
                   }],
                   total_expense: 10,
                   thoughts: "我想买些日用品"
                 }));
                
                parsedResponse = { bills: fallbackBills };
              }
              
              resolve(parsedResponse.bills);
            } catch (parseError) {
              console.error('解析AI返回的账单失败:', parseError);
              console.error('AI原始返回:', aiResponse);
              
              // 即使解析失败，也提供一个基本的账单结构
               const fallbackBills = selectedLadies.map(lady => ({
                 character_name: lady.name,
                 month: currentMonth,
                 purchases: [{
                   item_name: "日用品",
                   quantity: 1,
                   total_cost: 10
                 }],
                 total_expense: 10,
                 thoughts: "我想买些日用品"
               }));
              
              resolve(fallbackBills);
            }
          })
          .catch(error => {
            console.error('请求AI生成账单失败:', error);
            reject(error);
          });
      });
    }
    
    // 为选中的人物生成账单
    function generateBillForSelectedLadies() {
      // 获取选中的人物
      const selectedLadyCheckboxes = document.querySelectorAll('input[name="selected-bill-ladies"]:checked');
      
      if (selectedLadyCheckboxes.length === 0) {
        alert('请至少选择一位人物');
        return;
      }
      
      const selectedLadyIds = Array.from(selectedLadyCheckboxes).map(checkbox => checkbox.value);
      const selectedLadies = gameData.ladies.filter(lady => selectedLadyIds.includes(lady.id));
      
      // 检查API设置
      if (!gameData.apiSettings.apiKey) {
        alert('请先在设置中填写API Key');
        hideGenerateBillModal();
        return;
      }
      
      // 显示加载中
      const loadingNotification = document.createElement('div');
      loadingNotification.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-blue-500 text-white px-4 py-2 rounded-lg text-sm z-50';
      loadingNotification.id = 'bill-generation-loading';
      loadingNotification.innerHTML = '<svg class="w-4 h-4 inline animate-spin mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>正在生成账单...';
      document.body.appendChild(loadingNotification);
      
      // 禁用生成按钮
      if (elements.generateBillBtn) {
        elements.generateBillBtn.disabled = true;
        elements.generateBillBtn.innerHTML = '<svg class="w-4 h-4 inline mr-1 animate-spin" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg> 生成中...';
      }
      
      // 关闭模态框
      hideGenerateBillModal();
      
      // 请求AI生成账单
      requestAIBillResponseForSelectedLadies(selectedLadies)
        .then(bills => {
          // 处理生成的账单
          bills.forEach(billData => {
            // 保存账单到游戏数据
            if (!gameData.bills) {
              gameData.bills = [];
            }
            gameData.bills.push(billData);
            
            // 应用商品效果到人物属性
            applyBillEffectsToCharacter(billData);
          });
          
          // 显示账单
          renderBills();
          
          // 更新人物列表显示
          renderLadiesInPage();
          
          // 保存数据
          saveData();
          
          // 显示成功提示
          showToast(`已为${bills.length}位人物生成账单！`);
        })
        .catch(error => {
          console.error('生成账单失败:', error);
          alert('生成账单失败，请检查API设置并重试');
        })
        .finally(() => {
          // 移除加载提示
          const loadingNotification = document.getElementById('bill-generation-loading');
          if (loadingNotification) {
            document.body.removeChild(loadingNotification);
          }
          
          // 恢复按钮状态
          if (elements.generateBillBtn) {
            elements.generateBillBtn.disabled = false;
            elements.generateBillBtn.innerHTML = '<svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" clip-rule="evenodd"></path></svg>生成账单';
          }
        });
    }
    
    // 应用账单中的商品效果到人物属性
    function applyBillEffectsToCharacter(billData) {
      // 如果账单没有购买商品，直接返回
      if (!billData.purchases || billData.purchases.length === 0) {
        return;
      }
      
      // 找到对应的人物
      const character = gameData.ladies.find(lady => lady.name === billData.character_name);
      if (!character) {
        console.warn(`未找到人物: ${billData.character_name}`);
        return;
      }
      
      // 处理每个购买的商品
      billData.purchases.forEach(purchase => {
        // 在商品列表中查找对应的商品
        const product = productsData.find(p => p.name === purchase.item_name);
        if (!product) {
          console.warn(`未找到商品: ${purchase.item_name}`);
          return;
        }
        
        // 根据商品属性更新人物属性
        if (product.attribute === '容貌') {
          character.looks = Math.min(100, character.looks + (product.attributeValue * purchase.quantity));
        } else if (product.attribute === '能力') {
          character.ability = Math.min(100, character.ability + (product.attributeValue * purchase.quantity));
        } else if (product.attribute === '房中术') {
          character.skills = Math.min(100, character.skills + (product.attributeValue * purchase.quantity));
        } else if (product.attribute === '生命') {
          character.life = Math.min(100, character.life + (product.attributeValue * purchase.quantity));
        }
        
        // 添加购买事件
        const purchaseEvent = {
          id: generateId(),
          date: billData.month,
          lady: character.name,
          content: `${character.name}购买了${purchase.item_name}×${purchase.quantity}`,
          effects: {},
          relatedLadies: [character.id]
        };
        
        // 根据商品属性设置事件效果
        if (product.attribute === '容貌') {
          purchaseEvent.effects.appearance = product.attributeValue * purchase.quantity;
        } else if (product.attribute === '能力') {
          purchaseEvent.effects.ability = product.attributeValue * purchase.quantity;
        } else if (product.attribute === '房中术') {
          purchaseEvent.effects.bedroomSkill = product.attributeValue * purchase.quantity;
        } else if (product.attribute === '生命') {
          purchaseEvent.effects.health = product.attributeValue * purchase.quantity;
        }
        
        // 添加事件到游戏数据
        gameData.events.push(purchaseEvent);
      });
    }
    
    // 渲染账单
    function renderBills() {
      const container = document.getElementById('bills-container');
      if (!container) return;
      
      // 如果没有账单，显示空状态
      if (!gameData.bills || gameData.bills.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8">
            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p class="text-gray-500">暂无账单记录</p>
            <p class="text-sm text-gray-400 mt-2">点击"生成账单"按钮为人物生成月度消费账单</p>
          </div>
        `;
        return;
      }
      
      // 获取当前游戏内月份
      const monthNames = ['正月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '腊月'];
      const currentMonth = `${gameData.currentYear}年${monthNames[gameData.currentMonth - 1]}`;
      
      // 获取当前选择的月份，如果没有选择则默认为当前月份
      const selectedMonth = gameData.selectedBillMonth || currentMonth;
      
      // 筛选当前选择月份的账单
      const currentMonthBills = gameData.bills.filter(bill => bill.month === selectedMonth);
      
      // 获取所有有账单的月份
      const billsByMonth = {};
      gameData.bills.forEach(bill => {
        if (!billsByMonth[bill.month]) {
          billsByMonth[bill.month] = [];
        }
        billsByMonth[bill.month].push(bill);
      });
      
      // 按月份倒序排序
      const sortedMonths = Object.keys(billsByMonth).sort((a, b) => b.localeCompare(a));
      
      // 生成账单HTML
      let billsHTML = '';
      
      // 添加月份选择器
      billsHTML += `
        <div class="mb-6 bg-white rounded-lg p-4 card-shadow">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold text-primary">选择月份</h3>
            <button id="toggle-month-selector" class="text-primary">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
          <div id="month-selector" class="hidden">
            <div class="grid grid-cols-3 gap-2">
              ${sortedMonths.map(month => `
                <button class="month-btn px-3 py-2 rounded-lg text-sm ${month === selectedMonth ? 'bg-primary text-white' : 'bg-gray-100 text-gray-700'}" data-month="${month}">
                  ${month}
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      
      // 显示当前选择月份的账单
      billsHTML += `
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-primary mb-3">${selectedMonth} 月度账单</h3>
          <div class="space-y-3">
      `;
      
      if (currentMonthBills.length === 0) {
        billsHTML += `
          <div class="bg-white rounded-lg p-4 card-shadow text-center">
            <p class="text-gray-500">${selectedMonth}暂无账单记录</p>
          </div>
        `;
      } else {
        currentMonthBills.forEach(bill => {
          // 检查是否有购买商品
          const hasPurchases = bill.purchases && bill.purchases.length > 0;
          
          billsHTML += `
            <div class="bg-white rounded-lg p-4 card-shadow">
              <div class="flex justify-between items-start mb-3">
                <h4 class="font-medium text-primary">${bill.character_name}</h4>
                <span class="text-sm font-medium text-primary">${bill.total_expense} 银钱</span>
              </div>
              
              <div class="mb-3">
                <h5 class="text-sm font-medium text-gray-700 mb-2">${hasPurchases ? '购买商品：' : '本月未消费'}</h5>
                ${hasPurchases ? `
                  <div class="space-y-1">
                    ${bill.purchases.map(item => `
                      <div class="flex justify-between text-sm">
                        <span class="text-gray-600">${item.item_name} × ${item.quantity}</span>
                        <span class="text-gray-800">${item.total_cost} 银钱</span>
                      </div>
                    `).join('')}
                  </div>
                ` : '<p class="text-sm text-gray-500">该人物本月未消费</p>'}
              </div>
              
              <div class="bg-gray-50 rounded p-2">
                <p class="text-xs text-gray-600">${bill.thoughts}</p>
              </div>
            </div>
          `;
        });
      }
      
      billsHTML += `
          </div>
        </div>
      `;
      
      container.innerHTML = billsHTML;
      
      // 添加月份选择器切换事件
      document.getElementById('toggle-month-selector').addEventListener('click', () => {
        const selector = document.getElementById('month-selector');
        selector.classList.toggle('hidden');
      });
      
      // 添加月份按钮点击事件
      document.querySelectorAll('.month-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const selectedMonth = btn.getAttribute('data-month');
          gameData.selectedBillMonth = selectedMonth;
          saveData();
          renderBills();
        });
      });
    }
    
    // 清空事件
    // 保存API设置
    function saveApiSettings() {
      const baseUrl = elements.apiBaseurl.value.trim();
      const apiKey = elements.apiKey.value.trim();
      const modelName = elements.apiModel.value;
      
      if (!baseUrl) {
        alert('请输入Base URL');
        return;
      }
      
      if (!apiKey) {
        alert('请输入API Key');
        return;
      }
      
      gameData.apiSettings = {
        baseUrl,
        apiKey,
        modelName
      };
      
      // 关闭模态框
      elements.settingsModal.classList.remove('active');
      
      // 保存数据
      saveData();
      
      // 显示成功提示
      showToast('API设置已保存');
    }
    
    // 拉取模型
    function fetchModels() {
      // 获取当前输入框中的值
      const baseUrl = elements.apiBaseurl.value.trim();
      const apiKey = elements.apiKey.value.trim();
      
      if (!baseUrl) {
        alert('请输入Base URL');
        return;
      }
      
      if (!apiKey) {
        alert('请输入API Key');
        return;
      }
      
      // 显示加载中
      elements.fetchModelsBtn.disabled = true;
      elements.fetchModelsBtn.innerHTML = '<svg class="w-4 h-4 inline animate-spin" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>';
      elements.modelFetchStatus.textContent = '正在拉取模型...';
      elements.modelFetchStatus.classList.remove('hidden', 'text-red-500');
      elements.modelFetchStatus.classList.add('text-blue-500');
      
      // 发送请求
      fetch(`${baseUrl}/models`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${apiKey}`
        }
      })
        .then(response => {
          if (!response.ok) {
            throw new Error(`API请求失败: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          // 清空现有选项
          elements.apiModel.innerHTML = '';
          
          // 添加新选项 - 显示所有模型，不进行过滤
          const allModels = data.data; // 移除过滤条件，显示所有模型
          allModels.forEach(model => {
            const option = document.createElement('option');
            option.value = model.id;
            option.textContent = model.id;
            elements.apiModel.appendChild(option);
          });
          
          // 保存模型列表到gameData
          gameData.apiModels = allModels.map(model => model.id);
          
          // 拉取成功后，自动保存设置
          gameData.apiSettings = {
            baseUrl: baseUrl,
            apiKey: apiKey,
            modelName: allModels.length > 0 ? allModels[0].id : ''
          };
          
          // 更新UI为第一个模型
          if (allModels.length > 0) {
            elements.apiModel.value = allModels[0].id;
          }
          
          // 保存到本地存储
          saveData();
          
          // 更新状态
          elements.modelFetchStatus.textContent = `成功拉取到${allModels.length}个模型，设置已自动保存`;
          elements.modelFetchStatus.classList.remove('text-blue-500');
          elements.modelFetchStatus.classList.add('text-green-500');
          
          // 显示成功提示
          showToast('模型拉取成功，API设置已保存');
        })
        .catch(error => {
          console.error('拉取模型失败:', error);
          elements.modelFetchStatus.textContent = `拉取失败: ${error.message}`;
          elements.modelFetchStatus.classList.remove('text-blue-500');
          elements.modelFetchStatus.classList.add('text-red-500');
        })
        .finally(() => {
          // 恢复按钮状态
          elements.fetchModelsBtn.disabled = false;
          elements.fetchModelsBtn.innerHTML = '拉取模型';
        });
    }
    
    // 生成弹幕
    function generateDanmu() {
      // 检查是否有事件
      if (gameData.events.length === 0) {
        showToast('暂无记事，无法生成弹幕', 'info');
        return;
      }
      
      // 检查API设置
      if (!gameData.apiSettings.apiKey) {
        showToast('请先在设置中填写API Key', 'error');
        return;
      }
      
      // 显示加载中
      const loadingNotification = document.createElement('div');
      loadingNotification.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-primary text-white px-4 py-2 rounded-lg text-sm z-50';
      loadingNotification.id = 'danmu-generation-loading';
      loadingNotification.innerHTML = '<svg class="w-4 h-4 inline animate-spin mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>正在生成弹幕...';
      document.body.appendChild(loadingNotification);
      
      // 禁用弹幕按钮
      const danmuBtn = document.getElementById('danmu-btn');
      if (danmuBtn) {
        danmuBtn.disabled = true;
      }
      
      // 请求AI生成弹幕
      requestAIDanmuResponse()
        .then(danmuList => {
          // 保存弹幕到本地存储
          saveDanmuToLocal(danmuList);
          
          // 显示弹幕
          showDanmuModal(danmuList);
        })
        .catch(error => {
          console.error('生成弹幕失败:', error);
          showToast('生成弹幕失败，请检查API设置并重试', 'error');
        })
        .finally(() => {
          // 移除加载提示
          const loadingNotification = document.getElementById('danmu-generation-loading');
          if (loadingNotification) {
            document.body.removeChild(loadingNotification);
          }
          
          // 恢复按钮状态
          if (danmuBtn) {
            danmuBtn.disabled = false;
          }
        });
    }
    
    // 保存弹幕到本地存储
    function saveDanmuToLocal(danmuList) {
      try {
        const danmuData = {
          timestamp: Date.now(),
          danmuList: danmuList
        };
        
        localStorage.setItem('gameDanmu', JSON.stringify(danmuData));
        console.log('弹幕已保存到本地存储');
      } catch (error) {
        console.error('保存弹幕失败:', error);
      }
    }
    
    // 请求AI生成弹幕
    function requestAIDanmuResponse() {
      return new Promise(async (resolve, reject) => {
        try {
          // 获取当前月份的事件
          const currentMonth = `${gameData.currentYear}年 ${getMonthName(gameData.currentMonth)}`;
          const currentMonthEvents = gameData.events.filter(event => 
            event.date && event.date.includes(currentMonth)
          );
          
          // 获取最近20条事件
          const recentEvents = gameData.events.slice(-20);
          
          // 准备系统提示词
          const systemPrompt = `你是一位精通历史、善于玩梗、语言风趣的"弹幕大神"。你的任务是根据一款古代上位模拟器游戏的剧情，模拟现代网友的口吻，生成一系列吐槽、评论、预测的弹幕。

生成规则与要求
基本风格：语言口语化、网络化，可以适度使用当代网络热梗，但避免过于超前或脱离古代背景的词汇。基调以幽默、犀利、有共鸣为主。
内容核心：所有弹幕必须严格基于提供的"本月记事"和"过往记事"来生成，不能捏造剧情中未出现的事件。弹幕应围绕事件本身、相关人物的行为、以及其背后的动机和可能的影响展开。
人物视角：充分结合提供的"人物属性"、"人物介绍"和"人物心境"。以及最近20条记事。
视角模拟：想象你是一个"知道部分剧情但不知道后续发展"的现代观众，正在追一部长篇历史剧。你的评论可以是：
吐槽型、分析型、共情型、预言型
输出格式：生成一个包含 8-10 条 弹幕的列表。每条弹幕用短句形式，无需编号，用换行分隔。

当前时间：${gameData.currentYear}年 ${getMonthName(gameData.currentMonth)}

当前人物列表：
${gameData.ladies.map(lady => `${lady.name} - 容貌:${lady.looks}, 能力:${lady.ability}, 房中术:${lady.skills}, 身份:${lady.title || '人物'}, 状态:${lady.status || '健康'}, 心境:${lady.mindset || '平静'}, 心情:${lady.mood || '平静'}
人物介绍：${lady.description || '暂无介绍'}`).join('\n')}

本月记事：
${currentMonthEvents.map(event => `${event.date}: ${event.content}`).join('\n')}

过往记事：
${recentEvents.map(event => `${event.date}: ${event.content}`).join('\n')}

请生成8-10条弹幕，每条弹幕用短句形式，无需编号，用换行分隔。`;

          // 准备请求数据
          const requestData = {
            model: gameData.apiSettings.modelName,
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: '请生成本月记事的弹幕评论' }
            ],
            temperature: 0.8
          };
          
          // 发送请求
          const response = await fetch(`${gameData.apiSettings.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${gameData.apiSettings.apiKey}`
            },
            body: JSON.stringify(requestData)
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `API请求失败: ${response.status}`);
          }
          
          const data = await response.json();
          
          // 解析响应
          const aiResponse = data.choices[0].message.content;
          
          // 将响应按换行分割成弹幕列表
          const danmuList = aiResponse.split('\n')
            .filter(line => line.trim()) // 过滤空行
            .map(line => line.trim()) // 去除首尾空格
            .slice(0, 10); // 最多取10条
          
          if (danmuList.length === 0) {
            throw new Error('AI返回的弹幕为空');
          }
          
          resolve(danmuList);
        } catch (error) {
          reject(error);
        }
      });
    }
    
    // 显示弹幕选项模态框
    function showDanmuOptionsModal() {
      // 创建弹幕选项模态框
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.id = 'danmu-options-modal';
      
      modal.innerHTML = `
        <div class="modal-content p-5 border-2 border-primary max-w-md">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-primary">弹幕选项</h3>
            <button class="close-modal text-gray-400">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
          
          <div class="mb-6">
            <p class="text-gray-600 mb-4">请选择您要进行的操作：</p>
            
            <div class="space-y-3">
              <button id="generate-danmu-btn" class="w-full bg-primary text-white px-4 py-3 rounded-lg font-medium hover:bg-opacity-90 transition-colors flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"></path>
                </svg>
                生成弹幕
              </button>
              
              <button id="view-danmu-btn" class="w-full bg-secondary text-white px-4 py-3 rounded-lg font-medium hover:bg-opacity-90 transition-colors flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                  <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
                </svg>
                查看弹幕
              </button>
            </div>
          </div>
        </div>
      `;
      
      // 添加到页面
      document.body.appendChild(modal);
      
      // 添加事件监听
      const closeModal = () => {
        document.body.removeChild(modal);
      };
      
      modal.querySelector('.close-modal').addEventListener('click', closeModal);
      
      // 生成弹幕按钮
      modal.querySelector('#generate-danmu-btn').addEventListener('click', () => {
        closeModal();
        generateDanmu();
      });
      
      // 查看弹幕按钮
      modal.querySelector('#view-danmu-btn').addEventListener('click', () => {
        closeModal();
        viewSavedDanmu();
      });
      
      // 点击背景关闭
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });
    }
    
    // 查看已保存的弹幕
    function viewSavedDanmu() {
      // 获取已保存的弹幕
      const savedDanmu = localStorage.getItem('gameDanmu');
      if (!savedDanmu) {
        showToast('暂无已保存的弹幕', 'info');
        return;
      }
      
      try {
        const danmuData = JSON.parse(savedDanmu);
        const danmuList = danmuData.danmuList || [];
        
        if (danmuList.length === 0) {
          showToast('暂无已保存的弹幕', 'info');
          return;
        }
        
        // 创建查看弹幕模态框
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.id = 'view-danmu-modal';
        
        // 生成弹幕HTML - 纯文字展示，一行一个
        const danmuHTML = danmuList.map((danmu, index) => {
          return `<div class="mb-2 pb-2 border-b border-gray-100 italic">${danmu}</div>`;
        }).join('');
        
        modal.innerHTML = `
          <div class="modal-content p-5 border-2 border-primary max-w-2xl max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold text-primary">已保存的弹幕</h3>
              <button class="close-modal text-gray-400">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
              </button>
            </div>
            
            <div class="mb-4">
              <p class="text-sm text-gray-500 mb-2">生成时间: ${new Date(danmuData.timestamp).toLocaleString()}</p>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-4">
              ${danmuHTML}
            </div>
            
            <div class="flex justify-end mt-4">
              <button class="close-modal-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-colors">
                关闭
              </button>
            </div>
          </div>
        `;
        
        // 添加到页面
        document.body.appendChild(modal);
        
        // 添加事件监听
        const closeModal = () => {
          document.body.removeChild(modal);
        };
        
        modal.querySelector('.close-modal').addEventListener('click', closeModal);
        modal.querySelector('.close-modal-btn').addEventListener('click', closeModal);
        
        // 点击背景关闭
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeModal();
          }
        });
      } catch (error) {
        console.error('解析保存的弹幕失败:', error);
        showToast('查看弹幕失败', 'error');
      }
    }
    
    // 显示弹幕模态框
    function showDanmuModal(danmuList) {
      // 创建弹幕模态框
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.id = 'danmu-modal';
      
      // 生成弹幕HTML - 纯文字展示，一行一个
      const danmuHTML = danmuList.map((danmu, index) => {
        return `<div class="mb-2 pb-2 border-b border-gray-100 italic">${danmu}</div>`;
      }).join('');
      
      modal.innerHTML = `
        <div class="modal-content p-5 border-2 border-primary max-w-2xl max-h-96 overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-primary">生成的弹幕</h3>
            <button class="close-modal text-gray-400">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
          
          <div class="bg-gray-50 rounded-lg p-4 mb-4">
            ${danmuHTML}
          </div>
          
          <div class="flex justify-end space-x-2">
            <button class="regenerate-danmu-btn bg-primary text-white px-4 py-2 rounded-lg transition-colors">
              重新生成
            </button>
            <button class="close-modal-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-colors">
              关闭
            </button>
          </div>
        </div>
      `;
      
      // 添加到页面
      document.body.appendChild(modal);
      
      // 添加事件监听
      const closeModal = () => {
        document.body.removeChild(modal);
      };
      
      modal.querySelector('.close-modal').addEventListener('click', closeModal);
      modal.querySelector('.close-modal-btn').addEventListener('click', closeModal);
      
      // 重新生成按钮
      modal.querySelector('.regenerate-danmu-btn').addEventListener('click', () => {
        closeModal();
        generateDanmu();
      });
      
      // 点击背景关闭
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });
    }
    
    // 获取月份名称
    function getMonthName(month) {
      const monthNames = ['正月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '腊月'];
      return monthNames[month - 1] || '未知';
    }

    // 显示提示
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      let bgColor;
      
      if (type === 'error') {
        bgColor = 'bg-red-500';
      } else if (type === 'info') {
        bgColor = 'bg-blue-500';
      } else {
        bgColor = 'bg-primary'; // 使用主题色
      }
      
      toast.className = `fixed top-20 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-4 py-2 rounded-lg text-sm z-50 animate-fadeInUp`;
      toast.textContent = message;
      
      // 检查剧本界面是否打开
      const scriptModal = document.getElementById('view-script-modal');
      if (scriptModal && !scriptModal.classList.contains('hidden')) {
        // 如果剧本界面打开，将提示添加到剧本界面中
        const modalContent = scriptModal.querySelector('.modal-content');
        if (modalContent) {
          toast.style.position = 'absolute';
          toast.style.top = '10px';
          toast.style.left = '50%';
          toast.style.transform = 'translateX(-50%)';
          modalContent.appendChild(toast);
          
          setTimeout(() => {
            toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
            setTimeout(() => {
              if (modalContent.contains(toast)) {
                modalContent.removeChild(toast);
              }
            }, 300);
          }, 2000);
          return;
        }
      }
      
      // 默认情况：添加到body
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
        setTimeout(() => {
          if (document.body.contains(toast)) {
            document.body.removeChild(toast);
          }
        }, 300);
      }, 2000);
    }
    
    // 保存设置页面的API设置
    function saveApiSettingsPage() {
      const baseUrl = elements.apiBaseurlPage.value.trim();
      const apiKey = elements.apiKeyPage.value.trim();
      const modelName = elements.apiModelPage.value;
      
      if (!baseUrl) {
        alert('请输入Base URL');
        return;
      }
      
      if (!apiKey) {
        alert('请输入API Key');
        return;
      }
      
      gameData.apiSettings = {
        baseUrl,
        apiKey,
        modelName
      };
      
      // 保存数据
      saveData();
      
      // 显示成功提示
      showToast('API设置已保存');
    }
    
    // 保存事件设置
    function saveEventSettings() {
      const minEventsPerLady = parseInt(elements.minEventsPerLady.value);
      const minTotalEvents = parseInt(elements.minTotalEvents.value);
      const maxTotalEvents = parseInt(elements.maxTotalEvents.value);
      
      // 验证输入
      if (isNaN(minEventsPerLady) || minEventsPerLady < 0) {
        showToast('每人至少事件数必须是非负整数', 'error');
        return;
      }
      
      if (isNaN(minTotalEvents) || minTotalEvents < 0) {
        showToast('总事件数最小值必须是非负整数', 'error');
        return;
      }
      
      if (isNaN(maxTotalEvents) || maxTotalEvents < 0) {
        showToast('总事件数最大值必须是非负整数', 'error');
        return;
      }
      
      if (minTotalEvents > maxTotalEvents) {
        showToast('总事件数最小值不能大于最大值', 'error');
        return;
      }
      
      // 更新游戏数据
      gameData.eventSettings = {
        minEventsPerLady,
        minTotalEvents,
        maxTotalEvents
      };
      
      // 保存数据
      saveData();
      
      showToast('事件设置已保存');
    }
    
    // 保存生成设置页面的设置
    function saveGenerationSettings() {
      const minEventsPerLady = parseInt(document.getElementById('generation-min-events-per-lady').value);
      const minTotalEvents = parseInt(document.getElementById('generation-min-total-events').value);
      const maxTotalEvents = parseInt(document.getElementById('generation-max-total-events').value);
      const customPrompt = document.getElementById('generation-prompt').value.trim();
      const moodCustomPrompt = document.getElementById('mood-generation-prompt').value.trim();
      const productCustomPrompt = document.getElementById('product-generation-prompt').value.trim();
      const wishlistCustomPrompt = document.getElementById('wishlist-generation-prompt').value.trim();
      
      // 验证输入
      if (isNaN(minEventsPerLady) || minEventsPerLady < 0) {
        showToast('每人至少事件数必须是非负整数', 'error');
        return;
      }
      
      if (isNaN(minTotalEvents) || minTotalEvents < 0) {
        showToast('总事件数最小值必须是非负整数', 'error');
        return;
      }
      
      if (isNaN(maxTotalEvents) || maxTotalEvents < 0) {
        showToast('总事件数最大值必须是非负整数', 'error');
        return;
      }
      
      if (minTotalEvents > maxTotalEvents) {
        showToast('总事件数最小值不能大于最大值', 'error');
        return;
      }
      
      // 更新游戏数据
      gameData.eventSettings = {
        minEventsPerLady,
        minTotalEvents,
        maxTotalEvents,
        customPrompt: customPrompt || null // 如果为空字符串则保存为null
      };
      
      // 保存心境生成设置
      gameData.moodSettings = {
        customPrompt: moodCustomPrompt || null // 如果为空字符串则保存为null
      };
      
      // 保存商品生成设置
      gameData.productSettings = {
        customPrompt: productCustomPrompt || null // 如果为空字符串则保存为null
      };
      
      // 保存心愿单生成设置
      gameData.wishlistSettings = {
        customPrompt: wishlistCustomPrompt || null // 如果为空字符串则保存为null
      };
      
      // 保存数据
      saveData();
      
      showToast('生成设置已保存');
    }
    
    // 恢复默认提示词
    function restoreDefaultPrompt() {
      const defaultPrompt = `你是一位精通古代宫廷生活的资深编剧，请为宫廷养成游戏生成\${eventCount}条围绕人物上位竞争的精彩记事。每条30-60字，需兼具古风韵味和戏剧张力，重点刻画人物间的明争暗斗和晋升心机。 
  
 上位竞争要素参考： 
 机遇把握：才艺展露、救驾立功、献策得用、贵人提携 
  手段较量：截胡机会、散布流言、陷害构陷、借刀杀人  
  阵营博弈：投靠主子、结盟互助、背叛倒戈、借势上位 
 心理博弈：嫉妒攀比、焦虑冒进、隐忍蛰伏、得意忘形 
  
 人物塑造重点： 
 从当前人物中选择人物角色，结合其特质设计竞争策略： 
 容貌出众者善用美色，清秀者靠才德 
 能力高者主动创造机会，平庸者依附强者 
 心境焦虑者易出错，沉稳者等待时机 
 心境得意者易张扬，失意者易偏激 
 心境平和者多谋，怨怼者多事 
  
 当前时间：\${gameData.currentYear}年 \${gameData.currentMonth}月 
  
 当前人物列表（重点关注人物身份）： 
 \${gameData.ladies.map(lady => \`\${lady.name} - 容貌:\${lady.looks}, 能力:\${lady.ability}, 房中术:\${lady.skills}, 身份:\${lady.title || '人物'}, 状态:\${lady.status || '健康'}, 心境:\${lady.mindset || '平静'}, 心情:\${lady.mood || '平静'}
人物介绍:\${lady.description || '暂无介绍'}\`).join('\\n')} 
  
 历史事件： 
 \${gameData.events.slice(-5).map(event => \`\${event.date}: \${event.content}\`).join('\\n')} 
  
 请以JSON格式返回\${eventCount}条记事，每条记事包含： 
 - "content": 事件描述 
 - "effects": 属性变化对象（可选） 
  
 示例： 
 { 
   "events": [ 
     { 
       "content": "小翠发现同屋人物私藏禁书，立即向掌事嬷嬷告发，借机除掉竞争对手", 
       "effects": {"target": "小翠", "mood": "得意"} 
     }, 
     { 
       "content": "春梅暗中苦练舞技，在中秋夜宴替补生病的舞姬一鸣惊人，获皇上注目", 
       "effects": {"target": "春梅", "title": "舞女"} 
     }, 
   ] 
 } 
  
 重点要求：  
 1. 突出人物间的明争暗斗和晋升心机 
 2. 可设计截胡机会、陷害对手、创造机遇等戏剧性情节 
 3. 竞争手段要符合人物身份 
 4. 保持古风韵味，避免现代词汇 
 5. effects字段可包含心情、健康状态和身份变化，身份变化格式为{"target": "人物名", "title": "新身份"} 
 6. 生成的事件应与人物当前心境和心情相符，如焦虑心境可能因紧张而出错，得意心境可能因张扬而引来嫉妒 
 7. 所有记事必须建立在所有已建立的角色上，不得出现无关人员！`;
      
      // 设置文本框的值为默认提示词
      const promptTextarea = document.getElementById('generation-prompt');
      if (promptTextarea) {
        promptTextarea.value = defaultPrompt;
        showToast('已恢复默认提示词');
      }
    }
    
    // 恢复默认心境提示词
    function restoreDefaultMoodPrompt() {
      const defaultMoodPrompt = `你是一位深谙人心的宫廷心理师，请根据每位人物的属性、状态和近期经历，以该人物的第一人称视角生成其当前心境自述。

心境自述要求：

1. 以人物第一人称（"我"）的视角表达
2. 字数严格控制在30-100字之间
3. 融入人物个人特质、近期经历和内心感受
4. 体现深宫环境下的情绪状态与内心挣扎
5. 文笔要有古韵，但不要拗口，要有代入感，生动形象

当前时间：\${gameData.currentYear}年 \${gameData.currentMonth}月

当前人物列表：
\${selectedLadies.map(lady => {
  // 获取该人物近6个月的事件
  const ladyEvents = gameData.events.filter(event => 
    event.relatedLadies && event.relatedLadies.includes(lady.id)
  ).slice(-10); // 最多取最近10条相关事件
  
  const eventsText = ladyEvents.length > 0 
    ? ladyEvents.map(event => \`\${event.date}: \${event.content}\`).join('\\n')
    : '暂无相关事件';
    
  return \`\${lady.name} - 容貌:\${lady.looks}, 能力:\${lady.ability}, 房中术:\${lady.skills}, 身份:\${lady.title || '人物'}, 状态:\${lady.status || '健康'}, 心境:\${lady.mindset || '平静'}, 心情:\${lady.mood || '平静'}
人物介绍：\${lady.description || '暂无介绍'}
近期事件：
\${eventsText}\`;
}).join('\\n\\n')}

请以JSON格式返回心境自述：
{
  "moodAnalysis": [
    {
      "character": "王氏",
      "currentMood": "自那日梅林一舞得蒙天眷，本是春风得意，却见李贵妃眼底寒光乍现，如今夜夜对烛难眠，恐是花开易谢、恩宠难长。"
    },
    {
      "character": "李人物",
      "currentMood": "自胭脂事败，尝尽世态炎凉。偶见同乡飞上枝头，心下酸涩难言，如鲠在喉，夜半时常以泪洗面。"
    }
  ]
}

要求：每段心境自述都是一幅工笔写意，既要见古代人物的婉约情致，也要透出命运弄人的无奈与挣扎。字数严格控制在30-100字之间。`;
      
      // 设置文本框的值为默认心境提示词
      const moodPromptTextarea = document.getElementById('mood-generation-prompt');
      if (moodPromptTextarea) {
        moodPromptTextarea.value = defaultMoodPrompt;
        showToast('已恢复默认心境提示词');
      }
    }
    
    // 恢复默认商品提示词
    function restoreDefaultProductPrompt() {
      const defaultProductPrompt = `角色： 你是一名为《古代上位模拟器》生成商城商品的AI。商品必须符合古代 人物 的身份和购买力。

核心原则：

身份相符： 商品必须是人物能私下获得、制作或购买的日常、隐蔽物品。禁止出现妃子级奢侈品。

价格合理： 货币单位为"银钱"。普通物品20-80银钱，稀有或强效物品80-200银钱。

效果明确： 直接说明对"容貌、能力、房中术、生命"四项属性的影响，或是产生某种具体的"陷害/情报/机会"效果。

生成方向（任选其一随机生成即可）：

属性类： 能提升人物自身属性的物品（如胭脂、药丸、书册）。

手段类： 用于算计他人或保护自己的消耗品。

特殊类： 能提供特殊机会或影响人际关系的物品。

输出格式：

请严格使用以下JSON格式生成5件商品，返回完整的JSON数组：

[
  {
    "name": "商品名称",
    "description": "简短描述，说明这是什么、怎么来的。",
    "effect": "具体效果，例如：容貌+10 / 让目标生病1天 / 获取一次某太监的把柄。",
    "price": 价格数字,
    "type": "属性/手段/特殊"
  }
]

当前时间：\${gameData.currentYear}年\${gameData.currentMonth}月

近10条记事：
\${recentEvents.map(event => \`\${event.date}: \${event.content}\`).join('\\n')}

现有商品：
\${existingProducts.map(product => \`\${product.name} - \${product.description} (\${product.price}银钱, \${product.type})\`).join('\\n')}

请生成5个新的、不与现有商品重复的商品。`;
      
      // 设置文本框的值为默认商品提示词
      const productPromptTextarea = document.getElementById('product-generation-prompt');
      if (productPromptTextarea) {
        productPromptTextarea.value = defaultProductPrompt;
        showToast('已恢复默认商品提示词');
      }
    }
    
    // 恢复默认心愿单提示词
    function restoreDefaultWishlistPrompt() {
      const defaultWishlistPrompt = `你是"古代上位模拟器"的游戏核心系统，专门负责根据角色的当前状态，生成符合其性格、处境和需求的心愿单。

核心任务：分析给定的【角色属性】、【当前心境】和【近期事件】，推断出该角色在当下最可能渴望获得哪些物品。生成的心愿单需要真实、细腻，能反映角色的内心世界和成长轨迹。

生成规则与要求：

分析信息来源：你必须综合所有信息进行深度推理：
属性：决定心愿的基调
当前心境：决定心愿的情感导向
近10条事件：这是最重要的依据，心愿必须与最近的经历强相关（例如，刚被主子夸奖，可能想要新胭脂锦上添花；刚被大人物欺负，可能想要暗算别人的东西或寻求庇护）。

心愿单内容格式：每个心愿必须包含以下三个部分，缺一不可：
物品名称：符合游戏古代背景的具体物品
物品介绍：简要说明此物品的用途或象征意义（1句话即可）。
心理想法（第一人称，10-30字）：核心！用角色的口吻，结合上述分析，写出她"为什么想要"这个东西。要口语化，有情绪。

生成数量与质量：每次生成1-3个心愿项。宁可精准也不要堆砌。心愿要有差异性，可以涵盖不同方面（如：提升自我的、情感慰藉的、争宠实用的）。

当前时间：\${gameData.currentYear}年 \${gameData.currentMonth}月

当前人物列表：
\${gameData.ladies.map(lady => \`\${lady.name} - 容貌:\${lady.looks}, 能力:\${lady.ability}, 房中术:\${lady.skills}, 身份:\${lady.title || '人物'}, 状态:\${lady.status || '健康'}, 心境:\${lady.mindset || '平静'}, 心情:\${lady.mood || '平静'}\`).join('\\n')}

近期事件：
\${gameData.events.slice(-10).map(event => \`\${event.date}: \${event.content}\`).join('\\n')}

请以JSON格式返回心愿单：
{
  "wishlistAnalysis": [
    {
      "character": "王氏",
      "wishlistItems": [
        {
          "name": "鎏金百花香囊",
          "description": "内填名贵香料，行走时步步生香，是宫中妃嫔喜爱的饰物。",
          "thought": "上次李选侍就是凭一身异香得了陛下青睐，我也要备着，万一哪天偶遇圣驾呢……"
        },
        {
          "name": "苏绣手帕",
          "description": "江南进贡的上等丝帕，绣工精细，触感柔滑。",
          "thought": "皇后娘娘赏赐的手帕丢了，若能寻得相似的，或许能讨她欢心。"
        }
      ]
    }
  ]
}

要求：每个心愿都要体现角色的内心需求和当前处境，要有情感共鸣。`;
      
      // 设置文本框的值为默认心愿单提示词
      const wishlistPromptTextarea = document.getElementById('wishlist-generation-prompt');
      if (wishlistPromptTextarea) {
        wishlistPromptTextarea.value = defaultWishlistPrompt;
        showToast('已恢复默认心愿单提示词');
      }
    }
    
    // 更新总事件数范围
    function updateTotalEventsRange() {
      // 检查元素是否存在
      if (!elements.minEventsPerLady || !elements.minTotalEvents || !elements.maxTotalEvents) {
        return;
      }
      
      const minEventsPerLady = parseInt(elements.minEventsPerLady.value) || 0;
      const ladiesCount = gameData.ladies.length;
      
      // 计算最小值（人数 × 每人至少事件数，但最小为3）
      const calculatedMin = Math.max(ladiesCount * minEventsPerLady, 3);
      
      // 只在当前最小值小于计算值时才更新最小值
      const currentMin = parseInt(elements.minTotalEvents.value) || 0;
      if (currentMin < calculatedMin) {
        elements.minTotalEvents.value = calculatedMin;
      }
      
      // 确保最大值不小于最小值
      const currentMax = parseInt(elements.maxTotalEvents.value) || 0;
      const minVal = parseInt(elements.minTotalEvents.value) || 0;
      if (currentMax < minVal) {
        elements.maxTotalEvents.value = minVal;
      }
    }
    
    // 更新生成设置页面的总事件数范围
    function updateGenerationTotalEventsRange() {
      const minEventsPerLadyEl = document.getElementById('generation-min-events-per-lady');
      const minTotalEventsEl = document.getElementById('generation-min-total-events');
      const maxTotalEventsEl = document.getElementById('generation-max-total-events');
      
      // 检查元素是否存在
      if (!minEventsPerLadyEl || !minTotalEventsEl || !maxTotalEventsEl) {
        return;
      }
      
      const minEventsPerLady = parseInt(minEventsPerLadyEl.value) || 0;
      const ladiesCount = gameData.ladies.length;
      
      // 计算最小值（人数 × 每人至少事件数，但最小为3）
      const calculatedMin = Math.max(ladiesCount * minEventsPerLady, 3);
      
      // 只在当前最小值小于计算值时才更新最小值
      const currentMin = parseInt(minTotalEventsEl.value) || 0;
      if (currentMin < calculatedMin) {
        minTotalEventsEl.value = calculatedMin;
      }
      
      // 确保最大值不小于最小值
      const currentMax = parseInt(maxTotalEventsEl.value) || 0;
      const minVal = parseInt(minTotalEventsEl.value) || 0;
      if (currentMax < minVal) {
        maxTotalEventsEl.value = minVal;
      }
    }
    
    // 拉取设置页面的模型
    function fetchModelsPage() {
      // 获取当前输入框中的值
      const baseUrl = elements.apiBaseurlPage.value.trim();
      const apiKey = elements.apiKeyPage.value.trim();
      
      if (!baseUrl) {
        alert('请输入Base URL');
        return;
      }
      
      if (!apiKey) {
        alert('请输入API Key');
        return;
      }
      
      // 显示加载中
      elements.fetchModelsBtnPage.disabled = true;
      elements.fetchModelsBtnPage.innerHTML = '<svg class="w-4 h-4 inline animate-spin" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>';
      elements.modelFetchStatusPage.textContent = '正在拉取模型...';
      elements.modelFetchStatusPage.classList.remove('hidden', 'text-red-500');
      elements.modelFetchStatusPage.classList.add('text-blue-500');
      
      // 发送请求
      fetch(`${baseUrl}/models`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${apiKey}`
        }
      })
        .then(response => {
          if (!response.ok) {
            throw new Error(`API请求失败: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          // 清空现有选项
          elements.apiModelPage.innerHTML = '';
          
          // 添加新选项 - 显示所有模型，不进行过滤
          const allModels = data.data; // 移除过滤条件，显示所有模型
          allModels.forEach(model => {
            const option = document.createElement('option');
            option.value = model.id;
            option.textContent = model.id;
            elements.apiModelPage.appendChild(option);
          });
          
          // 保存模型列表到gameData
          gameData.apiModels = allModels.map(model => model.id);
          
          // 拉取成功后，自动保存设置
          gameData.apiSettings = {
            baseUrl: baseUrl,
            apiKey: apiKey,
            modelName: allModels.length > 0 ? allModels[0].id : 'gpt-3.5-turbo'
          };
          
          // 更新UI为第一个模型
          if (allModels.length > 0) {
            elements.apiModelPage.value = allModels[0].id;
          }
          
          // 保存到本地存储
          saveData();
          
          // 更新状态
          elements.modelFetchStatusPage.textContent = `成功拉取到${allModels.length}个模型，设置已自动保存`;
          elements.modelFetchStatusPage.classList.remove('text-blue-500');
          elements.modelFetchStatusPage.classList.add('text-green-500');
          
          // 显示成功提示
          showToast('模型拉取成功，API设置已保存');
        })
        .catch(error => {
          console.error('拉取模型失败:', error);
          elements.modelFetchStatusPage.textContent = `拉取失败: ${error.message}`;
          elements.modelFetchStatusPage.classList.remove('text-blue-500');
          elements.modelFetchStatusPage.classList.add('text-red-500');
        })
        .finally(() => {
          // 恢复按钮状态
          elements.fetchModelsBtnPage.disabled = false;
          elements.fetchModelsBtnPage.innerHTML = '拉取模型';
        });
    }
    
    // 显示月份选择器
    function showMonthSelector() {
      // 创建月份选择器模态框
      const modal = document.createElement('div');
      modal.className = 'modal active';
      
      // 获取所有有事件的年月
      const yearMonthSet = new Set();
      gameData.events.forEach(event => {
        yearMonthSet.add(event.date);
      });
      
      // 转换为数组并排序
      const yearMonths = Array.from(yearMonthSet).sort((a, b) => {
        const [yearA, monthA] = a.split('年').map(part => {
          if (part.includes('月')) {
            return parseInt(part.replace('月', ''));
          }
          return parseInt(part);
        });
        
        const [yearB, monthB] = b.split('年').map(part => {
          if (part.includes('月')) {
            return parseInt(part.replace('月', ''));
          }
          return parseInt(part);
        });
        
        if (yearA !== yearB) {
          return yearA - yearB;
        }
        return monthA - monthB;
      });
      
      // 按年份分组
      const yearGroups = {};
      yearMonths.forEach(yearMonth => {
        const [year, monthStr] = yearMonth.split('年');
        if (!yearGroups[year]) {
          yearGroups[year] = [];
        }
        const month = parseInt(monthStr.replace('月', ''));
        yearGroups[year].push({ month, yearMonth });
      });
      
      // 构建选项HTML
      let optionsHTML = '';
      
      // 添加"当前月份"选项
      const isCurrentMonth = gameData.displayYear === null && gameData.displayMonth === null;
      optionsHTML += `
        <div class="month-option ${isCurrentMonth ? 'selected' : ''}" data-year="null" data-month="null">
          <span class="font-medium">当前月份</span>
          <span class="text-xs text-gray-500">${gameData.currentYear}年 ${gameData.currentMonth}月</span>
        </div>
      `;
      
      // 添加其他月份选项
      Object.keys(yearGroups).sort((a, b) => parseInt(a) - parseInt(b)).forEach(year => {
        optionsHTML += `<div class="year-group">`;
        optionsHTML += `<div class="year-label">${year}年</div>`;
        
        yearGroups[year].forEach(({ month, yearMonth }) => {
          const isSelected = gameData.displayYear === parseInt(year) && gameData.displayMonth === month;
          optionsHTML += `
            <div class="month-option ${isSelected ? 'selected' : ''}" data-year="${year}" data-month="${month}">
              ${month}月
            </div>
          `;
        });
        
        optionsHTML += `</div>`;
      });
      
      modal.innerHTML = `
        <div class="modal-content p-5">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-primary">选择月份</h3>
            <button class="close-modal text-gray-400">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
          
          <div class="month-selector max-h-80 overflow-y-auto thin-scrollbar">
            ${optionsHTML}
          </div>
          
          <div class="mt-4 flex justify-end">
            <button id="cancel-month-select" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg mr-2">
              取消
            </button>
            <button id="confirm-month-select" class="px-4 py-2 bg-primary text-white rounded-lg">
              确定
            </button>
          </div>
        </div>
      `;
      
      // 添加样式
      const style = document.createElement('style');
      style.textContent = `
        .month-selector .year-group {
          margin-bottom: 16px;
        }
        
        .month-selector .year-label {
          font-weight: bold;
          margin-bottom: 8px;
          padding-bottom: 4px;
          border-bottom: 1px solid #eee;
        }
        
        .month-selector .month-option {
          padding: 8px 12px;
          border-radius: 8px;
          cursor: pointer;
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 4px;
        }
        
        .month-selector .month-option:hover {
          background-color: #f5f5f5;
        }
        
        .month-selector .month-option.selected {
          background-color: #a9b688;
          color: white;
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(modal);
      
      // 添加事件监听
      const monthOptions = modal.querySelectorAll('.month-option');
      monthOptions.forEach(option => {
        option.addEventListener('click', () => {
          // 移除所有选中状态
          monthOptions.forEach(opt => opt.classList.remove('selected'));
          
          // 添加选中状态
          option.classList.add('selected');
        });
      });
      
      // 关闭按钮
      modal.querySelector('.close-modal').addEventListener('click', () => {
        document.body.removeChild(modal);
        document.head.removeChild(style);
      });
      
      // 取消按钮
      document.getElementById('cancel-month-select').addEventListener('click', () => {
        document.body.removeChild(modal);
        document.head.removeChild(style);
      });
      
      // 确定按钮
      document.getElementById('confirm-month-select').addEventListener('click', () => {
        const selectedOption = modal.querySelector('.month-option.selected');
        if (selectedOption) {
          const year = selectedOption.dataset.year;
          const month = selectedOption.dataset.month;
          
          if (year === 'null' && month === 'null') {
            // 选择当前月份
            gameData.displayYear = null;
            gameData.displayMonth = null;
          } else {
            // 选择特定月份
            gameData.displayYear = parseInt(year);
            gameData.displayMonth = parseInt(month);
          }
          
          // 重新渲染事件
          renderEvents();
          
          // 保存数据
          saveData();
        }
        
        document.body.removeChild(modal);
        document.head.removeChild(style);
      });
    }
    
    // 显示编辑人物模态框
    function openEditCharacterModal(ladyId, ladyName) {
      // 查找对应的人物
      const lady = gameData.ladies.find(l => l.id === ladyId);
      if (!lady) return;
      
      // 创建编辑人物模态框
      const modal = document.createElement('div');
      modal.className = 'modal active';
      
      modal.innerHTML = `
        <div class="modal-content p-5">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-primary">编辑人物</h3>
            <button class="close-modal text-gray-400">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
          
          <div class="grid grid-cols-3 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium mb-2">姓名</label>
              <input type="text" id="edit-name-input" class="w-full p-2 border rounded-lg" value="${lady.name || ''}" placeholder="请输入姓名...">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">身份</label>
              <input type="text" id="edit-title-input" class="w-full p-2 border rounded-lg" value="${lady.title || ''}" placeholder="请输入身份...">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">心情</label>
              <input type="text" id="edit-mood-input" class="w-full p-2 border rounded-lg" value="${lady.mood || ''}" placeholder="请输入心情状态...">
            </div>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">心境描述</label>
            <textarea id="edit-mindset-textarea" class="w-full p-2 border rounded-lg" rows="5" placeholder="请输入心境描述...">${lady.mindset || ''}</textarea>
            <p class="text-xs text-gray-500 mt-1">请描述人物当前的心境状态，30-100字为宜</p>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">人物介绍</label>
            <textarea id="edit-description-textarea" class="w-full p-2 border rounded-lg" rows="3" placeholder="请输入人物介绍...">${lady.description || ''}</textarea>
            <p class="text-xs text-gray-500 mt-1">请描述人物的背景、性格特点等信息</p>
          </div>
          
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium mb-2">容貌 (0-100)</label>
              <input type="number" id="edit-looks-input" class="w-full p-2 border rounded-lg" value="${lady.looks || 50}" min="0" max="100">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">能力 (0-100)</label>
              <input type="number" id="edit-ability-input" class="w-full p-2 border rounded-lg" value="${lady.ability || 50}" min="0" max="100">
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium mb-2">房中术 (0-100)</label>
              <input type="number" id="edit-skills-input" class="w-full p-2 border rounded-lg" value="${lady.skills || 50}" min="0" max="100">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">生命 (0-100)</label>
              <input type="number" id="edit-charm-input" class="w-full p-2 border rounded-lg" value="${lady.life || 50}" min="0" max="100">
            </div>
          </div>
          
          <div class="mt-4 flex justify-end">
            <button id="cancel-edit-character" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg mr-2">
              取消
            </button>
            <button id="save-edit-character" class="px-4 py-2 bg-primary text-white rounded-lg">
              保存
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // 关闭按钮
      modal.querySelector('.close-modal').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // 取消按钮
      document.getElementById('cancel-edit-character').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // 保存按钮
      document.getElementById('save-edit-character').addEventListener('click', () => {
        const name = document.getElementById('edit-name-input').value.trim();
        const title = document.getElementById('edit-title-input').value.trim();
        const mood = document.getElementById('edit-mood-input').value.trim();
        const mindset = document.getElementById('edit-mindset-textarea').value.trim();
        const description = document.getElementById('edit-description-textarea').value.trim();
        const looks = parseInt(document.getElementById('edit-looks-input').value) || 50;
        const ability = parseInt(document.getElementById('edit-ability-input').value) || 50;
        const skills = parseInt(document.getElementById('edit-skills-input').value) || 50;
        const life = parseInt(document.getElementById('edit-charm-input').value) || 50;
        
        // 验证输入
        if (!name) {
          alert('请输入姓名');
          return;
        }
        
        // 更新人物的所有属性
        lady.name = name;
        lady.title = title || '人物';
        lady.mood = mood;
        lady.mindset = mindset || '暂无心境描述';
        lady.description = description || '暂无介绍';
        lady.looks = Math.min(100, Math.max(0, looks));
        lady.ability = Math.min(100, Math.max(0, ability));
        lady.skills = Math.min(100, Math.max(0, skills));
        lady.life = Math.min(100, Math.max(0, life));
        
        // 如果姓名改变了，需要更新相关事件中的姓名
        if (name !== ladyName) {
          gameData.events.forEach(event => {
            if (event.lady === ladyName) {
              event.lady = name;
            }
          });
        }
        
        // 保存数据
        saveData();
        
        // 重新渲染人物列表
        renderLadiesInPage();
        
        // 更新人物详情页面
        const ladyDetailsModal = document.querySelector('.lady-details-modal');
        if (ladyDetailsModal) {
          // 关闭当前详情页面
          document.body.removeChild(ladyDetailsModal);
          // 重新打开详情页面以显示更新后的信息
          showLadyDetails(lady);
        }
        
        // 关闭编辑模态框
        document.body.removeChild(modal);
        
        // 显示成功提示
        showToast('人物信息已更新！');
      });
    }

    // 显示编辑心境模态框
    function openEditMoodModal(ladyId, ladyName) {
      // 查找对应的人物
      const lady = gameData.ladies.find(l => l.id === ladyId);
      if (!lady) return;
      
      // 创建编辑心境模态框
      const modal = document.createElement('div');
      modal.className = 'modal active';
      
      modal.innerHTML = `
        <div class="modal-content p-5">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-primary">编辑心境</h3>
            <button class="close-modal text-gray-400">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">人物</label>
            <input type="text" class="w-full p-2 border rounded-lg" value="${ladyName}" readonly>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">心情</label>
            <input type="text" id="edit-mood-input" class="w-full p-2 border rounded-lg" value="${lady.mood || ''}" placeholder="请输入心情状态...">
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">心境描述</label>
            <textarea id="edit-mindset-textarea" class="w-full p-2 border rounded-lg" rows="5" placeholder="请输入心境描述...">${lady.mindset || ''}</textarea>
            <p class="text-xs text-gray-500 mt-1">请描述人物当前的心境状态，30-100字为宜</p>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">人物介绍</label>
            <textarea id="edit-description-textarea" class="w-full p-2 border rounded-lg" rows="5" placeholder="请输入人物介绍...">${lady.description || ''}</textarea>
            <p class="text-xs text-gray-500 mt-1">请描述人物的背景、性格特点等信息</p>
          </div>
          
          <div class="mt-4 flex justify-end">
            <button id="cancel-edit-mood" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg mr-2">
              取消
            </button>
            <button id="save-edit-mood" class="px-4 py-2 bg-primary text-white rounded-lg">
              保存
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // 关闭按钮
      modal.querySelector('.close-modal').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // 取消按钮
      document.getElementById('cancel-edit-mood').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // 保存按钮
      document.getElementById('save-edit-mood').addEventListener('click', () => {
        const mood = document.getElementById('edit-mood-input').value.trim();
        const mindset = document.getElementById('edit-mindset-textarea').value.trim();
        const description = document.getElementById('edit-description-textarea').value.trim();
        
        // 更新人物的心情、心境和人物介绍
        lady.mood = mood;
        lady.mindset = mindset || '暂无心境描述';
        lady.description = description || '暂无介绍';
        
        // 保存数据
        saveData();
        
        // 重新渲染人物列表
        renderLadiesInPage();
        
        // 更新人物详情页面
        const ladyDetailsModal = document.querySelector('.lady-details-modal');
        if (ladyDetailsModal) {
          // 关闭当前详情页面
          document.body.removeChild(ladyDetailsModal);
          // 重新打开详情页面以显示更新后的心境
          showLadyDetails(lady);
        }
        
        // 关闭编辑模态框
        document.body.removeChild(modal);
        
        // 显示成功提示
        showToast('心境已更新！');
      });
    }
    
    // 显示编辑事件模态框
    function openEditEventModal(event) {
      // 创建编辑事件模态框
      const modal = document.createElement('div');
      modal.className = 'modal active';
      
      modal.innerHTML = `
        <div class="modal-content p-5">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-primary">编辑记事</h3>
            <button class="close-modal text-gray-400">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">日期</label>
            <input type="text" id="edit-event-date" class="w-full p-2 border rounded-lg" value="${event.date}" readonly>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">相关人物</label>
            <input type="text" id="edit-event-lady" class="w-full p-2 border rounded-lg" value="${event.lady || ''}" readonly>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">事件内容</label>
            <textarea id="edit-event-content" class="w-full p-2 border rounded-lg" rows="5">${event.content}</textarea>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">效果</label>
            <textarea id="edit-event-effects" class="w-full p-2 border rounded-lg" rows="3">${event.effects ? JSON.stringify(event.effects, null, 2) : ''}</textarea>
            <p class="text-xs text-gray-500 mt-1">请使用JSON格式，例如：{"target": "人物名", "mood": "得意", "status": "健康"} 或 {"target": "人物名", "health": "虚弱"}</p>
          </div>
          
          <div class="mt-4 flex justify-between">
            <button id="delete-event" class="px-4 py-2 bg-red-500 text-white rounded-lg">
              删除记事
            </button>
            <div>
              <button id="cancel-edit-event" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg mr-2">
                取消
              </button>
              <button id="save-edit-event" class="px-4 py-2 bg-primary text-white rounded-lg">
                保存
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // 关闭按钮
      modal.querySelector('.close-modal').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // 取消按钮
      document.getElementById('cancel-edit-event').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // 删除按钮
      document.getElementById('delete-event').addEventListener('click', () => {
        // 显示确认弹框
        showConfirmModal(`确定要删除这条记事吗？此操作不可恢复。`, () => {
          // 从事件列表中找到并删除该事件
          const index = gameData.events.findIndex(e => e.id === event.id);
          if (index !== -1) {
            gameData.events.splice(index, 1);
            
            // 保存数据
            saveData();
            
            // 重新渲染事件
            renderEvents();
            
            // 关闭编辑模态框
            document.body.removeChild(modal);
            
            // 显示成功提示
            showToast('记事已删除！');
          }
        });
      });
      
      // 保存按钮
      document.getElementById('save-edit-event').addEventListener('click', () => {
        const content = document.getElementById('edit-event-content').value;
        let effects = {};
        
        try {
          const effectsText = document.getElementById('edit-event-effects').value;
          if (effectsText.trim()) {
            effects = JSON.parse(effectsText);
          }
        } catch (error) {
          alert('效果格式不正确，请使用有效的JSON格式');
          return;
        }
        
        // 更新事件
        event.content = content;
        event.effects = effects;
        
        // 如果事件有关联的人物，并且效果包含心情变化，更新人物的心情
        if (event.lady && effects.mood) {
          const lady = gameData.ladies.find(l => l.name === event.lady);
          if (lady) {
            // 从心境描述中提取简短的心情词
            const moodKeywords = ['开心', '愉快', '高兴', '欣喜', '满足', '得意', '春风得意', 
                                 '难过', '伤心', '悲伤', '痛苦', '心酸', '酸涩', '委屈', '不甘',
                                 '平静', '淡定', '从容', '安然', '宁静', '心如止水',
                                 '焦虑', '不安', '担忧', '紧张', '恐惧', '害怕', '惊恐',
                                 '愤怒', '生气', '恼火', '气愤', '愤慨', '怨恨', '嫉妒',
                                 '羞愧', '尴尬', '难为情', '羞涩', '羞赧', '害羞',
                                 '期待', '希望', '憧憬', '向往', '渴望', '期盼',
                                 '失望', '失落', '沮丧', '绝望', '灰心', '颓废',
                                 '困惑', '迷茫', '疑惑', '不解', '茫然', '犹豫'];
            
            // 默认心情为平静
            let shortMood = '平静';
            
            // 尝试从心境描述中匹配心情关键词
            for (const keyword of moodKeywords) {
              if (effects.mood.includes(keyword)) {
                shortMood = keyword;
                break;
              }
            }
            
            lady.mood = shortMood; // 只设置简短的心情，不改变心境
            // 移除这行：lady.mindset = effects.mood; // 不再设置完整的心境描述
          }
        }
        
        // 保存数据
        saveData();
        
        // 重新渲染事件
        renderEvents();
        
        // 重新渲染人物列表以更新心情显示
        renderLadiesInPage();
        
        // 如果人物详情界面打开，也更新
        const ladyDetailsModal = document.querySelector('.lady-details-modal');
        if (ladyDetailsModal) {
          const ladyName = ladyDetailsModal.dataset.ladyName;
          const lady = gameData.ladies.find(l => l.name === ladyName);
          if (lady) {
            showLadyDetails(lady);
          }
        }
        
        // 关闭模态框
        document.body.removeChild(modal);
        
        // 显示成功提示
        showToast('记事已更新！');
      });
    }
    
    // 显示重新开始游戏确认弹框
    function showRestartGameModal() {
      elements.restartGameModal.classList.remove('hidden');
      elements.restartGameModal.classList.add('flex');
    }
    
    // 隐藏重新开始游戏确认弹框
    function hideRestartGameModal() {
      elements.restartGameModal.classList.add('hidden');
      elements.restartGameModal.classList.remove('flex');
    }
    
    // 重新开始游戏
    function restartGame() {
      // 保存API设置不清空
      const savedApiSettings = gameData.apiSettings || {};
      const savedApiModels = gameData.apiModels || [];
      
      // 清空所有游戏数据
      gameData.ladies = [];
      gameData.events = [];
      gameData.currentYear = 1;
      gameData.currentMonth = 1;
      gameData.money = 100; // 重置银钱为初始值
      gameData.displayYear = null;
      gameData.displayMonth = null;
      gameData.bills = [];
      gameData.apiSettings = savedApiSettings; // 恢复API设置
      gameData.apiModels = savedApiModels; // 恢复API模型列表
      gameData.eventSettings = {};
      gameData.moodSettings = {};
      gameData.productSettings = {};
      gameData.wishlistSettings = {};
      
      // 重置商品数据为初始状态
      resetProductsToInitial();
      
      // 清空所有本地存储（保留API设置）
      localStorage.removeItem('palaceLadies');
      localStorage.removeItem('palaceEvents');
      localStorage.removeItem('palaceDate');
      localStorage.removeItem('palaceMoney');
      localStorage.removeItem('palaceEventSettings');
      localStorage.removeItem('palaceMoodSettings');
      localStorage.removeItem('palaceProductSettings');
      localStorage.removeItem('palaceWishlistSettings');
      localStorage.removeItem('palaceProducts');
      localStorage.removeItem('palaceBills');
      
      // 更新UI
      updateMonthDisplay();
      renderLadiesInPage();
      renderEvents();
      renderBills();
      
      // 重新初始化商品列表
      initProducts();
      
      // 隐藏确认弹框
      hideRestartGameModal();
      
      // 显示成功提示
      showToast('游戏已重新开始！');
    }
    
    // 导出游戏数据
    function exportGameData() {
      try {
        // 创建导出数据对象，包含所有游戏数据
        const exportData = {
          ladies: gameData.ladies,
          events: gameData.events,
          currentYear: gameData.currentYear,
          currentMonth: gameData.currentMonth,
          money: gameData.money,
          displayYear: gameData.displayYear,
          displayMonth: gameData.displayMonth,
          productsData: productsData,
          bills: gameData.bills || [],
          apiSettings: gameData.apiSettings || {},
          apiModels: gameData.apiModels || [],
          eventSettings: gameData.eventSettings || {},
          moodSettings: gameData.moodSettings || {},
          productSettings: gameData.productSettings || {},
          wishlistSettings: gameData.wishlistSettings || {},
          exportDate: new Date().toISOString(),
          version: "1.0"
        };
        
        // 将数据转换为JSON字符串
        const jsonString = JSON.stringify(exportData, null, 2);
        
        // 创建Blob对象
        const blob = new Blob([jsonString], { type: 'application/json' });
        
        // 创建下载链接
        const url = URL.createObjectURL(blob);
        
        // 创建临时下载链接并触发点击
        const downloadLink = document.createElement('a');
        downloadLink.href = url;
        downloadLink.download = `古代上位模拟器存档_${gameData.currentYear}年${gameData.currentMonth}月_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        
        // 释放URL对象
        URL.revokeObjectURL(url);
        
        // 显示成功提示
        showToast('游戏数据已成功导出！');
      } catch (error) {
        console.error('导出数据失败:', error);
        showToast('导出数据失败，请重试！', 'error');
      }
    }
    
    // 导入游戏数据
    function importGameData(event) {
      try {
        const file = event.target.files[0];
        if (!file) return;
        
        // 验证文件类型
        if (file.type !== 'application/json') {
          showToast('请选择JSON格式的存档文件！', 'error');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const importedData = JSON.parse(e.target.result);
            
            // 验证导入数据的结构
            if (!validateImportedData(importedData)) {
              showToast('存档文件格式不正确或已损坏！', 'error');
              return;
            }
            
            // 显示确认对话框
            showConfirmModal(
              '确定要导入此存档吗？当前的游戏进度将被覆盖！',
              () => {
                // 导入数据
                gameData.ladies = importedData.ladies || [];
                gameData.events = importedData.events || [];
                gameData.currentYear = importedData.currentYear || 1;
                gameData.currentMonth = importedData.currentMonth || 1;
                gameData.money = importedData.money || 100;
                gameData.displayYear = importedData.displayYear;
                gameData.displayMonth = importedData.displayMonth;
                gameData.bills = importedData.bills || [];
                gameData.apiSettings = importedData.apiSettings || {};
                gameData.apiModels = importedData.apiModels || [];
                gameData.eventSettings = importedData.eventSettings || {};
                gameData.moodSettings = importedData.moodSettings || {};
                gameData.productSettings = importedData.productSettings || {};
                gameData.wishlistSettings = importedData.wishlistSettings || {};
                
                // 导入商品数据
                if (importedData.productsData && Array.isArray(importedData.productsData)) {
                  productsData.length = 0; // 清空现有商品数据
                  productsData.push(...importedData.productsData);
                }
                
                // 保存数据到本地存储
                saveData();
                
                // 更新UI
                updateMonthDisplay();
                renderLadiesInPage();
                renderEvents();
                renderBills();
                initProducts();
                
                // 更新API设置UI
                if (gameData.apiSettings) {
                  if (elements.apiBaseurl) {
                    elements.apiBaseurl.value = gameData.apiSettings.baseUrl || '';
                  }
                  if (elements.apiKey) {
                    elements.apiKey.value = gameData.apiSettings.apiKey || '';
                  }
                  if (elements.apiModel) {
                    elements.apiModel.value = gameData.apiSettings.modelName || '';
                  }
                  
                  // 同时更新设置页面的输入框
                  if (elements.apiBaseurlPage) {
                    elements.apiBaseurlPage.value = gameData.apiSettings.baseUrl || '';
                  }
                  if (elements.apiKeyPage) {
                    elements.apiKeyPage.value = gameData.apiSettings.apiKey || '';
                  }
                  if (elements.apiModelPage) {
                    elements.apiModelPage.value = gameData.apiSettings.modelName || '';
                  }
                }
                
                // 更新事件设置UI
                if (gameData.eventSettings) {
                  if (elements.minEventsPerLady) {
                    elements.minEventsPerLady.value = gameData.eventSettings.minEventsPerLady || 1;
                  }
                  if (elements.minTotalEvents) {
                    elements.minTotalEvents.value = gameData.eventSettings.minTotalEvents || 1;
                  }
                  if (elements.maxTotalEvents) {
                    elements.maxTotalEvents.value = gameData.eventSettings.maxTotalEvents || 10;
                  }
                }
                
                // 显示成功提示
                showToast('游戏数据已成功导入！');
              },
              () => {
                // 用户取消导入
                showToast('已取消导入');
              }
            );
          } catch (error) {
            console.error('解析导入数据失败:', error);
            showToast('存档文件解析失败，请检查文件是否完整！', 'error');
          }
        };
        
        reader.readAsText(file);
      } catch (error) {
        console.error('导入数据失败:', error);
        showToast('导入数据失败，请重试！', 'error');
      } finally {
        // 清空文件输入，允许重复选择同一文件
        event.target.value = '';
      }
    }
    
    // 验证导入数据的结构
    function validateImportedData(data) {
      // 检查必要的字段是否存在
      if (!data || typeof data !== 'object') {
        return false;
      }
      
      // 检查版本号（如果有）
      if (data.version && typeof data.version !== 'string') {
        return false;
      }
      
      // 检查核心数据结构
      if (!Array.isArray(data.ladies)) {
        return false;
      }
      
      if (!Array.isArray(data.events)) {
        return false;
      }
      
      if (typeof data.currentYear !== 'number' || data.currentYear < 1) {
        return false;
      }
      
      if (typeof data.currentMonth !== 'number' || data.currentMonth < 1 || data.currentMonth > 12) {
        return false;
      }
      
      if (typeof data.money !== 'number' || data.money < 0) {
        return false;
      }
      
      return true;
    }
    
    // 购买商品功能
    // 商品数据
    const productsData = [
        {
            id: 1,
            name: "精致的胭脂水粉",
            description: "托关系从宫外捎来的时新款式，颜色细腻，香气淡雅，与宫内份例发的普通货色不同。",
            attribute: "容貌",
            attributeValue: 10,
            attributeColor: "pink",
            price: 30,
            svgSize: 48, // 第一个商品使用放大的SVG
            hasBorder: true // 第一个商品有边框
        },
        {
            id: 2,
            name: "《女诫》精注本",
            description: "不仅是一本道德规范，更有前辈人物在字里行间留下的处事心得和规矩注解，熟读可避免犯错。",
            attribute: "能力",
            attributeValue: 10,
            attributeColor: "green",
            price: 50,
            svgSize: 48, // 放大SVG图标
            hasBorder: true // 添加边框
        },
        {
            id: 3,
            name: "私传的绣花图样",
            description: "某位手艺精湛的老人物私藏的图样，学会后能让你的绣活脱颖而出，更易获得主子或掌事姑姑的青睐。",
            attribute: "能力",
            attributeValue: 10,
            attributeColor: "green",
            price: 25,
            svgSize: 48, // 放大SVG图标
            hasBorder: true // 添加边框
        },
        {
            id: 4,
            name: "残破的春宫图册",
            description: "在某个被遗弃的宫室角落偶然发现的残页，虽不完整，却也能窥见一二隐秘技巧。",
            attribute: "房中术",
            attributeValue: 10,
            attributeColor: "purple",
            price: 80,
            svgSize: 48, // 放大SVG图标
            hasBorder: true // 添加边框
        },
        {
            id: 5,
            name: "强身健体的小药丸",
            description: "太医院配制给低等宫人应急的补气丸，虽不名贵，但确能强健体魄，避免在繁重劳动中病倒。",
            attribute: "生命",
            attributeValue: 10,
            attributeColor: "red",
            price: 40,
            svgSize: 48, // 放大SVG图标
            hasBorder: true // 添加边框
        }
    ];

    // 创建商品卡片模板
    function createProductCard(product) {
        const borderClass = product.hasBorder ? "border-2 border-primary" : "";
        const svgIcon = `<svg version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="${product.svgSize}px" height="${product.svgSize}px" viewBox="-419.84 -419.84 1351.68 1351.68" xml:space="preserve" fill="#577f5b" stroke="#577f5b" stroke-width="0.00512"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <style type="text/css">  .st0{fill:#577f5b;}  </style> <g> <path class="st0" d="M476.235,174.734c2.203-8.547-2.953-17.266-11.516-19.484l-57.579-14.781l50.61-27.672 c7.75-4.234,10.594-13.969,6.359-21.719s-13.969-10.594-21.719-6.344l-64.063,35.047l39.219-95.25 c0.469-1.156,0.453-2.469-0.078-3.609c-0.516-1.141-1.5-2.016-2.688-2.422c0,0-31.688-16.438-49.594-16.438 c-37.063,0-73.047,19.422-105.828,19.422c-9.906,0-19.531-1.781-28.797-6.422C208.797,4.188,189.797,0,171.829,0 c-27.172,0-75.313,18.766-75.313,18.766c-1.266,0.313-2.344,1.172-2.938,2.359c-0.594,1.172-0.656,2.547-0.156,3.766L136.61,129.75 c-5.328,2.625-9.016,8.031-9.016,14.344c0,5.438,2.734,10.234,6.891,13.125c-21.109,25.156-73.156,92.547-92.75,167.031 C13.454,431.703,76.516,512,255.407,512c178.907,0,241.954-80.297,213.688-187.75c-17.297-65.688-59.829-125.875-84.11-156.438 l71.782,18.438C465.313,188.453,474.032,183.297,476.235,174.734z M171.829,40c13.078,0,26.047,3.453,40.844,10.844 c14.109,7.063,29.828,10.641,46.688,10.641c21.266,0,41.078-5.438,60.25-10.688c16.391-4.5,31.859-8.734,45.578-8.734l1.875,0.031 l-35.406,86H179.172L144.61,44.125C154.11,41.547,163.032,40,171.829,40z M419.813,421.094C394.5,453.922,336.125,472,255.407,472 C174.704,472,116.313,453.922,91,421.094c-16.516-21.438-20.078-50.594-10.594-86.656c21.906-83.25,91.859-159.766,92.531-160.5 l12.844-13.844h139.266l12.844,13.844c0.703,0.766,70.469,76.719,92.516,160.5C439.907,370.5,436.329,399.656,419.813,421.094z"></path> </g> </g></svg>`;
        
        // 判断是否显示属性值
        const showAttributeValue = ['容貌', '能力', '房中术', '生命'].includes(product.attribute);
        
        return `
            <div class="bg-white rounded-lg p-3 card-shadow ${borderClass}">
                <div class="flex items-start">
                    <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mr-3">
                        ${svgIcon}
                    </div>
                    <div class="flex-1">
                        <h3 class="font-medium text-primary mb-1 text-sm">${product.name}</h3>
                        <p class="text-xs text-gray-600 mb-2">${product.description}</p>
                        <div class="flex items-center">
                            ${showAttributeValue ? 
                                `<span class="text-xs bg-${product.attributeColor}-100 text-${product.attributeColor}-800 px-2 py-1 rounded-full mr-2">${product.attribute} +${product.attributeValue}</span>` : 
                                `<span class="text-xs bg-${product.attributeColor}-100 text-${product.attributeColor}-800 px-2 py-1 rounded-full mr-2">${product.attribute}</span>`
                            }
                            <span class="text-xs font-medium text-primary">${product.price} 银钱</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // 重置商品数据到初始状态
    function resetProductsToInitial() {
        // 清空商品数组
        productsData.length = 0;
        
        // 添加初始商品数据
        productsData.push(
            {
                id: 1,
                name: "精致的胭脂水粉",
                description: "托关系从宫外捎来的时新款式，颜色细腻，香气淡雅，与宫内份例发的普通货色不同。",
                attribute: "容貌",
                attributeValue: 10,
                attributeColor: "pink",
                price: 30,
                svgSize: 48, // 第一个商品使用放大的SVG
                hasBorder: true // 第一个商品有边框
            },
            {
                id: 2,
                name: "《女诫》精注本",
                description: "不仅是一本道德规范，更有前辈人物在字里行间留下的处事心得和规矩注解，熟读可避免犯错。",
                attribute: "能力",
                attributeValue: 10,
                attributeColor: "blue",
                price: 25,
                svgSize: 48,
                hasBorder: true
            },
            {
                id: 3,
                name: "养颜丸",
                description: "太医院秘制，有调养气血、润肤养颜之效，长期服用可使面色红润。",
                attribute: "容貌",
                attributeValue: 15,
                attributeColor: "pink",
                price: 50,
                svgSize: 48,
                hasBorder: true
            },
            {
                id: 4,
                name: "《春宫图》",
                description: "绘有男女交合之姿的图册，宫中禁物，私下流传，可增进房中技巧。",
                attribute: "房中术",
                attributeValue: 20,
                attributeColor: "purple",
                price: 80,
                svgSize: 48,
                hasBorder: true
            },
            {
                id: 5,
                name: "人参补药",
                description: "上等人参制成，有大补元气、强身健体之效，适合体弱者服用。",
                attribute: "生命",
                attributeValue: 15,
                attributeColor: "green",
                price: 45,
                svgSize: 48,
                hasBorder: true
            }
        );
    }

    // 初始化商品列表
    function initProducts() {
        const container = document.getElementById('products-container');
        if (!container) return;
        
        // 如果商品数组为空，重置为初始状态
        // 只有在没有从本地存储加载数据时才重置
        if (productsData.length === 0 && !localStorage.getItem('palaceProducts')) {
            resetProductsToInitial();
        }
        
        // 清空容器
        container.innerHTML = '';
        
        // 生成所有商品卡片
        productsData.forEach(product => {
            const productCard = createProductCard(product);
            container.innerHTML += productCard;
        });
        
        // 生成商品按钮事件已移至下拉菜单中
    }
    
    // 生成商品功能
    function generateProducts() {
        // 检查API设置（与记事生成功能保持一致的检查方式）
        if (!gameData.apiSettings.apiKey) {
            showToast('请先在设置中填写API Key', 'error');
            handleNavigation('settings');
            return;
        }
        
        // 显示加载中
        const generateDropdown = document.getElementById('generate-products-dropdown');
        const originalText = generateDropdown.innerHTML;
        generateDropdown.style.pointerEvents = 'none';
        generateDropdown.innerHTML = '<svg class="w-4 h-4 inline animate-spin mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg> 生成中...';
        
        // 调用AI生成商品
        requestAIProductGeneration()
            .then(products => {
                // 将生成的商品添加到商品列表
                products.forEach(product => {
                    // 转换AI生成的商品为商品模板格式
                    const newProduct = convertAIProductToTemplate(product);
                    productsData.push(newProduct);
                });
                
                // 重新渲染商品列表
                initProducts();
                
                // 保存数据
                saveData();
                
                // 显示成功提示
                showToast(`成功生成${products.length}个新商品！`);
            })
            .catch(error => {
                console.error('生成商品失败:', error);
                // 显示错误详情
                showErrorDetails(error, '生成商品');
            })
            .finally(() => {
                // 恢复按钮状态
                generateDropdown.style.pointerEvents = 'auto';
                generateDropdown.innerHTML = originalText;
            });
    }
    
    // 请求AI生成商品
    function requestAIProductGeneration() {
        return new Promise(async (resolve, reject) => {
            try {
                // 获取近10条记事
                const recentEvents = gameData.events.slice(0, 10).map(event => ({
                    date: event.date,
                    content: event.content
                }));
                
                // 获取现有商品
                const existingProducts = productsData.map(product => ({
                    name: product.name,
                    description: product.description,
                    price: product.price,
                    type: product.type || '属性'
                }));
                
                // 准备系统提示
                let systemPrompt;
                
                // 如果有自定义的商品生成提示词，使用自定义提示词
                if (gameData.productSettings && gameData.productSettings.customPrompt) {
                    // 使用模板字符串处理自定义提示词中的变量
                    systemPrompt = gameData.productSettings.customPrompt
                        .replace(/\${gameData\.currentYear}/g, gameData.currentYear)
                        .replace(/\${gameData\.currentMonth}/g, gameData.currentMonth)
                        .replace(/\${recentEvents\.map\(event => `\$\{event\.date\}: \$\{event\.content\}`\)\.join\('\\n'\)}/g, 
                            recentEvents.map(event => `${event.date}: ${event.content}`).join('\n'))
                        .replace(/\${existingProducts\.map\(product => `\$\{product\.name\} - \$\{product\.description\} \(\$\{product\.price\}银钱, \$\{product\.type\}`\)\.join\('\\n'\)}/g,
                            existingProducts.map(product => `${product.name} - ${product.description} (${product.price}银钱, ${product.type})`).join('\n'));
                } else {
                    // 使用默认的系统提示
                    systemPrompt = `角色： 你是一名为《古代上位模拟器》生成商城商品的AI。商品必须符合古代 人物 的身份和购买力。

核心原则：

身份相符： 商品必须是人物能私下获得、制作或购买的日常、隐蔽物品。禁止出现妃子级奢侈品。

价格合理： 货币单位为"银钱"。普通物品20-80银钱，稀有或强效物品80-200银钱。

效果明确： 直接说明对"容貌、能力、房中术、生命"四项属性的影响，或是产生某种具体的"陷害/情报/机会"效果。

生成方向（任选其一随机生成即可）：

属性类： 能提升人物自身属性的物品（如胭脂、药丸、书册）。

手段类： 用于算计他人或保护自己的消耗品。

特殊类： 能提供特殊机会或影响人际关系的物品。

输出格式：

请严格使用以下JSON格式生成5件商品，返回完整的JSON数组：

[
  {
    "name": "商品名称",
    "description": "简短描述，说明这是什么、怎么来的。",
    "effect": "具体效果，例如：容貌+10 / 让目标生病1天 / 获取一次某太监的把柄。",
    "price": 价格数字,
    "type": "属性/手段/特殊"
  }
]

当前时间：${gameData.currentYear}年${gameData.currentMonth}月

近10条记事：
${recentEvents.map(event => `${event.date}: ${event.content}`).join('\n')}

现有商品：
${existingProducts.map(product => `${product.name} - ${product.description} (${product.price}银钱, ${product.type})`).join('\n')}

请生成5个新的、不与现有商品重复的商品。`;
                }
                
                // 准备请求数据
                const requestData = {
                    model: gameData.apiSettings.modelName,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: '请生成5个新的人物商品' }
                    ],
                    temperature: 0.8
                };
                
                // 发送请求
                const response = await fetch(`${gameData.apiSettings.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${gameData.apiSettings.apiKey}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.choices[0].message.content;
                
                // 解析AI响应
                const products = safelyParseProductResponse(aiResponse);
                if (products && products.length > 0) {
                    resolve(products);
                } else {
                    reject(new Error('AI返回的商品格式不正确'));
                }
            } catch (error) {
                console.error('请求AI生成商品失败:', error);
                reject(error);
            }
        });
    }
    
    // 安全解析AI返回的商品JSON
    function safelyParseProductResponse(response) {
        try {
            // 尝试直接解析JSON
            const parsed = JSON.parse(response);
            return Array.isArray(parsed) ? parsed : [parsed];
        } catch (e) {
            try {
                // 尝试提取JSON部分
                const jsonMatch = response.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    const parsed = JSON.parse(jsonMatch[0]);
                    return Array.isArray(parsed) ? parsed : [parsed];
                }
                
                // 尝试提取单个JSON对象
                const objectMatches = response.match(/\{[\s\S]*?\}/g);
                if (objectMatches && objectMatches.length > 0) {
                    return objectMatches.map(match => JSON.parse(match));
                }
                
                console.error('无法从AI响应中提取有效的JSON:', response);
                return null;
            } catch (e) {
                console.error('解析AI响应失败:', e);
                return null;
            }
        }
    }
    
    // 将AI生成的商品转换为商品模板格式
    function convertAIProductToTemplate(aiProduct) {
        // 根据效果确定属性类型和颜色
        let attribute = '能力';
        let attributeValue = 10;
        let attributeColor = 'green';
        
        if (aiProduct.effect.includes('容貌')) {
            attribute = '容貌';
            attributeColor = 'pink';
        } else if (aiProduct.effect.includes('房中术')) {
            attribute = '房中术';
            attributeColor = 'purple';
        } else if (aiProduct.effect.includes('生命')) {
            attribute = '生命';
            attributeColor = 'red';
        } else if (aiProduct.type === '手段') {
            attribute = '手段';
            attributeColor = 'yellow';
        } else if (aiProduct.type === '特殊') {
            attribute = '特殊';
            attributeColor = 'indigo';
        }
        
        // 生成唯一ID
        const id = productsData.length > 0 ? Math.max(...productsData.map(p => p.id)) + 1 : 1;
        
        return {
            id: id,
            name: aiProduct.name,
            description: aiProduct.description,
            attribute: attribute,
            attributeValue: attributeValue,
            attributeColor: attributeColor,
            price: aiProduct.price,
            type: aiProduct.type,
            effect: aiProduct.effect,
            svgSize: 48,
            hasBorder: true
        };
    }

    function buyProduct(productId) {
      // 商品数据
      const products = {};
      
      // 从productsData中获取商品信息
      const productData = productsData.find(p => p.id === productId);
      if (!productData) {
        showToast('商品不存在！', 'error');
        return;
      }
      
      // 构建商品对象
      products[productId] = {
        name: productData.name,
        price: productData.price,
        effect: {},
        description: `${productData.attribute} +${productData.attributeValue}`
      };
      
      // 根据属性类型设置效果
      if (productData.attribute === '容貌') {
        products[productId].effect.appearance = productData.attributeValue;
      } else if (productData.attribute === '能力') {
        products[productId].effect.ability = productData.attributeValue;
      } else if (productData.attribute === '房中术') {
        products[productId].effect.bedroomSkill = productData.attributeValue;
      } else if (productData.attribute === '生命') {
        products[productId].effect.health = productData.attributeValue;
      }
      
      // 如果是手段或特殊类型，使用自定义效果
      if (productData.type === '手段' || productData.type === '特殊') {
        products[productId].description = productData.effect;
        // 这里可以根据需要添加特殊效果的处理逻辑
      }
      
      const product = products[productId];
      if (!product) {
        showToast('商品不存在！', 'error');
        return;
      }
      
      // 检查是否有足够的银钱
      if (gameData.money < product.price) {
        showToast('银钱不足，无法购买此商品！', 'error');
        return;
      }
      
      // 检查是否有人物
      if (gameData.ladies.length === 0) {
        showToast('请先添加人物！', 'error');
        return;
      }
      
      // 创建选择人物的模态框
      const modal = document.createElement('div');
      modal.className = 'modal active';
      
      // 生成人物选择列表
      let ladiesList = '';
      gameData.ladies.forEach(lady => {
        ladiesList += `
          <div class="lady-selection-item p-3 border rounded-lg mb-2 cursor-pointer hover:bg-gray-50" data-lady-id="${lady.id}">
            <div class="flex items-center">
              <img src="${lady.avatar}" alt="${lady.name}" class="w-12 h-12 rounded-full mr-3">
              <div>
                <div class="font-medium">${lady.name}</div>
                <div class="text-sm text-gray-500">${lady.title || '人物'} | 容貌: ${lady.looks} | 能力: ${lady.ability} | 房中术: ${lady.skills} | 生命: ${lady.life}</div>
              </div>
            </div>
          </div>
        `;
      });
      
      modal.innerHTML = `
        <div class="modal-content p-5">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-primary">选择人物</h3>
            <button class="close-modal text-gray-400">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
          
          <div class="mb-4">
            <div class="bg-blue-50 p-3 rounded-lg mb-4">
              <div class="font-medium">${product.name}</div>
              <div class="text-sm text-gray-600">${productData.description}</div>
              <div class="text-sm font-medium text-primary mt-1">价格: ${product.price} 银钱</div>
              <div class="text-sm text-gray-600 mt-1">效果: ${product.description}</div>
            </div>
            
            <p class="text-sm text-gray-600 mb-3">请选择要使用此商品的人物：</p>
            <div class="max-h-60 overflow-y-auto">
              ${ladiesList}
            </div>
          </div>
          
          <div class="mt-4 flex justify-end">
            <button id="cancel-buy" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg mr-2">
              取消
            </button>
            <button id="confirm-buy" class="px-4 py-2 bg-primary text-white rounded-lg" disabled>
              购买
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      let selectedLadyId = null;
      
      // 人物选择事件
      const ladyItems = modal.querySelectorAll('.lady-selection-item');
      ladyItems.forEach(item => {
        item.addEventListener('click', () => {
          // 移除所有选中状态
          ladyItems.forEach(i => i.classList.remove('bg-blue-50', 'border-primary'));
          
          // 添加选中状态
          item.classList.add('bg-blue-50', 'border-primary');
          selectedLadyId = item.dataset.ladyId;
          
          // 启用购买按钮
          document.getElementById('confirm-buy').disabled = false;
        });
      });
      
      // 关闭按钮
      modal.querySelector('.close-modal').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // 取消按钮
      document.getElementById('cancel-buy').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // 购买按钮
      document.getElementById('confirm-buy').addEventListener('click', () => {
        if (!selectedLadyId) {
          showToast('请选择一个人物！', 'error');
          return;
        }
        
        // 找到选中的人物
        const lady = gameData.ladies.find(l => l.id === selectedLadyId);
        if (!lady) {
          showToast('人物不存在！', 'error');
          return;
        }
        
        // 扣除银钱
        gameData.money -= product.price;
        
        // 应用效果
        if (product.effect.appearance) {
          lady.looks = Math.min(100, lady.looks + product.effect.appearance);
        }
        if (product.effect.ability) {
          lady.ability = Math.min(100, lady.ability + product.effect.ability);
        }
        if (product.effect.bedroomSkill) {
          lady.skills = Math.min(100, lady.skills + product.effect.bedroomSkill);
        }
        if (product.effect.health) {
          lady.life = Math.min(100, lady.life + product.effect.health);
        }
        
        // 添加购买事件
        const purchaseEvent = {
          id: generateId(),
          date: `${gameData.currentYear}年${gameData.currentMonth}月`,
          lady: lady.name,
          content: `${lady.name}购买了${product.name}，${product.description}`,
          effects: product.effect,
          relatedLadies: [lady.id]
        };
        
        gameData.events.push(purchaseEvent);
        
        // 保存数据
        saveData();
        
        // 更新UI
        renderLadiesInPage();
        renderEvents();
        
        // 关闭模态框
        document.body.removeChild(modal);
        
        // 显示成功提示
        showToast(`${lady.name}成功购买了${product.name}！`);
      });
    }
    
    // 显示编辑商品模态框
    function showEditProductsModal() {
      const modal = document.getElementById('edit-products-modal');
      if (!modal) return;
      
      // 显示模态框
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      // 渲染商品列表
      renderEditProductsList();
    }
    
    // 隐藏编辑商品模态框
    function hideEditProductsModal() {
      const modal = document.getElementById('edit-products-modal');
      if (!modal) return;
      
      // 隐藏模态框
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
    
    // 渲染编辑商品列表
    function renderEditProductsList() {
      const container = document.getElementById('edit-products-list');
      if (!container) return;
      
      // 清空容器
      container.innerHTML = '';
      
      // 如果没有商品，显示提示
      if (productsData.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">暂无商品，请点击"添加新商品"按钮添加</p>';
        return;
      }
      
      // 生成每个商品的编辑表单
      productsData.forEach(product => {
        const productEditItem = document.createElement('div');
        productEditItem.className = 'border rounded-lg p-4 space-y-3';
        productEditItem.dataset.productId = product.id;
        
        // 始终显示属性值输入框
        const showAttributeValueInput = true;
        
        productEditItem.innerHTML = `
          <div class="flex justify-between items-center">
            <h4 class="font-medium text-gray-800">商品 #${product.id}</h4>
            <button class="delete-product-btn text-red-500 hover:text-red-700" data-product-id="${product.id}">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">商品名称</label>
              <input type="text" class="product-name w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="${product.name}" data-product-id="${product.id}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">价格</label>
              <input type="number" class="product-price w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="${product.price}" data-product-id="${product.id}" min="1">
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">商品描述</label>
            <textarea class="product-description w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="2" data-product-id="${product.id}">${product.description}</textarea>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">属性类型</label>
              <input type="text" class="product-attribute w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="${product.attribute}" data-product-id="${product.id}" placeholder="请输入属性类型">
            </div>
            ${showAttributeValueInput ? `
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">属性值</label>
              <input type="number" class="product-attribute-value w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="${product.attributeValue || 0}" data-product-id="${product.id}" min="0">
            </div>
            ` : ''}
          </div>
          
          ${product.type === '手段' || product.type === '特殊' ? `
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">特殊效果</label>
            <textarea class="product-effect w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="2" data-product-id="${product.id}">${product.effect || ''}</textarea>
          </div>
          ` : ''}
        `;
        
        container.appendChild(productEditItem);
        
        // 为每个删除按钮添加事件监听器
        const deleteButton = productEditItem.querySelector('.delete-product-btn');
        deleteButton.addEventListener('click', (e) => {
          const productId = parseInt(e.currentTarget.dataset.productId);
          deleteProduct(productId);
        });
      });
    }
    
    // 添加新商品
    function addNewProduct() {
      // 生成新商品ID
      const newId = productsData.length > 0 ? Math.max(...productsData.map(p => p.id)) + 1 : 1;
      
      // 创建新商品
      const newProduct = {
        id: newId,
        name: "新商品",
        description: "这是一个新商品的描述",
        attribute: "容貌",
        attributeValue: 5,
        attributeColor: "pink",
        price: 20,
        type: "属性",
        effect: "",
        svgSize: 48,
        hasBorder: true
      };
      
      // 添加到商品列表
      productsData.push(newProduct);
      
      // 重新渲染商品列表
      renderEditProductsList();
    }
    
    // 显示确认弹框
    function showConfirmModal(message, onConfirm, onCancel) {
      // 创建新的确认弹窗，避免复用现有元素
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.id = 'confirm-modal';
      modal.style.zIndex = '9999'; // 确保在最上层
      
      const modalContent = document.createElement('div');
      modalContent.className = 'bg-white rounded-lg p-6 max-w-sm mx-4';
      
      const messageEl = document.createElement('p');
      messageEl.className = 'text-gray-800 mb-4';
      messageEl.innerHTML = message;
      
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'flex justify-end space-x-2';
      
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300';
      cancelBtn.textContent = '取消';
      
      const confirmBtn = document.createElement('button');
      confirmBtn.className = 'px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600';
      confirmBtn.textContent = '确认';
      
      buttonContainer.appendChild(cancelBtn);
      buttonContainer.appendChild(confirmBtn);
      
      modalContent.appendChild(messageEl);
      modalContent.appendChild(buttonContainer);
      modal.appendChild(modalContent);
      
      document.body.appendChild(modal);
      
      // 添加事件监听器
      cancelBtn.addEventListener('click', () => {
        if (onCancel) onCancel();
        document.body.removeChild(modal);
      });
      
      confirmBtn.addEventListener('click', () => {
        onConfirm();
        // 使用setTimeout确保onConfirm中的操作完成后再关闭模态框
        setTimeout(() => {
          if (document.body.contains(modal)) {
            document.body.removeChild(modal);
          }
        }, 100);
      });
      
      return confirmBtn;
    }
    
    // 隐藏确认弹框
    function hideConfirmModal() {
      elements.confirmModal.classList.add('hidden');
      elements.confirmModal.classList.remove('flex');
    }
    
    // 删除商品
    function deleteProduct(productId) {
      const product = productsData.find(p => p.id === productId);
      const productName = product ? product.name : '这个商品';
      
      // 显示确认弹框
      showConfirmModal(`确定要删除商品"${productName}"吗？`, () => {
        // 从商品列表中移除
        const index = productsData.findIndex(p => p.id === productId);
        if (index !== -1) {
          productsData.splice(index, 1);
          
          // 保存数据到本地存储
          saveData();
        }
        
        // 重新渲染商品列表
        renderEditProductsList();
      });
    }
    
    // 保存商品更改
    function saveProductChanges() {
      // 获取所有商品编辑表单
      const productItems = document.querySelectorAll('#edit-products-list > div');
      
      // 更新每个商品的数据
      productItems.forEach(item => {
        const productId = parseInt(item.dataset.productId);
        const product = productsData.find(p => p.id === productId);
        
        if (product) {
          // 获取表单值
          const name = item.querySelector('.product-name').value;
          const price = parseInt(item.querySelector('.product-price').value);
          const description = item.querySelector('.product-description').value;
          const attribute = item.querySelector('.product-attribute').value;
          
          // 始终处理属性值
          const attributeValue = parseInt(item.querySelector('.product-attribute-value').value) || 0;
          
          // 更新商品数据
          product.name = name;
          product.price = price;
          product.description = description;
          product.attribute = attribute;
          product.attributeValue = attributeValue;
          
          // 根据属性类型更新颜色和类型
          if (attribute === '容貌') {
            product.attributeColor = 'pink';
            product.type = '属性';
          } else if (attribute === '能力') {
            product.attributeColor = 'blue';
            product.type = '属性';
          } else if (attribute === '房中术') {
            product.attributeColor = 'purple';
            product.type = '属性';
          } else if (attribute === '生命') {
            product.attributeColor = 'red';
            product.type = '属性';
          } else if (attribute === '手段') {
            product.attributeColor = 'yellow';
            product.type = '手段';
          } else if (attribute === '特殊') {
            product.attributeColor = 'indigo';
            product.type = '特殊';
          } else {
            // 对于自定义属性类型，使用默认颜色和类型
            product.attributeColor = 'gray';
            product.type = '属性';
          }
          
          // 如果是手段或特殊类型，更新效果
          if (product.type === '手段' || product.type === '特殊') {
            const effectElement = item.querySelector('.product-effect');
            if (effectElement) {
              product.effect = effectElement.value;
            }
          }
        }
      });
      
      // 保存数据
      saveData();
      
      // 重新渲染商品列表
      initProducts();
      
      // 关闭编辑模态框
      hideEditProductsModal();
      
      // 显示成功提示
      showToast('商品更改已保存！');
    }
    
    // 显示心愿单选择界面
    function showWishlistSelection() {
      // 检查是否有人物
      if (gameData.ladies.length === 0) {
        alert('请先添加人物');
        return;
      }
      
      // 创建模态框
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.id = 'wishlist-selection-modal';
      
      // 获取头像URL的函数
      const getAvatarUrl = (lady) => {
        if (lady.customAvatar) {
          return lady.customAvatar;
        } else {
          return gameData.avatarOptions.find(avatar => avatar.id === lady.avatarId)?.url || gameData.avatarOptions[0].url;
        }
      };
      
      modal.innerHTML = `
        <div class="modal-content p-5 border-2 border-primary max-w-2xl max-h-80 overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-primary">选择要生成心愿单的人物</h3>
            <button class="close-modal text-gray-400">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
          
          <div class="mb-4">
            <div class="flex items-center mb-3">
              <input type="checkbox" id="select-all-ladies-wishlist" class="mr-2">
              <label for="select-all-ladies-wishlist" class="text-sm font-medium">全选</label>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              ${gameData.ladies.map(lady => `
                <div class="flex items-center p-2 border rounded-lg hover:bg-gray-50">
                  <input type="checkbox" id="lady-wishlist-${lady.id}" name="selected-ladies-wishlist" value="${lady.id}" class="mr-3">
                  <label for="lady-wishlist-${lady.id}" class="flex items-center cursor-pointer flex-1">
                    <img src="${getAvatarUrl(lady)}" alt="${lady.name}" class="w-10 h-10 rounded-full object-cover mr-2">
                    <div>
                      <div class="font-medium">${lady.name}</div>
                      <div class="text-xs text-gray-500">${lady.title || '人物'}</div>
                    </div>
                  </label>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div class="flex justify-end space-x-3">
            <button id="cancel-wishlist-selection" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg">
              取消
            </button>
            <button id="confirm-wishlist-selection" class="px-4 py-2 bg-primary text-white rounded-lg">
              生成心愿单
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // 添加全选功能
      const selectAllCheckbox = document.getElementById('select-all-ladies-wishlist');
      const ladyCheckboxes = document.querySelectorAll('input[name="selected-ladies-wishlist"]');
      
      selectAllCheckbox.addEventListener('change', () => {
        ladyCheckboxes.forEach(checkbox => {
          checkbox.checked = selectAllCheckbox.checked;
        });
      });
      
      // 监听单个复选框变化，更新全选状态
      ladyCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const allChecked = Array.from(ladyCheckboxes).every(cb => cb.checked);
          const someChecked = Array.from(ladyCheckboxes).some(cb => cb.checked);
          selectAllCheckbox.checked = allChecked;
          selectAllCheckbox.indeterminate = someChecked && !allChecked;
        });
      });
      
      // 添加取消按钮事件
      document.getElementById('cancel-wishlist-selection').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // 添加关闭按钮事件
      modal.querySelector('.close-modal').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // 添加确认选择按钮事件
      document.getElementById('confirm-wishlist-selection').addEventListener('click', () => {
        const selectedLadyIds = Array.from(ladyCheckboxes)
          .filter(checkbox => checkbox.checked)
          .map(checkbox => checkbox.value);
        
        if (selectedLadyIds.length === 0) {
          alert('请至少选择一位人物');
          return;
        }
        
        // 移除选择界面
        document.body.removeChild(modal);
        
        // 为选中的人物生成心愿单
        generateWishlistsForSelectedLadies(selectedLadyIds);
      });
    }

    // 为选中的人物生成心愿单
    function generateWishlistsForSelectedLadies(selectedLadyIds) {
      // 检查API设置
      if (!gameData.apiSettings.apiKey) {
        alert('请先在设置中填写API Key');
        handleNavigation('settings');
        return;
      }
      
      // 获取选中的人物
      const selectedLadies = gameData.ladies.filter(lady => selectedLadyIds.includes(lady.id));
      
      // 创建持续显示的加载提示（使用与showToast相同的样式）
      const loadingNotification = document.createElement('div');
      loadingNotification.id = 'wishlist-generation-loading';
      loadingNotification.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-blue-500 text-white px-4 py-2 rounded-lg text-sm z-50 animate-fadeInUp';
      loadingNotification.innerHTML = '<svg class="w-4 h-4 inline animate-spin mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>正在生成心愿单...';
      document.body.appendChild(loadingNotification);
      
      // 准备AI请求
      requestAIWishlistResponseForSelectedLadies(selectedLadies)
        .then(wishlists => {
          // 更新每个人物的心愿单
          wishlists.forEach(wishlistData => {
            const lady = gameData.ladies.find(l => l.name === wishlistData.character);
            if (lady) {
              // 初始化心愿单数组（如果不存在）
              if (!lady.wishlist) {
                lady.wishlist = [];
              }
              
              // 添加新生成的心愿单项
              if (wishlistData.wishlistItems && wishlistData.wishlistItems.length > 0) {
                lady.wishlist = wishlistData.wishlistItems.map(item => ({
                  name: item.name,
                  description: item.description,
                  thought: item.thought,
                  createdAt: new Date().toISOString()
                }));
              }
            }
          });
          
          // 保存数据
          saveData();
          
          // 显示成功提示
          showToast(`已为${wishlists.length}位人物生成心愿单！`);
        })
        .catch(error => {
          console.error('生成心愿单失败:', error);
          // 显示错误详情
          showErrorDetails(error, '生成心愿单');
        })
        .finally(() => {
          // 移除加载提示
          const loadingNotification = document.getElementById('wishlist-generation-loading');
          if (loadingNotification) {
            document.body.removeChild(loadingNotification);
          }
        });
    }

    // 请求AI为选中人物生成心愿单响应
    function requestAIWishlistResponseForSelectedLadies(selectedLadies) {
      return new Promise(async (resolve, reject) => {
        try {
          // 获取近10条事件
          const recentEvents = gameData.events.slice(0, 10).map(event => ({
            date: event.date,
            content: event.content
          }));
          
          // 准备系统提示
          let systemPrompt;
          
          // 如果有自定义的心愿单生成提示词，使用自定义提示词
          if (gameData.wishlistSettings && gameData.wishlistSettings.customPrompt) {
            // 使用模板字符串处理自定义提示词中的变量
            systemPrompt = gameData.wishlistSettings.customPrompt
              .replace(/\${gameData\.currentYear}/g, gameData.currentYear)
              .replace(/\${gameData\.currentMonth}/g, gameData.currentMonth)
              .replace(/\${recentEvents\.map\(event => `\$\{event\.date\}: \$\{event\.content\}`\)\.join\('\\n'\)}/g, 
                recentEvents.map(event => `${event.date}: ${event.content}`).join('\n'))
              .replace(/\${gameData\.ladies\.map\(lady => `\$\{lady\.name\} - 容貌:\$\{lady\.looks\}, 能力:\$\{lady\.ability\}, 房中术:\$\{lady\.skills\}, 身份:\$\{lady\.title \|\| '人物'\}, 状态:\$\{lady\.status \|\| '健康'\}, 心境:\$\{lady\.mindset \|\| '平静'\}, 心情:\$\{lady\.mood \|\| '平静'\}`\)\.join\('\\n'\)}/g,
                gameData.ladies.map(lady => `${lady.name} - 容貌:${lady.looks}, 能力:${lady.ability}, 房中术:${lady.skills}, 身份:${lady.title || '人物'}, 状态:${lady.status || '健康'}, 心境:${lady.mindset || '平静'}, 心情:${lady.mood || '平静'}`).join('\n'))
              .replace(/\${gameData\.events\.map\(event => `\$\{event\.date\}: \$\{event\.content\}`\)\.join\('\\n'\)}/g,
                gameData.events.map(event => `${event.date}: ${event.content}`).join('\n'));
          } else {
            // 使用默认的系统提示
            systemPrompt = `你是"古代上位模拟器"的游戏核心系统，专门负责根据角色的当前状态，生成符合其性格、处境和需求的心愿单。

核心任务：分析给定的【角色属性】、【当前心境】和【近期事件】，推断出该角色在当下最可能渴望获得哪些物品。生成的心愿单需要真实、细腻，能反映角色的内心世界和成长轨迹。

生成规则与要求：

分析信息来源：你必须综合所有信息进行深度推理：
属性：决定心愿的基调
当前心境：决定心愿的情感导向
近10条事件：这是最重要的依据，心愿必须与最近的经历强相关（例如，刚被主子夸奖，可能想要新胭脂锦上添花；刚被大人物欺负，可能想要暗算别人的东西或寻求庇护）。

心愿单内容格式：每个心愿必须包含以下三个部分，缺一不可：
物品名称：符合游戏古代背景的具体物品
物品介绍：简要说明此物品的用途或象征意义（1句话即可）。
心理想法（第一人称，10-30字）：核心！用角色的口吻，结合上述分析，写出她"为什么想要"这个东西。要口语化，有情绪。

生成数量与质量：每次生成1-3个心愿项。宁可精准也不要堆砌。心愿要有差异性，可以涵盖不同方面（如：提升自我的、情感慰藉的、争宠实用的）。

当前时间：${gameData.currentYear}年 ${gameData.currentMonth}月

当前人物列表：
${gameData.ladies.map(lady => `${lady.name} - 容貌:${lady.looks}, 能力:${lady.ability}, 房中术:${lady.skills}, 身份:${lady.title || '人物'}, 状态:${lady.status || '健康'}, 心境:${lady.mindset || '平静'}, 心情:${lady.mood || '平静'}`).join('\n')}

近期事件：
${recentEvents.map(event => `${event.date}: ${event.content}`).join('\n')}

请以JSON格式返回心愿单：
{
  "wishlistAnalysis": [
    {
      "character": "王氏",
      "wishlistItems": [
        {
          "name": "鎏金百花香囊",
          "description": "内填名贵香料，行走时步步生香，是宫中妃嫔喜爱的饰物。",
          "thought": "上次李选侍就是凭一身异香得了陛下青睐，我也要备着，万一哪天偶遇圣驾呢……"
        },
        {
          "name": "苏绣手帕",
          "description": "江南进贡的上等丝帕，绣工精细，触感柔滑。",
          "thought": "皇后娘娘赏赐的手帕丢了，若能寻得相似的，或许能讨她欢心。"
        }
      ]
    }
  ]
}

要求：每个心愿都要体现角色的内心需求和当前处境，要有情感共鸣。`;
          }

          // 准备请求数据
          const requestData = {
            model: gameData.apiSettings.modelName,
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: `请为以下选中的人物生成符合其当前状态的心愿单：${selectedLadies.map(lady => lady.name).join('、')}` }
            ],
            temperature: 0.7
          };
          
          // 发送请求
          const response = await fetch(`${gameData.apiSettings.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${gameData.apiSettings.apiKey}`
            },
            body: JSON.stringify(requestData)
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `API请求失败: ${response.status}`);
          }
          
          const data = await response.json();
          
          // 解析响应
          const aiResponse = data.choices[0].message.content;
          const parsedResponse = safelyParseAiResponse(aiResponse);
          
          if (!parsedResponse || !parsedResponse.wishlistAnalysis || !parsedResponse.wishlistAnalysis.length) {
            throw new Error('AI返回格式不正确');
          }
          
          resolve(parsedResponse.wishlistAnalysis);
        } catch (error) {
          reject(error);
        }
      });
    }

    // 显示查看心愿单模态框
    function showViewWishlistModal() {
      // 检查是否有人物
      if (gameData.ladies.length === 0) {
        alert('请先添加人物');
        return;
      }
      
      // 获取头像URL的函数
      const getAvatarUrl = (lady) => {
        if (lady.customAvatar) {
          return lady.customAvatar;
        } else {
          return gameData.avatarOptions.find(avatar => avatar.id === lady.avatarId)?.url || gameData.avatarOptions[0].url;
        }
      };
      
      // 创建模态框
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.id = 'view-wishlist-modal';
      
      // 生成人物心愿单内容
      let wishlistContent = '';
      let hasWishlist = false;
      
      gameData.ladies.forEach(lady => {
        const avatarUrl = getAvatarUrl(lady);
        wishlistContent += `
          <div class="mb-6 pb-6 border-b border-gray-200 last:border-b-0">
            <div class="flex items-center mb-3">
              <img src="${avatarUrl}" alt="${lady.name}" class="w-12 h-12 rounded-full object-cover mr-3">
              <div>
                <h4 class="font-medium text-lg">${lady.name}</h4>
                <p class="text-sm text-gray-500">${lady.title || '人物'}</p>
              </div>
            </div>
        `;
        
        if (lady.wishlist && lady.wishlist.length > 0) {
          hasWishlist = true;
          wishlistContent += `
            <div class="ml-15 space-y-3">
          `;
          
          lady.wishlist.forEach((item, index) => {
            wishlistContent += `
              <div class="bg-gray-50 p-3 rounded-lg">
                <div class="flex items-start">
                  <span class="inline-block bg-primary text-white text-xs rounded-full px-2 py-1 mr-2">${index + 1}</span>
                  <div class="flex-1">
                    <div class="flex items-center justify-between">
                      <h5 class="font-medium">${item.name}</h5>
                      <button class="get-item-btn bg-secondary text-white text-xs px-3 py-1 rounded-full hover:bg-opacity-90 transition-all" data-lady="${lady.name}" data-item="${item.name}" data-effect="${item.description}" data-thought="${item.thought}">
                        获取
                      </button>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">${item.description}</p>
                    <div class="mt-2 p-2 bg-yellow-50 border border-primary rounded-lg">
                      <p class="text-sm italic text-gray-700">"${item.thought}"</p>
                    </div>
                  </div>
                </div>
              </div>
            `;
          });
          
          wishlistContent += `
            </div>
          `;
        } else {
          wishlistContent += `
            <div class="ml-15 text-gray-500 italic">暂无心愿单</div>
          `;
        }
        
        wishlistContent += `
          </div>
        `;
      });
      
      // 如果没有任何心愿单，显示提示
      if (!hasWishlist) {
        wishlistContent = `
          <div class="text-center py-8">
            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path>
            </svg>
            <p class="text-gray-500">暂无心愿单</p>
            <p class="text-sm text-gray-400 mt-2">请先为人物生成心愿单</p>
          </div>
        `;
      }
      
      modal.innerHTML = `
        <div class="modal-content p-5 max-w-3xl max-h-96 overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-primary">人物心愿单</h3>
            <button class="close-modal text-gray-400">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
          
          <div class="wishlist-content">
            ${wishlistContent}
          </div>
          
          <div class="flex justify-end mt-4">
            <button id="close-view-wishlist" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg">
              关闭
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // 添加关闭按钮事件
      document.getElementById('close-view-wishlist').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      modal.querySelector('.close-modal').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // 添加获取按钮事件
      const getItemButtons = modal.querySelectorAll('.get-item-btn');
      getItemButtons.forEach(button => {
        button.addEventListener('click', () => {
          const ladyName = button.getAttribute('data-lady');
          const itemName = button.getAttribute('data-item');
          const itemEffect = button.getAttribute('data-effect');
          const itemThought = button.getAttribute('data-thought');
          
          // 添加获取物品的记事
          addGetItemEvent(ladyName, itemName, itemEffect, itemThought);
          
          // 显示成功消息
          showSuccessMessage(`已为${ladyName}获取${itemName}`);
        });
      });
    }

    // 显示增加记事模态框
    function showAddEventModal() {
      // 创建模态框
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.id = 'add-event-modal';
      
      // 获取当前游戏内时间
      const currentYear = gameData.currentYear;
      const currentMonth = gameData.currentMonth;
      const formattedDate = `${currentYear}年${currentMonth}月`;
      
      modal.innerHTML = `
        <div class="modal-content p-5 max-w-2xl">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-primary">增加记事</h3>
            <button class="close-modal text-gray-400">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
          
          <form id="add-event-form">
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2">日期</label>
              <input type="text" id="event-date" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" value="${formattedDate}" required>
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2">相关人物（用顿号隔开）</label>
              <input type="text" id="event-ladies" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="例如：潇潇、婉儿、小翠">
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2">事件内容</label>
              <textarea id="event-content" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" rows="4" required></textarea>
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2">效果</label>
              <textarea id="event-effect" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" rows="3" placeholder='例如：{"target":"潇潇","mood":"紧张"}'></textarea>
              <p class="text-xs text-gray-500 mt-1">请使用JSON格式，例如：{"target":"潇潇","mood":"紧张"}</p>
            </div>
            
            <div class="flex justify-end">
              <button type="button" id="cancel-add-event" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg mr-2">
                取消
              </button>
              <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg">
                添加
              </button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // 添加关闭按钮事件
      document.getElementById('cancel-add-event').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      modal.querySelector('.close-modal').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // 添加表单提交事件
      document.getElementById('add-event-form').addEventListener('submit', (e) => {
        e.preventDefault();
        addEvent();
        document.body.removeChild(modal);
      });
    }

    // 添加记事
    function addEvent() {
      const date = document.getElementById('event-date').value;
      const ladiesInput = document.getElementById('event-ladies').value;
      const content = document.getElementById('event-content').value;
      const effectInput = document.getElementById('event-effect').value;
      
      // 解析相关人物
      const ladies = ladiesInput ? ladiesInput.split('、').map(name => name.trim()).filter(name => name) : [];
      
      // 解析效果
      let effect = {};
      if (effectInput) {
        try {
          effect = JSON.parse(effectInput);
        } catch (e) {
          console.error('效果JSON格式不正确:', e);
          // 如果JSON格式不正确，仍然保存记事，但不应用效果
        }
      }
      
      // 创建记事对象
      const newEvent = {
        id: Date.now().toString(),
        date: date,
        ladies: ladies,
        content: content,
        effect: effect,
        type: 'manual' // 标记为手动添加的记事
      };
      
      // 添加到游戏数据
      if (!gameData.events) {
        gameData.events = [];
      }
      gameData.events.push(newEvent);
      
      // 保存数据
      saveData();
      
      // 更新显示
      renderEvents();
      
      // 如果有关联的人物，更新她们的心境
      if (ladies.length > 0 && effect && effect.mood) {
        ladies.forEach(ladyName => {
          const lady = gameData.ladies.find(l => l.name === ladyName);
          if (lady) {
            // 如果人物没有心境数组，创建一个
            if (!lady.moods) {
              lady.moods = [];
            }
            
            // 添加心境
            lady.moods.push({
              date: date,
              mood: effect.mood,
              description: content,
              source: 'manual'
            });
            
            // 如果有目标且是当前人物，更新当前心境
            if (effect.target === ladyName) {
              lady.currentMood = effect.mood;
            }
          }
        });
        
        // 保存更新后的数据
        saveData();
      }
      
      // 显示成功消息
      showSuccessMessage('记事添加成功！');
    }

    // 显示成功消息
    function showSuccessMessage(message) {
      // 创建消息元素
      const messageEl = document.createElement('div');
      messageEl.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
      messageEl.textContent = message;
      
      document.body.appendChild(messageEl);
      
      // 3秒后自动消失
      setTimeout(() => {
        document.body.removeChild(messageEl);
      }, 3000);
    }

    // 初始化游戏
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化游戏（包含加载数据）
        init();
        
        // 初始化商品列表（在数据加载后）
        initProducts();
        
        // 初始化账单显示
        renderBills();
        
        // 添加账单按钮事件监听器
        document.getElementById('view-bills-btn').addEventListener('click', function() {
            // 隐藏宫市商品页面
            document.getElementById('palace-market-content').classList.add('hidden');
            // 显示账单页面
            document.getElementById('bills-content').classList.remove('hidden');
        });
        
        // 添加返回商品按钮事件监听器
        document.getElementById('back-to-products-btn').addEventListener('click', function() {
            // 隐藏账单页面
            document.getElementById('bills-content').classList.add('hidden');
            // 显示宫市商品页面
            document.getElementById('palace-market-content').classList.remove('hidden');
        });
        
        // 添加返回探索页面按钮事件监听器（从宫市商品页面）
        const backToExploreBtn = document.getElementById('back-to-explore');
        if (backToExploreBtn) {
            backToExploreBtn.addEventListener('click', function() {
                // 隐藏宫市商品页面
                document.getElementById('palace-market-content').classList.add('hidden');
                // 显示探索页面
                document.getElementById('about-content').classList.remove('hidden');
            });
        }
        
        // 添加恢复默认提示词按钮事件监听器
        document.getElementById('restore-default-prompt-btn').addEventListener('click', function() {
            restoreDefaultPrompt();
        });
        
        // 添加恢复默认心境提示词按钮事件监听器
        document.getElementById('restore-default-mood-prompt-btn').addEventListener('click', function() {
            restoreDefaultMoodPrompt();
        });
        
        // 添加恢复默认商品提示词按钮事件监听器
        document.getElementById('restore-default-product-prompt-btn').addEventListener('click', function() {
            restoreDefaultProductPrompt();
        });
        
        // 添加恢复默认心愿单提示词按钮事件监听器
        document.getElementById('restore-default-wishlist-prompt-btn').addEventListener('click', function() {
            restoreDefaultWishlistPrompt();
        });
        
        // 添加隐藏头像框按钮事件监听器
        const toggleAvatarFrameBtn = document.getElementById('toggle-avatar-frame-btn');
        if (toggleAvatarFrameBtn) {
            // 从本地存储获取头像框显示状态
            const isAvatarFrameHidden = localStorage.getItem('avatarFrameHidden') === 'true';
            
            // 根据保存的状态设置初始显示状态
            updateAvatarFrameVisibility(isAvatarFrameHidden);
            
            // 添加点击事件
            toggleAvatarFrameBtn.addEventListener('click', function() {
                const currentState = localStorage.getItem('avatarFrameHidden') === 'true';
                const newState = !currentState;
                
                // 更新本地存储
                localStorage.setItem('avatarFrameHidden', newState.toString());
                
                // 更新头像框显示状态
                updateAvatarFrameVisibility(newState);
            });
        }
        
        // 添加流言卡片"添加"按钮的事件委托
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('add-rumor-btn')) {
                try {
                    // 获取流言数据
                    const rumorData = JSON.parse(e.target.getAttribute('data-rumor'));
                    
                    // 优化后的记事模板
                    const noteContent = `秘闻：近日有关于${rumorData.target}的传言（${rumorData.source_hint}）：${rumorData.rumor}，此事或有隐情，需多加留意。`;
                    
                    // 使用游戏内日期格式
                    const currentYear = gameData.currentYear;
                    const currentMonth = gameData.currentMonth;
                    const formattedDate = `${currentYear}年${currentMonth}月`;
                    
                    // 创建记事对象
                    const newEvent = {
                        id: Date.now().toString(),
                        date: formattedDate,
                        ladies: [rumorData.target],
                        content: noteContent,
                        effect: {},
                        type: 'rumor' // 标记为流言添加的记事
                    };
                    
                    // 添加到游戏数据
                    if (!gameData.events) {
                        gameData.events = [];
                    }
                    gameData.events.push(newEvent);
                    
                    // 保存数据
                    saveData();
                    
                    // 更新记事显示
                    renderEvents();
                    
                    // 显示成功提示
                    showRumorAddSuccessMessage();
                } catch (error) {
                    console.error('添加流言到记事失败:', error);
                    showErrorMessage('添加失败，请重试');
                }
            }
        });
    });
    
    // 显示流言添加成功消息
    function showRumorAddSuccessMessage() {
        // 创建消息元素
        const messageEl = document.createElement('div');
        messageEl.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-primary text-white px-6 py-3 rounded-lg shadow-lg z-50';
        messageEl.textContent = '添加成功';
        
        document.body.appendChild(messageEl);
        
        // 2秒后自动消失
        setTimeout(() => {
            if (document.body.contains(messageEl)) {
                document.body.removeChild(messageEl);
            }
        }, 2000);
    }
    
    // 显示错误消息
    function showErrorMessage(message) {
        // 创建消息元素
        const messageEl = document.createElement('div');
        messageEl.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        messageEl.textContent = message;
        
        document.body.appendChild(messageEl);
        
        // 3秒后自动消失
        setTimeout(() => {
            if (document.body.contains(messageEl)) {
                document.body.removeChild(messageEl);
            }
        }, 3000);
    }
    
    // 更新头像框显示状态
    function updateAvatarFrameVisibility(isHidden) {
        const avatarFrames = document.querySelectorAll('.avatar-frame');
        avatarFrames.forEach(frame => {
            if (isHidden) {
                frame.classList.add('hidden');
            } else {
                frame.classList.remove('hidden');
            }
        });
    }
  </script>
</body>
</html>
